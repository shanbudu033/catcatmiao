<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的云养猫</title>
    <style>
        /* 可爱风格的CSS样式 */
        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* 更可爱的字体 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fdf3f8; /* 柔和的粉色背景 */
            background-image: url('https://www.transparenttextures.com/patterns/light-honeycomb.png'); /* 可爱的背景纹理 */
            color: #555; /* 柔和的文字颜色 */
            flex-direction: column;
            position: relative;
            padding: 20px; /* 增加一些内边距 */
            box-sizing: border-box; /* 盒模型调整 */
        }

        /* 实时时钟的样式 */
        #realTimeClock {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 192, 203, 0.7); /* 可爱的粉色半透明背景 */
            color: #8a2be2; /* 蓝紫色文字 */
            padding: 8px 12px;
            border-radius: 15px; /* 更圆润的边角 */
            font-size: 0.95em;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(255, 192, 203, 0.4); /* 柔和的阴影 */
        }

        .container {
            background-color: #ffffff; /* 白色容器背景 */
            border-radius: 25px; /* 更圆润的边角 */
            box-shadow: 0 15px 30px rgba(255, 192, 203, 0.3); /* 柔和的粉色阴影 */
            padding: 30px;
            text-align: center;
            max-width: 450px; /* 稍微宽一点 */
            width: 90%;
            margin-bottom: 20px;
            border: 2px solid #ffe4e1; /* 浅粉色边框 */
        }

        h1 {
            color: #ff69b4; /* 可爱的热粉色标题 */
            margin-bottom: 20px;
            font-size: 2.5em; /* 稍微大一点 */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* 标题阴影 */
        }

        /* 猫咪图片容器样式 */
        #catImageContainer {
            position: relative; /* 相对定位，用于子元素的绝对定位 */
            width: 100%;
            max-width: 300px; /* 保持与原图片相同的最大宽度 */
            height: 300px; /* 固定高度，确保叠加效果一致 */
            margin: 0 auto 25px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border: 5px solid #ffe4e1;
            overflow: hidden; /* 隐藏超出容器的部分 */
        }

        #baseCatImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* 确保图片覆盖整个容器 */
            z-index: 1; /* 基础猫咪图片在底层 */
        }

        .equipped-cosmetic {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* 确保时装图片完整显示，不被裁剪 */
            z-index: 2; /* 时装图片在猫咪图片之上 */
            pointer-events: none; /* 确保点击穿透到下层元素 */
        }


        .stats {
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.8; /* 增加行高 */
        }

        .stats p {
            margin: 8px 0; /* 增加段落间距 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px; /* 增加内边距 */
            background-color: #fff0f5; /* 柔和的粉色背景 */
            border-radius: 12px; /* 圆润的边角 */
            border: 1px solid #ffebf0; /* 浅粉色边框 */
        }

        .stats p strong { color: #777; } /* 稍深的文字颜色 */

        /* 数值过渡效果 */
        .stats p span {
            font-weight: bold;
            color: #8a2be2; /* 蓝紫色数值 */
            transition: color 0.3s ease, font-size 0.3s ease;
        }

        /* 上次查看时间样式 */
        #lastViewedTimeDisplay {
            font-size: 0.9em;
            color: #999;
            margin-top: 15px;
            background-color: transparent; /* 覆盖父级p的背景色 */
            justify-content: center; /* 居中显示 */
            padding: 0; /* 移除父级p的内边距 */
            border: none; /* 移除边框 */
            flex-direction: column; /* 让时间和时长垂直排列 */
        }
        #lastViewedTimeDisplay span {
            font-weight: normal; /* 恢复正常字体粗细 */
            color: #999; /* 恢复正常颜色 */
            margin-top: 5px;
        }


        .actions { display: flex; flex-wrap: wrap; justify-content: center; }

        .actions button {
            background-color: #87ceeb; /* 可爱的天蓝色按钮 */
            color: white;
            border: none;
            padding: 12px 20px; /* 增加内边距 */
            margin: 8px;
            border-radius: 15px; /* 更圆润的按钮边角 */
            cursor: pointer;
            font-size: 1.05em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(135, 206, 235, 0.3); /* 柔和的蓝色阴影 */
        }

        .actions button:hover:not(:disabled) { background-color: #6a5acd; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(106, 90, 205, 0.4); } /* 悬停效果 */
        .actions button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 4px 10px rgba(106, 90, 205, 0.3); }
        .actions button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; opacity: 0.7; }

        #message { margin-top: 20px; font-size: 1.1em; color: #ff69b4; min-height: 25px; font-weight: bold; } /* 可爱的粉色消息 */
        .warning { color: #ff4500 !important; font-weight: bold; } /* 橙红色警告 */
        .game-over-message { color: #dc143c; font-weight: bold; font-size: 1.3em; margin-top: 20px; } /* 深红色游戏结束消息 */

        /* 猫咪名字修改按钮 */
        #changeNameBtn {
            margin-left: 10px;
            padding: 5px 12px;
            border-radius: 10px;
            border: 1px solid #ffb6c1; /* 浅粉色边框 */
            background-color: #fff0f5; /* 柔和的粉色背景 */
            color: #ff69b4; /* 热粉色文字 */
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(255, 182, 193, 0.2);
        }
        #changeNameBtn:hover {
            background-color: #ffe4e1;
            transform: translateY(-1px);
        }

        /* 游戏结束操作按钮容器 */
        #gameOverActions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px; /* 按钮间距 */
            margin-top: 30px;
        }

        #gameOverActions button {
            padding: 15px 25px;
            font-size: 1.1em;
            border-radius: 20px; /* 更圆润 */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        #reAdoptBtn {
            background-color: #98fb98; /* 浅绿色 */
            color: #333;
        }
        #reAdoptBtn:hover:not(:disabled) {
            background-color: #66cd66;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 205, 102, 0.4);
        }

        #reviveBtn {
            background-color: #ffd700; /* 金色 */
            color: #333;
        }
        #reviveBtn:hover:not(:disabled) {
            background-color: #e6b800;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(230, 184, 0, 0.4);
        }
        #reviveBtn:disabled {
            background-color: #ccc;
            color: #666;
        }

        /* 背包按钮 */
        #backpackBtn {
            background-color: #ffc0cb; /* 粉色 */
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.05em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(255, 192, 203, 0.3);
        }
        #backpackBtn:hover:not(:disabled) {
            background-color: #ff69b4;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.4);
        }
        #backpackBtn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3);
        }

        /* 背包模态框 */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blur effect */
            -webkit-backdrop-filter: blur(5px); /* Safari compatibility */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 30px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 700px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 192, 203, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            text-align: left; /* Align content to left */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            color: #ff69b4;
            margin-top: 0;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content h3 {
            color: #8a2be2;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff69b4;
            text-decoration: none;
            cursor: pointer;
        }

        .inventory-items-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Responsive grid */
            gap: 20px;
            margin-top: 20px;
        }

        .inventory-item {
            background-color: #fff0f5;
            border: 1px solid #ffebf0;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(255, 192, 203, 0.2);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .inventory-item:hover {
            transform: translateY(-3px);
        }

        .inventory-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: #ffffff;
            padding: 5px;
            border: 1px solid #eee;
        }

        .inventory-item h4 {
            margin: 5px 0;
            color: #555;
            font-size: 1.1em;
        }

        .inventory-item p {
            margin: 0 0 10px 0;
            color: #8a2be2;
            font-weight: bold;
        }

        .inventory-item button {
            background-color: #87ceeb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            width: 100%; /* Full width button */
            margin-top: 10px;
        }
        .inventory-item button:hover {
            background-color: #6a5acd;
        }
        .inventory-item button.equipped {
            background-color: #98fb98; /* Green for equipped */
            color: #333;
        }
        .inventory-item button.equipped:hover {
            background-color: #66cd66;
        }
        .inventory-item button.unequip {
            background-color: #ffb6c1; /* Pink for unequip */
        }
        .inventory-item button.unequip:hover {
            background-color: #ff69b4;
        }

        /* No items message */
        .no-items-message {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 20px;
            grid-column: 1 / -1; /* Span across all columns */
        }


        /* 响应式调整 */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                border-radius: 15px;
            }
            h1 {
                font-size: 2em;
            }
            .actions button, #gameOverActions button {
                width: calc(50% - 16px); /* 小屏幕上按钮两列显示 */
                font-size: 1em;
                padding: 10px 15px;
            }
            #gameOverActions {
                gap: 10px;
            }
            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 20px;
            }
            .inventory-items-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            #catImageContainer {
                height: 250px; /* 小屏幕上调整高度 */
            }
        }
    </style>
</head>
<body>
    <!-- 实时时钟显示区域 -->
    <div id="realTimeClock"></div>

    <div class="container">
        <h1 id="gameTitle">我的云养猫</h1>
        <!-- 猫咪名字显示和修改区域 -->
        <div style="margin-bottom: 20px;">
            <span style="font-size: 1.5em; font-weight: bold; color: #6c757d;">名字: </span>
            <span id="catNameDisplay" style="font-size: 1.5em; font-weight: bold; color: #ff69b4;">猫咪</span>
            <button id="changeNameBtn">修改名字</button>
        </div>

        <!-- 猫咪图片容器，用于叠加时装 -->
        <div id="catImageContainer">
            <img id="baseCatImage" src="https://cdn.pixabay.com/photo/2017/11/09/21/41/cat-2934720_1280.jpg" alt="可爱的猫咪" />
            <!-- 装备的时装图片将动态添加到这里 -->
        </div>

        <div class="stats">
            <p><strong>饥饿度:</strong> <span id="hunger">50</span></p>
            <p><strong>幸福度:</strong> <span id="happiness">50</span></p>
            <p><strong>生命值:</strong> <span id="life">100</span></p>
            <p><strong>清洁度:</strong> <span id="cleanliness">100</span></p>
            <p><strong>精力:</strong> <span id="energy">100</span></p>
            <!-- 新增：金币显示区域 -->
            <p><strong>金币:</strong> <span id="gold">0</span></p>
            <!-- /新增 -->
            <p id="lastViewedTimeDisplay">
                上次查看: <span id="lastViewedExactTime">首次访问</span><br>
                <span id="timeSinceLastViewed"></span>
            </p>
        </div>

        <div class="actions">
            <button id="feedBtn">喂食</button>
            <button id="playBtn">玩耍</button>
            <button id="petBtn">抚摸</button>
            <button id="cleanBtn">清洁</button>
            <button id="restBtn">休息</button>
            <!-- 新增：商店、小游戏和背包按钮 -->
            <button id="shopBtn">商店</button>
            <button id="gameBtn">小游戏</button>
            <button id="backpackBtn">背包</button>
            <!-- /新增 -->
        </div>

        <p id="message"></p>

        <!-- 新增：游戏结束后的操作按钮 -->
        <div id="gameOverActions" style="margin-top: 20px; display: none;">
            <button id="reAdoptBtn">重新领养</button>
            <button id="reviveBtn">复活 (100金币)</button>
        </div>
        <!-- /新增 -->
    </div>

    <!-- 背包模态框 -->
    <div id="backpackModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeBackpackModal">&times;</span>
            <h2>我的背包</h2>

            <h3>物品类 (消耗品)</h3>
            <div id="consumableItemsContainer" class="inventory-items-container">
                <p class="no-items-message" id="noConsumablesMessage">背包里空空如也，快去商店逛逛吧！</p>
            </div>

            <h3>时装类 (装扮)</h3>
            <div id="cosmeticItemsContainer" class="inventory-items-container">
                <p class="no-items-message" id="noCosmeticsMessage">背包里空空如也，快去商店逛逛吧！</p>
            </div>
        </div>
    </div>

    <script>
        // --- 游戏配置常量 ---
        const GAME_STATE_KEY = 'catGameSaveState';
        const LAST_VIEWED_KEY = 'catGameLastViewed';
        const DEFAULT_CAT_NAME = '猫咪';
        // 如果你希望猫咪的基础形象是“拟人”的，请将此链接替换为一张透明背景的拟人猫咪基础图片。
        const DEFAULT_CAT_IMAGE_SRC = 'images/catbenti.png'; // 默认猫咪图片

        // 数值下降频率 (秒为单位，表示每多少秒下降1点)
        const HUNGER_DECLINE_SECONDS_NORMAL = 60 * 60 * 2; // 饥饿度每2小时下降1点
        const HAPPINESS_DECLINE_SECONDS_NORMAL = 60 * 60 * 4; // 幸福度每4小时下降1点
        const LIFE_DECLINE_SECONDS_NORMAL = 60 * 60 * 6; // 生命值每6小时下降1点

        // 特定时间段饥饿度加速下降倍数
        const HUNGER_ACCELERATED_MULTIPLIER = 5; // 加速5倍
        const MORNING_START_HOUR = 7; const MORNING_END_HOUR = 9;
        const NOON_START_HOUR = 12; const NOON_END_HOUR = 14;
        const EVENING_START_HOUR = 18; const EVENING_END_HOUR = 20;

        const DAYS_UNTIL_DEATH_NO_FOOD = 3; // 3天不喂食猫咪死亡

        // 新增：清洁与精力
        const CLEANLINESS_DECLINE_SECONDS_NORMAL = 60 * 60 * 8; // 清洁度每8小时下降1点
        const ENERGY_DECLINE_SECONDS_NORMAL = 60 * 60 * 6; // 精力每6小时下降1点
        const ENERGY_RECOVER_SECONDS_IDLE = 60 * 60 * 3; // 空闲每3小时自动+1精力

        const CLEANLINESS_LOW_THRESHOLD = 30; // 清洁低阈
        const ENERGY_LOW_THRESHOLD = 20; // 精力低阈

        // --- Item Definitions (for shop and backpack) ---
        // 请将 image 链接替换为实际的图片链接！
        // 对于时装类 (cosmetic) 物品，image 链接应为**透明背景**的**时装配件图片**，而不是带猫咪的完整图片。
        const ITEM_DEFINITIONS = {
            // Consumables (物品类)
            'small_food_can': {
                id: 'small_food_can',
                name: '小罐头',
                type: 'consumable',
                description: '增加少量饥饿度。',
                effect: { hunger: 20, happiness: 5 },
                price: 10,
                image: 'https://i.imgur.com/example_small_food.png' // 替换为实际图片
            },
            'big_food_can': {
                id: 'big_food_can',
                name: '大罐头',
                type: 'consumable',
                description: '大幅增加饥饿度。',
                effect: { hunger: 50, happiness: 10, life: 5 },
                price: 30,
                image: 'https://i.imgur.com/example_big_food.png' // 替换为实际图片
            },
            'toy_mouse': {
                id: 'toy_mouse',
                name: '玩具老鼠',
                type: 'consumable',
                description: '增加少量幸福度，消耗少量精力。',
                effect: { happiness: 30, energy: -10 },
                price: 15,
                image: 'https://i.imgur.com/example_toy_mouse.png' // 替换为实际图片
            },
            'cat_shampoo': {
                id: 'cat_shampoo',
                name: '猫咪洗发水',
                type: 'consumable',
                description: '大幅增加清洁度。',
                effect: { cleanliness: 50, happiness: 5 },
                price: 20,
                image: 'https://i.imgur.com/example_shampoo.png' // 替换为实际图片
            },
            'energy_drink': {
                id: 'energy_drink',
                name: '精力药水',
                type: 'consumable',
                description: '恢复大量精力。',
                effect: { energy: 40, hunger: -5 }, // Minor hunger cost
                price: 25,
                image: 'https://i.imgur.com/example_energy_drink.png' // 替换为实际图片
            },
            'life_potion': {
                id: 'life_potion',
                name: '生命药水',
                type: 'consumable',
                description: '恢复少量生命值。',
                effect: { life: 30 },
                price: 40,
                image: 'https://i.imgur.com/example_life_potion.png' // 替换为实际图片
            },
            'super_food': {
                id: 'super_food',
                name: '超级猫粮',
                type: 'consumable',
                description: '全面提升猫咪状态！',
                effect: { hunger: 40, happiness: 20, life: 10, cleanliness: 20, energy: 20 },
                price: 80,
                image: 'https://i.imgur.com/example_super_food.png' // 替换为实际图片
            },
            'health_kit': {
                id: 'health_kit',
                name: '急救包',
                type: 'consumable',
                description: '快速恢复大量生命值。',
                effect: { life: 50, happiness: 10 },
                price: 60,
                image: 'https://i.imgur.com/example_health_kit.png' // 替换为实际图片
            },
            'happy_ball': {
                id: 'happy_ball',
                name: '快乐球',
                type: 'consumable',
                description: '让猫咪瞬间开心起来！',
                effect: { happiness: 50, energy: -15 },
                price: 35,
                image: 'https://i.imgur.com/example_happy_ball.png' // 替换为实际图片
            },
            // 新增猫咪玩具
            'teasing_stick': {
                id: 'teasing_stick',
                name: '逗猫棒',
                type: 'consumable',
                description: '和猫咪玩耍，增加幸福感，消耗少量精力。',
                effect: { happiness: 25, energy: -10 },
                price: 12,
                image: 'https://i.imgur.com/example_teasing_stick.png' // 替换为实际图片
            },
            'catnip': {
                id: 'catnip',
                name: '猫薄荷',
                type: 'consumable',
                description: '让猫咪兴奋不已，大幅增加幸福感，略微消耗精力。',
                effect: { happiness: 40, energy: -15, life: 5 },
                price: 20,
                image: 'https://i.imgur.com/example_catnip.png' // 替换为实际图片
            },
            'electric_mouse': {
                id: 'electric_mouse',
                name: '电动老鼠',
                type: 'consumable',
                description: '猫咪最爱的追逐游戏，增加幸福感，消耗精力。',
                effect: { happiness: 35, energy: -20 },
                price: 28,
                image: 'https://i.imgur.com/example_electric_mouse.png' // 替换为实际图片
            },

            // Cosmetics (时装类) - **请确保这些图片是透明背景的配件图片！**
            'straw_hat': {
                id: 'straw_hat',
                name: '草帽',
                type: 'cosmetic',
                description: '给猫咪戴上可爱的草帽。',
                price: 50,
                image: 'https://i.imgur.com/example_straw_hat.png' // 替换为实际透明PNG
            },
            'glasses': {
                id: 'glasses',
                name: '眼镜',
                type: 'cosmetic',
                description: '让猫咪看起来更聪明。',
                price: 70,
                image: 'https://i.imgur.com/example_glasses.png' // 替换为实际透明PNG
            },
            'scarf': {
                id: 'scarf',
                name: '小围巾',
                type: 'cosmetic',
                description: '给猫咪保暖。',
                price: 60,
                image: 'https://i.imgur.com/example_scarf.png' // 替换为实际透明PNG
            },
            'crown': {
                id: 'crown',
                name: '小皇冠',
                type: 'cosmetic',
                description: '让猫咪成为小王子/公主。',
                price: 120,
                image: 'https://i.imgur.com/example_crown.png' // 替换为实际透明PNG
            },
            'bow_tie': {
                id: 'bow_tie',
                name: '蝴蝶结',
                type: 'cosmetic',
                description: '优雅的猫咪配饰。',
                price: 40,
                image: 'https://i.imgur.com/example_bow_tie.png' // 替换为实际透明PNG
            },
            'cape': {
                id: 'cape',
                name: '小披风',
                type: 'cosmetic',
                description: '让猫咪拥有英雄气概。',
                price: 100,
                image: 'https://i.imgur.com/example_cape.png' // 替换为实际透明PNG
            },
            'party_hat': {
                id: 'party_hat',
                name: '派对帽',
                type: 'cosmetic',
                description: '为猫咪的生日派对准备！',
                price: 80,
                image: 'https://i.imgur.com/example_party_hat.png' // 替换为实际透明PNG
            },
            'flower_collar': {
                id: 'flower_collar',
                name: '花朵项圈',
                type: 'cosmetic',
                description: '让猫咪更具田园风情。',
                price: 55,
                image: 'https://i.imgur.com/example_flower_collar.png' // 替换为实际透明PNG
            },
            // 新增拟人猫猫服装
            'maid_outfit': {
                id: 'maid_outfit',
                name: '女仆装',
                type: 'cosmetic',
                description: '可爱的女仆装，让猫咪为你服务！',
                price: 150,
                image: 'https://i.imgur.com/example_maid_outfit.png' // 替换为实际透明PNG (女仆装配件)
            },
            'butler_outfit': {
                id: 'butler_outfit',
                name: '男仆装',
                type: 'cosmetic',
                description: '帅气的男仆装，尽显绅士风范。',
                price: 150,
                image: 'https://i.imgur.com/example_butler_outfit.png' // 替换为实际透明PNG (男仆装配件)
            },
            'jeans': {
                id: 'jeans',
                name: '牛仔裤',
                type: 'cosmetic',
                description: '时尚百搭的牛仔裤，休闲又帅气。',
                price: 90,
                image: 'https://i.imgur.com/example_jeans.png' // 替换为实际透明PNG (牛仔裤配件)
            },
            'dress': {
                id: 'dress',
                name: '小礼裙',
                type: 'cosmetic',
                description: '优雅的小礼裙，适合参加派对。',
                price: 130,
                image: 'https://i.imgur.com/example_dress.png' // 替换为实际透明PNG (小礼裙配件)
            },
            'suit': {
                id: 'suit',
                name: '小西装',
                type: 'cosmetic',
                description: '正式的小西装，出席重要场合。',
                price: 140,
                image: 'https://i.imgur.com/example_suit.png' // 替换为实际透明PNG (小西装配件)
            }
        };

        // --- 辅助函数 ---
        function toDateSafe(v) {
            // 把可能是 Date / ISO 字符串 / null 转为有效 Date（无效返回当前时间）
            if (v instanceof Date) return v;
            try {
                const d = new Date(v);
                if (isNaN(d.getTime())) return new Date();
                return d;
            } catch (e) {
                return new Date();
            }
        }

        // --- 猫咪状态 (默认值) ---
        let cat = {
            hunger: 50,
            happiness: 50,
            life: 100,
            isAlive: true,
            isRunAway: false,
            // 运行时使用 Date 对象，序列化时会转为 ISO
            lastUpdateTime: new Date(),
            lastFedTime: new Date(),
            cleanliness: 100,
            energy: 100,
            name: DEFAULT_CAT_NAME,
            lastPlayedAt: null, // 用于空闲恢复判定
            // 新增：金币属性
            gold: 0, // 初始金币数量
            // 新增：连续操作计数器，用于惩罚机制
            consecutiveFullFeeds: 0, // 饱腹状态下连续喂食次数
            consecutiveFullCleans: 0, // 清洁值满状态下连续清洁次数
            consecutiveFullRests: 0,  // 精力值满状态下连续休息次数
            consecutiveFullPlays: 0,  // 幸福值满状态下连续玩耍次数
            // 新增：背包和已装备时装
            inventory: [], // Array of { id: 'item_id', quantity: N }
            equippedCosmeticId: null, // Stores the ID of the currently equipped cosmetic item
        };

        // --- 获取DOM元素 ---
        const hungerSpan = document.getElementById('hunger');
        const happinessSpan = document.getElementById('happiness');
        const lifeSpan = document.getElementById('life');
        const cleanlinessSpan = document.getElementById('cleanliness');
        const energySpan = document.getElementById('energy');
        const messageP = document.getElementById('message');
        const catNameDisplay = document.getElementById('catNameDisplay');
        const changeNameBtn = document.getElementById('changeNameBtn');
        const gameTitle = document.getElementById('gameTitle');
        const feedBtn = document.getElementById('feedBtn');
        const playBtn = document.getElementById('playBtn');
        const petBtn = document.getElementById('petBtn');
        const cleanBtn = document.getElementById('cleanBtn');
        const restBtn = document.getElementById('restBtn');
        const realTimeClockDiv = document.getElementById('realTimeClock');
        const lastViewedExactTimeSpan = document.getElementById('lastViewedExactTime');
        const timeSinceLastViewedSpan = document.getElementById('timeSinceLastViewed');
        // 修改：获取猫咪图片容器和基础图片元素
        const catImageContainerElement = document.getElementById('catImageContainer');
        const baseCatImageElement = document.getElementById('baseCatImage');
        // 新增：获取金币显示元素和商店/游戏/背包按钮
        const goldSpan = document.getElementById('gold');
        const shopBtn = document.getElementById('shopBtn');
        const gameBtn = document.getElementById('gameBtn');
        const backpackBtn = document.getElementById('backpackBtn');
        // 新增：获取游戏结束操作区域和按钮
        const gameOverActionsDiv = document.getElementById('gameOverActions');
        const reAdoptBtn = document.getElementById('reAdoptBtn');
        const reviveBtn = document.getElementById('reviveBtn');
        // 新增：背包模态框元素
        const backpackModal = document.getElementById('backpackModal');
        const closeBackpackModal = document.getElementById('closeBackpackModal');
        const consumableItemsContainer = document.getElementById('consumableItemsContainer');
        const cosmeticItemsContainer = document.getElementById('cosmeticItemsContainer');
        const noConsumablesMessage = document.getElementById('noConsumablesMessage');
        const noCosmeticsMessage = document.getElementById('noCosmeticsMessage');

        // 用于管理普通消息的 setTimeout ID
        let currentMessageTimeout = null;

        // --- 持久化和加载游戏状态 ---
        function saveGameState() {
            // 确保以 ISO 字符串保存时间字段
            const copy = {
                ...cat,
                lastUpdateTime: (cat.lastUpdateTime instanceof Date) ? cat.lastUpdateTime.toISOString() : new Date(cat.lastUpdateTime).toISOString(),
                lastFedTime: (cat.lastFedTime instanceof Date) ? cat.lastFedTime.toISOString() : new Date(cat.lastFedTime).toISOString(),
                lastPlayedAt: (cat.lastPlayedAt instanceof Date) ? cat.lastPlayedAt.toISOString() : cat.lastPlayedAt // It might be null or string already
            };
            localStorage.setItem(GAME_STATE_KEY, JSON.stringify(copy));
            // console.log('保存存档', copy);
        }

        function loadGameState() {
            const saved = localStorage.getItem(GAME_STATE_KEY);
            if (!saved) {
                // 首次运行，初始化所有默认值
                cat.lastUpdateTime = new Date();
                cat.lastFedTime = new Date();
                cat.name = DEFAULT_CAT_NAME;
                cat.gold = 0;
                cat.consecutiveFullFeeds = 0;
                cat.consecutiveFullCleans = 0;
                cat.consecutiveFullRests = 0;
                cat.consecutiveFullPlays = 0;
                cat.inventory = []; // 初始化背包
                cat.equippedCosmeticId = null; // 初始化已装备时装
                return;
            }

            try {
                const loaded = JSON.parse(saved);
                cat = { ...cat, ...loaded };
                // 将时间字段转为 Date 对象（健壮转换）
                cat.lastUpdateTime = toDateSafe(cat.lastUpdateTime);
                cat.lastFedTime = toDateSafe(cat.lastFedTime);
                if (cat.lastPlayedAt) cat.lastPlayedAt = toDateSafe(cat.lastPlayedAt); // Convert if exists

                if (!cat.name) cat.name = DEFAULT_CAT_NAME;
                if (typeof cat.gold === 'undefined') cat.gold = 0;
                if (typeof cat.consecutiveFullFeeds === 'undefined') cat.consecutiveFullFeeds = 0;
                if (typeof cat.consecutiveFullCleans === 'undefined') cat.consecutiveFullCleans = 0;
                if (typeof cat.consecutiveFullRests === 'undefined') cat.consecutiveFullRests = 0;
                if (typeof cat.consecutiveFullPlays === 'undefined') cat.consecutiveFullPlays = 0;
                // 新增：如果旧存档没有 inventory 或 equippedCosmeticId 属性，则初始化
                if (typeof cat.inventory === 'undefined') cat.inventory = [];
                if (typeof cat.equippedCosmeticId === 'undefined') cat.equippedCosmeticId = null;

            } catch (e) {
                console.error('读取存档失败，初始化新游戏', e);
                // 读取失败时，重置所有状态为默认值
                cat = {
                    hunger: 50, happiness: 50, life: 100, isAlive: true, isRunAway: false,
                    lastUpdateTime: new Date(), lastFedTime: new Date(),
                    cleanliness: 100, energy: 100, name: DEFAULT_CAT_NAME,
                    lastPlayedAt: null, gold: 0,
                    consecutiveFullFeeds: 0, consecutiveFullCleans: 0,
                    consecutiveFullRests: 0, consecutiveFullPlays: 0,
                    inventory: [],
                    equippedCosmeticId: null
                };
            }
        }

        // --- 离线状态衰减计算 ---
        function applyOfflineDecay() {
            const now = new Date();
            const lastUpdate = toDateSafe(cat.lastUpdateTime);
            const elapsedMs = now.getTime() - lastUpdate.getTime();
            const elapsedSec = Math.floor(elapsedMs / 1000);
            if (elapsedSec <= 0 || (!cat.isAlive && !cat.isRunAway)) return;

            // 饥饿度
            let hungerDecay = Math.floor(elapsedSec / HUNGER_DECLINE_SECONDS_NORMAL);
            // 简化时间段加速的粗略估算
            const hoursElapsed = elapsedMs / 3600000;
            const accelHoursWindow = (MORNING_END_HOUR - MORNING_START_HOUR) + (NOON_END_HOUR - NOON_START_HOUR) + (EVENING_END_HOUR - EVENING_START_HOUR);
            const acceleratedHours = Math.min(hoursElapsed, accelHoursWindow);
            hungerDecay += Math.floor((acceleratedHours * HUNGER_ACCELERATED_MULTIPLIER) / (HUNGER_DECLINE_SECONDS_NORMAL / 3600));
            cat.hunger = Math.max(0, cat.hunger - hungerDecay);

            // 幸福度（受多因素影响）
            let happinessFactors = 0;
            if (cat.hunger < 50) happinessFactors++;
            if (cat.life < 50) happinessFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) happinessFactors++;
            if (cat.energy < ENERGY_LOW_THRESHOLD) happinessFactors++;
            if (happinessFactors > 0) {
                const happinessDecay = Math.floor(elapsedSec / (HAPPINESS_DECLINE_SECONDS_NORMAL / (1 + happinessFactors * 0.5)));
                cat.happiness = Math.max(0, cat.happiness - happinessDecay);
            }

            // 生命值（受多因素影响）
            let lifeFactors = 0;
            if (cat.hunger < 50) lifeFactors++;
            if (cat.happiness < 50) lifeFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) lifeFactors++;
            if (lifeFactors > 0) {
                const lifeDecay = Math.floor(elapsedSec / (LIFE_DECLINE_SECONDS_NORMAL / (1 + lifeFactors * 0.5)));
                cat.life = Math.max(0, cat.life - lifeDecay);
            }

            // 清洁与精力
            const cleanlinessDecay = Math.floor(elapsedSec / CLEANLINESS_DECLINE_SECONDS_NORMAL);
            cat.cleanliness = Math.max(0, cat.cleanliness - cleanlinessDecay);
            const energyDecay = Math.floor(elapsedSec / ENERGY_DECLINE_SECONDS_NORMAL);
            cat.energy = Math.max(0, cat.energy - energyDecay);

            // 空闲精力恢复（离线也生效，保守处理）
            const energyRecover = Math.floor(elapsedSec / ENERGY_RECOVER_SECONDS_IDLE);
            cat.energy = Math.min(100, cat.energy + energyRecover);

            // 更新最后更新时间
            cat.lastUpdateTime = now;

            checkGameEndConditions(true);
            saveGameState();
        }

        // --- 更新显示 ---
        function updateCatStatsDisplay() {
            catNameDisplay.textContent = cat.name;
            if (gameTitle) gameTitle.textContent = `我的云养${cat.name}`;

            hungerSpan.textContent = cat.hunger;
            happinessSpan.textContent = cat.happiness;
            lifeSpan.textContent = cat.life;
            cleanlinessSpan.textContent = cat.cleanliness;
            energySpan.textContent = cat.energy;
            // 新增：更新金币显示
            goldSpan.textContent = cat.gold;

            const warnings = [];
            if (cat.hunger < 20) { hungerSpan.classList.add('warning'); warnings.push('猫咪很饿了，快喂它！'); } else hungerSpan.classList.remove('warning');
            if (cat.happiness < 20) { happinessSpan.classList.add('warning'); warnings.push('猫咪不开心了，快陪它玩！'); } else happinessSpan.classList.remove('warning');
            if (cat.life < 30) { lifeSpan.classList.add('warning'); warnings.push('猫咪生命值很低，需要你的关爱！'); } else lifeSpan.classList.remove('warning');
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) { cleanlinessSpan.classList.add('warning'); warnings.push('猫咪有点脏了，快给它清洁！'); } else cleanlinessSpan.classList.remove('warning');
            if (cat.energy < ENERGY_LOW_THRESHOLD) { energySpan.classList.add('warning'); warnings.push('猫咪精力不足，需要休息！'); } else energySpan.classList.remove('warning');

            if (warnings.length > 0) {
                displayMessage(warnings.join(' '), 'warning');
            } else if (messageP.classList.contains('warning') && currentMessageTimeout === null) {
                messageP.textContent = '';
                messageP.className = '';
            }
        }

        // --- 消息 ---
        function displayMessage(msg, type = 'info') {
            if (type === 'info' && currentMessageTimeout) {
                clearTimeout(currentMessageTimeout);
                currentMessageTimeout = null;
            }
            messageP.textContent = msg;
            messageP.className = '';
            if (type === 'warning') {
                messageP.classList.add('warning');
            } else if (type === 'game-over') {
                messageP.classList.add('game-over-message');
            } else {
                messageP.style.color = '#ff69b4'; // 默认消息颜色
                currentMessageTimeout = setTimeout(() => {
                    if (messageP.textContent === msg && !messageP.classList.contains('warning') && !messageP.classList.contains('game-over-message')) {
                        messageP.textContent = '';
                        messageP.className = '';
                    }
                    currentMessageTimeout = null;
                }, 3000);
            }
        }

        // --- 结束条件 ---
        function checkGameEndConditions(isOfflineCheck = false) {
            if (!cat.isAlive || cat.isRunAway) return;
            const now = new Date();

            if (cat.life <= 0) {
                cat.life = 0; cat.isAlive = false;
                displayMessage(`${cat.name} 因生命值耗尽而死亡了...`, 'game-over');
                endGame(); return;
            }

            const lastFed = toDateSafe(cat.lastFedTime);
            const daysSinceLastFed = (now.getTime() - lastFed.getTime()) / (1000 * 60 * 60 * 24);
            if (daysSinceLastFed >= DAYS_UNTIL_DEATH_NO_FOOD) {
                cat.isAlive = false;
                displayMessage(`你已经${Math.floor(daysSinceLastFed)}天没有喂食${cat.name}了，它饿死了...`, 'game-over');
                endGame(); return;
            }

            if (cat.happiness <= 0) {
                cat.happiness = 0; cat.isRunAway = true;
                displayMessage(`${cat.name} 因不开心而离家出走了...`, 'game-over');
                endGame(); return;
            }
        }

        function endGame() {
            feedBtn.disabled = true;
            playBtn.disabled = true;
            petBtn.disabled = true;
            cleanBtn.disabled = true;
            restBtn.disabled = true;
            changeNameBtn.disabled = true;
            shopBtn.disabled = true; // 禁用商店按钮
            gameBtn.disabled = true; // 禁用小游戏按钮
            backpackBtn.disabled = true; // 禁用背包按钮

            if (gameLoopInterval) { clearInterval(gameLoopInterval); gameLoopInterval = null; }
            updateCatStatsDisplay();
            if (!cat.isAlive) displayMessage(`${cat.name} 已经死亡了...`, 'game-over');
            else if (cat.isRunAway) displayMessage(`${cat.name} 已经离家出走了...`, 'game-over');

            // 显示游戏结束操作按钮
            gameOverActionsDiv.style.display = 'flex'; // 显示按钮容器
            // 如果金币不足，禁用复活按钮
            const REVIVE_COST = 100;
            if (cat.gold < REVIVE_COST) {
                reviveBtn.disabled = true;
                reviveBtn.textContent = `复活 (金币不足)`;
            } else {
                reviveBtn.disabled = false;
                reviveBtn.textContent = `复活 (${REVIVE_COST}金币)`;
            }
            saveGameState();
        }

        // 新增：重置其他连续操作计数器
        function resetConsecutiveCounters(currentAction) {
            // 如果当前动作不是喂食，则重置喂食计数器
            if (currentAction !== 'feed') cat.consecutiveFullFeeds = 0;
            // 如果当前动作不是清洁，则重置清洁计数器
            if (currentAction !== 'clean') cat.consecutiveFullCleans = 0;
            // 如果当前动作不是休息，则重置休息计数器
            if (currentAction !== 'rest') cat.consecutiveFullRests = 0;
            // 如果当前动作不是玩耍，则重置玩耍计数器
            if (currentAction !== 'play') cat.consecutiveFullPlays = 0;
            // 注意：抚摸和改名等动作也会重置所有计数器，因为它们不属于上述四种“过度”操作
        }

        // --- 玩家动作 ---
        function feedCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('feed'); // 重置其他计数器

            if (cat.hunger >= 100) {
                cat.consecutiveFullFeeds++; // 饱腹状态下连续喂食次数增加
                if (cat.consecutiveFullFeeds >= 5) {
                    cat.isAlive = false;
                    cat.life = 0;
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} 已经撑死了！你连续喂食了它${cat.consecutiveFullFeeds}次，它无法承受了...`, 'game-over');
                    endGame();
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} 已经很饱了，不需要再喂了！你已经连续喂食了它${cat.consecutiveFullFeeds}次。`, 'warning');
                    saveGameState(); // 即使没有实际喂食，也保存计数器
                    return;
                }
            }

            // 正常喂食逻辑
            cat.hunger = Math.min(100, cat.hunger + 30);
            cat.happiness = Math.min(100, cat.happiness + 10);
            cat.life = Math.min(100, cat.life + 5);
            cat.lastFedTime = new Date();
            cat.gold += 5; // 每次喂食获得5金币
            cat.consecutiveFullFeeds = 0; // 正常喂食后重置计数器
            updateCatStatsDisplay();
            displayMessage(`你喂了${cat.name}，它看起来很满足！获得了5金币！`); // 更新消息
            saveGameState();
        }

        function playCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('play'); // 重置其他计数器

            if (cat.happiness >= 100) {
                cat.consecutiveFullPlays++; // 幸福值满状态下连续玩耍次数增加
                if (cat.consecutiveFullPlays >= 10) {
                    cat.happiness = Math.max(0, cat.happiness - 20); // 幸福值减少
                    cat.energy = Math.max(0, cat.energy - 30);     // 精力值减少
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} 玩得太累了，它感到厌烦和疲惫！幸福值和精力值大幅下降！`, 'warning');
                    checkGameEndConditions(); // 检查是否因惩罚导致游戏结束
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} 已经玩得很开心了！再玩下去它会累的。你已经连续玩耍了${cat.consecutiveFullPlays}次。`, 'warning');
                    saveGameState();
                    return;
                }
            }
            if (cat.energy <= 0) { displayMessage(`${cat.name} 太累了，没有精力玩耍！`); saveGameState(); return; }

            // 正常玩耍逻辑
            cat.happiness = Math.min(100, cat.happiness + 35);
            cat.hunger = Math.max(0, cat.hunger - 15);
            cat.life = Math.min(100, cat.life + 3);
            cat.energy = Math.max(0, cat.energy - 25);
            cat.lastPlayedAt = new Date().toISOString();
            cat.gold += 10; // 每次玩耍获得10金币
            cat.consecutiveFullPlays = 0; // 正常玩耍后重置计数器
            updateCatStatsDisplay();
            displayMessage(`你和${cat.name}玩耍了一会儿，它很开心！获得了10金币！`); // 更新消息
            saveGameState();
        }

        function petCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('pet'); // 重置所有计数器

            if (cat.happiness >= 90) { displayMessage(`${cat.name} 已经很享受了！`); saveGameState(); return; }
            cat.happiness = Math.min(100, cat.happiness + 20);
            cat.gold += 3; // 每次抚摸获得3金币
            updateCatStatsDisplay();
            displayMessage(`你轻轻抚摸了${cat.name}，它发出了咕噜声。获得了3金币！`); // 更新消息
            saveGameState();
        }

        function cleanCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('clean'); // 重置其他计数器

            if (cat.cleanliness >= 100) {
                cat.consecutiveFullCleans++; // 清洁值满状态下连续清洁次数增加
                if (cat.consecutiveFullCleans >= 3) {
                    cat.life = Math.max(0, cat.life - 10);     // 生命值减少
                    cat.happiness = Math.max(0, cat.happiness - 5); // 幸福值减少
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} 感冒了！你连续清洁了它${cat.consecutiveFullCleans}次，它着凉了！生命值和幸福值下降！`, 'warning');
                    checkGameEndConditions(); // 检查是否因惩罚导致游戏结束
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} 已经很干净了，不需要清洁！你已经连续清洁了它${cat.consecutiveFullCleans}次。`, 'warning');
                    saveGameState();
                    return;
                }
            }

            // 正常清洁逻辑
            cat.cleanliness = Math.min(100, cat.cleanliness + 40);
            cat.happiness = Math.min(100, cat.happiness + 5);
            cat.gold += 8; // 每次清洁获得8金币
            cat.consecutiveFullCleans = 0; // 正常清洁后重置计数器
            updateCatStatsDisplay();
            displayMessage(`你给${cat.name}清洁了身体，它变得更干净了！获得了8金币！`); // 更新消息
            saveGameState();
        }

        // 新增：休息（手动恢复精力）
        function restCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('rest'); // 重置其他计数器

            if (cat.energy >= 100) {
                cat.consecutiveFullRests++; // 精力值满状态下连续休息次数增加
                if (cat.consecutiveFullRests >= 5) {
                    cat.life = Math.max(0, cat.life - 15);     // 生命值减少
                    cat.happiness = Math.max(0, cat.happiness - 10); // 幸福值减少
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} 睡得头晕眼花！你连续让它休息了${cat.consecutiveFullRests}次，它感到不适！生命值和幸福值下降！`, 'warning');
                    checkGameEndConditions(); // 检查是否因惩罚导致游戏结束
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} 精力已经满满的！再休息下去会头晕的。你已经连续休息了${cat.consecutiveFullRests}次。`, 'warning');
                    saveGameState();
                    return;
                }
            }

            // 正常休息逻辑
            cat.energy = Math.min(100, cat.energy + 30);
            // 休息略微降低饥饿，避免无限堆叠
            cat.hunger = Math.max(0, cat.hunger - 5);
            cat.happiness = Math.min(100, cat.happiness + 5);
            cat.gold += 5; // 每次休息获得5金币
            cat.consecutiveFullRests = 0; // 正常休息后重置计数器
            updateCatStatsDisplay();
            displayMessage(`${cat.name} 休息了一会儿，精神好多了～获得了5金币！`); // 更新消息
            saveGameState();
        }

        // 新增：重新领养猫咪
        function reAdoptCat() {
            if (!confirm('确定要重新领养一只新猫咪吗？所有数据（包括金币和背包）都将清零！')) {
                return;
            }

            // 重置所有猫咪状态为初始值
            cat = {
                hunger: 50,
                happiness: 50,
                life: 100,
                isAlive: true,
                isRunAway: false,
                lastUpdateTime: new Date(),
                lastFedTime: new Date(),
                cleanliness: 100,
                energy: 100,
                name: DEFAULT_CAT_NAME,
                gold: 0, // 金币也清零
                consecutiveFullFeeds: 0,
                consecutiveFullCleans: 0,
                consecutiveFullRests: 0,
                consecutiveFullPlays: 0,
                inventory: [], // 背包清空
                equippedCosmeticId: null, // 已装备时装清空
            };

            localStorage.removeItem(GAME_STATE_KEY); // 清除旧存档
            localStorage.removeItem(LAST_VIEWED_KEY); // 清除上次查看时间
            
            // 重新初始化游戏
            initializeGame();
            displayMessage(`你领养了一只新的${cat.name}！`);
        }

        // 新增：复活猫咪
        function reviveCat() {
            const REVIVE_COST = 100;
            if (cat.gold < REVIVE_COST) {
                displayMessage(`金币不足，无法复活${cat.name}！需要${REVIVE_COST}金币。`, 'warning');
                return;
            }
            if (!confirm(`确定要花费${REVIVE_COST}金币复活${cat.name}吗？`)) {
                return;
            }

            cat.gold -= REVIVE_COST; // 扣除金币
            cat.life = 100;          // 生命值加满
            cat.isAlive = true;      // 标记为存活
            cat.isRunAway = false;   // 标记为未离家出走
            cat.lastUpdateTime = new Date(); // 更新时间，避免离线衰减立即生效
            cat.lastFedTime = new Date();    // 重置喂食时间，避免立即饿死

            // 重置连续操作计数器，避免复活后立即触发惩罚
            cat.consecutiveFullFeeds = 0;
            cat.consecutiveFullCleans = 0;
            cat.consecutiveFullRests = 0;
            cat.consecutiveFullPlays = 0;

            // 重新初始化游戏（会重新启用按钮，隐藏游戏结束操作）
            initializeGame();
            displayMessage(`你花费了${REVIVE_COST}金币复活了${cat.name}！它又活蹦乱跳了！`);
        }

        // --- 自动下降状态（模拟时间流逝）---
        let hungerDeclineTick = 0;
        let happinessDeclineTick = 0;
        let lifeDeclineTick = 0;
        let cleanlinessDeclineTick = 0;
        let energyDeclineTick = 0;
        let energyRecoverTick = 0;

        function autoDeclineStats() {
            if (!cat.isAlive || cat.isRunAway) return; // 游戏结束则停止下降
            const now = new Date();
            const currentHour = now.getHours();

            // 饥饿度下降
            hungerDeclineTick++;
            let hungerRate = HUNGER_DECLINE_SECONDS_NORMAL;
            if ((currentHour >= MORNING_START_HOUR && currentHour < MORNING_END_HOUR) ||
                (currentHour >= NOON_START_HOUR && currentHour < NOON_END_HOUR) ||
                (currentHour >= EVENING_START_HOUR && currentHour < EVENING_END_HOUR)) {
                hungerRate /= HUNGER_ACCELERATED_MULTIPLIER;
            }
            if (hungerDeclineTick >= hungerRate) { cat.hunger = Math.max(0, cat.hunger - 1); hungerDeclineTick = 0; }

            // 清洁度下降
            cleanlinessDeclineTick++;
            if (cleanlinessDeclineTick >= CLEANLINESS_DECLINE_SECONDS_NORMAL) { cat.cleanliness = Math.max(0, cat.cleanliness - 1); cleanlinessDeclineTick = 0; }

            // 精力下降（被动）
            energyDeclineTick++;
            if (energyDeclineTick >= ENERGY_DECLINE_SECONDS_NORMAL) { cat.energy = Math.max(0, cat.energy - 1); energyDeclineTick = 0; }

            // 空闲自动精力恢复（不在玩耍的瞬时，不顶格）
            energyRecoverTick++;
            if (cat.energy < 100 && energyRecoverTick >= ENERGY_RECOVER_SECONDS_IDLE) {
                cat.energy = Math.min(100, cat.energy + 1);
                energyRecoverTick = 0;
            }

            // 幸福度下降（受多因素影响）
            let happinessFactors = 0;
            if (cat.hunger < 50) happinessFactors++;
            if (cat.life < 50) happinessFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) happinessFactors++;
            if (cat.energy < ENERGY_LOW_THRESHOLD) happinessFactors++;
            if (happinessFactors > 0) {
                happinessDeclineTick++;
                const happinessRate = HAPPINESS_DECLINE_SECONDS_NORMAL / (1 + happinessFactors * 0.5);
                if (happinessDeclineTick >= happinessRate) { cat.happiness = Math.max(0, cat.happiness - 1); happinessDeclineTick = 0; }
            } else {
                happinessDeclineTick = 0;
            }

            // 生命值下降（受多因素影响）
            let lifeFactors = 0;
            if (cat.hunger < 50) lifeFactors++;
            if (cat.happiness < 50) lifeFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) lifeFactors++;
            if (lifeFactors > 0) {
                lifeDeclineTick++;
                const lifeRate = LIFE_DECLINE_SECONDS_NORMAL / (1 + lifeFactors * 0.5);
                if (lifeDeclineTick >= lifeRate) { cat.life = Math.max(0, cat.life - 1); lifeDeclineTick = 0; }
            } else {
                lifeDeclineTick = 0;
            }

            updateCatStatsDisplay();
            checkGameEndConditions();
        }

        // --- 实时时钟 ---
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            realTimeClockDiv.textContent = `${h}:${m}:${s}`;
        }

        // --- 上次查看时间 ---
        function saveCurrentTimeAsLastViewed() {
            const now = new Date();
            localStorage.setItem(LAST_VIEWED_KEY, now.toISOString());
        }

        function loadAndDisplayLastViewedTime() {
            const t = localStorage.getItem(LAST_VIEWED_KEY);
            if (t) {
                const d = new Date(t);
                lastViewedExactTimeSpan.textContent = d.toLocaleString();

                const now = new Date();
                const elapsedMs = now.getTime() - d.getTime();
                const elapsedSeconds = Math.floor(elapsedMs / 1000);

                let durationText = '';
                if (elapsedSeconds < 60) {
                    durationText = `${elapsedSeconds}秒前`;
                } else if (elapsedSeconds < 3600) {
                    const minutes = Math.floor(elapsedSeconds / 60);
                    durationText = `${minutes}分钟前`;
                } else if (elapsedSeconds < 86400) {
                    const hours = Math.floor(elapsedSeconds / 3600);
                    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
                    durationText = `${hours}小时${minutes}分钟前`;
                } else {
                    const days = Math.floor(elapsedSeconds / 86400);
                    const hours = Math.floor((elapsedSeconds % 86400) / 3600);
                    durationText = `${days}天${hours}小时前`;
                }
                timeSinceLastViewedSpan.textContent = `(${durationText})`;
            } else {
                lastViewedExactTimeSpan.textContent = '首次访问';
                timeSinceLastViewedSpan.textContent = '';
            }
        }

        // --- 统一的游戏循环 ---
        let gameLoopInterval = null;
        function gameLoop() {
            autoDeclineStats();
            updateClock();
            // 移除 loadAndDisplayLastViewedTime()，使其只在页面加载时计算一次
            if (new Date().getSeconds() === 0) saveGameState(); // 每分钟保存一次
        }

        // --- 修改名字 ---
        function changeCatName() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('changeName'); // 重置所有计数器

            let newName = prompt(`请输入${cat.name}的新名字 (当前名字: ${cat.name})：`);
            if (newName === null) return;
            newName = newName.trim();
            if (newName === '') { displayMessage('名字不能为空！'); return; }
            if (newName.length > 10) { displayMessage('名字太长了，请限制在10个字符以内。'); return; }
            cat.name = newName;
            updateCatStatsDisplay();
            displayMessage(`你的猫咪现在叫 ${cat.name} 了！`);
            saveGameState();
        }

        // --- 背包功能 ---

        // 更新猫咪图片（根据是否装备时装）
        function updateCatImage() {
            // 1. 设置基础猫咪图片
            baseCatImageElement.src = DEFAULT_CAT_IMAGE_SRC;

            // 2. 清除所有旧的时装图片
            // 遍历 catImageContainerElement 的所有子元素，移除除了 baseCatImageElement 之外的
            Array.from(catImageContainerElement.children).forEach(child => {
                if (child !== baseCatImageElement) {
                    catImageContainerElement.removeChild(child);
                }
            });

            // 3. 如果有装备的时装，则添加新的时装图片
            if (cat.equippedCosmeticId && ITEM_DEFINITIONS[cat.equippedCosmeticId]) {
                const cosmeticDef = ITEM_DEFINITIONS[cat.equippedCosmeticId];
                const cosmeticImage = document.createElement('img');
                cosmeticImage.src = cosmeticDef.image;
                cosmeticImage.alt = cosmeticDef.name;
                cosmeticImage.className = 'equipped-cosmetic'; // 应用时装样式
                catImageContainerElement.appendChild(cosmeticImage);
            }
        }

        // 添加物品到背包 (供商店或测试使用)
        function addItemToInventory(itemId, quantity = 1) {
            const itemDef = ITEM_DEFINITIONS[itemId];
            if (!itemDef) {
                console.warn(`Item ID ${itemId} not found in ITEM_DEFINITIONS.`);
                return;
            }

            const existingItemIndex = cat.inventory.findIndex(item => item.id === itemId);

            if (itemDef.type === 'consumable') {
                if (existingItemIndex !== -1) {
                    cat.inventory[existingItemIndex].quantity += quantity;
                } else {
                    cat.inventory.push({ id: itemId, quantity: quantity });
                }
            } else if (itemDef.type === 'cosmetic') {
                // 时装物品是唯一的，背包中不叠加数量
                if (existingItemIndex === -1) {
                    cat.inventory.push({ id: itemId, quantity: 1 }); // 数量为1表示拥有
                } else {
                    displayMessage(`${itemDef.name} 已经拥有了！`, 'warning');
                    return;
                }
            }
            displayMessage(`获得了 ${itemDef.name} x${quantity}！`);
            saveGameState();
        }

        // 打开背包模态框
        function openBackpack() {
            if (!cat.isAlive || cat.isRunAway) return;

            consumableItemsContainer.innerHTML = '';
            cosmeticItemsContainer.innerHTML = '';

            let hasConsumables = false;
            let hasCosmetics = false;

            cat.inventory.forEach(item => {
                const itemDef = ITEM_DEFINITIONS[item.id];
                if (!itemDef) return; // 跳过未知物品

                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';

                const itemImage = document.createElement('img');
                itemImage.src = itemDef.image || 'https://i.imgur.com/placeholder.png'; // 物品图片，没有则用占位图
                itemImage.alt = itemDef.name;
                itemDiv.appendChild(itemImage);

                const itemName = document.createElement('h4');
                itemName.textContent = itemDef.name;
                itemDiv.appendChild(itemName);

                const itemDesc = document.createElement('p');
                itemDesc.textContent = itemDef.description;
                itemDesc.style.fontSize = '0.85em';
                itemDesc.style.color = '#777';
                itemDesc.style.marginBottom = '5px';
                itemDiv.appendChild(itemDesc);

                if (itemDef.type === 'consumable') {
                    hasConsumables = true;
                    const itemQuantity = document.createElement('p');
                    itemQuantity.textContent = `数量: ${item.quantity}`;
                    itemDiv.appendChild(itemQuantity);

                    const useButton = document.createElement('button');
                    useButton.textContent = '使用';
                    useButton.onclick = () => useItem(item.id);
                    itemDiv.appendChild(useButton);
                    consumableItemsContainer.appendChild(itemDiv);
                } else if (itemDef.type === 'cosmetic') {
                    hasCosmetics = true;
                    const equipButton = document.createElement('button');
                    const isEquipped = (cat.equippedCosmeticId === item.id);
                    equipButton.textContent = isEquipped ? '卸下' : '装备';
                    equipButton.className = isEquipped ? 'unequip' : ''; // 添加样式类
                    if (isEquipped) equipButton.classList.add('equipped'); // 添加已装备样式
                    equipButton.onclick = () => toggleEquipItem(item.id);
                    itemDiv.appendChild(equipButton);
                    cosmeticItemsContainer.appendChild(itemDiv);
                }
            });

            noConsumablesMessage.style.display = hasConsumables ? 'none' : 'block';
            noCosmeticsMessage.style.display = hasCosmetics ? 'none' : 'block';

            backpackModal.style.display = 'block';
        }

        // 使用物品类道具
        function useItem(itemId) {
            const itemIndex = cat.inventory.findIndex(item => item.id === itemId);
            if (itemIndex === -1) {
                displayMessage('物品不存在！', 'warning');
                return;
            }

            const item = cat.inventory[itemIndex];
            const itemDef = ITEM_DEFINITIONS[item.id];

            if (itemDef.type !== 'consumable') {
                displayMessage('这不是一个可消耗物品！', 'warning');
                return;
            }

            // 应用效果
            if (itemDef.effect) {
                if (typeof itemDef.effect.hunger !== 'undefined') cat.hunger = Math.min(100, Math.max(0, cat.hunger + itemDef.effect.hunger));
                if (typeof itemDef.effect.happiness !== 'undefined') cat.happiness = Math.min(100, Math.max(0, cat.happiness + itemDef.effect.happiness));
                if (typeof itemDef.effect.life !== 'undefined') cat.life = Math.min(100, Math.max(0, cat.life + itemDef.effect.life));
                if (typeof itemDef.effect.cleanliness !== 'undefined') cat.cleanliness = Math.min(100, Math.max(0, cat.cleanliness + itemDef.effect.cleanliness));
                if (typeof itemDef.effect.energy !== 'undefined') cat.energy = Math.min(100, Math.max(0, cat.energy + itemDef.effect.energy));
            }

            item.quantity--;
            if (item.quantity <= 0) {
                cat.inventory.splice(itemIndex, 1); // 数量为0时移除物品
            }

            updateCatStatsDisplay();
            displayMessage(`使用了 ${itemDef.name}！`);
            saveGameState();
            openBackpack(); // 重新渲染背包以显示更新后的数量/移除的物品
        }

        // 装备/卸下时装类道具
        function toggleEquipItem(itemId) {
            const itemDef = ITEM_DEFINITIONS[itemId];
            if (!itemDef || itemDef.type !== 'cosmetic') {
                displayMessage('这不是一个时装物品！', 'warning');
                return;
            }

            if (cat.equippedCosmeticId === itemId) {
                // 卸下
                cat.equippedCosmeticId = null;
                displayMessage(`卸下了 ${itemDef.name}。`);
            } else {
                // 装备
                cat.equippedCosmeticId = itemId;
                displayMessage(`装备了 ${itemDef.name}！`);
            }

            updateCatImage(); // 更新猫咪图片
            saveGameState();
            openBackpack(); // 重新渲染背包以显示更新后的装备状态
        }

        // --- 初始化 ---
        function initializeGame() {
            loadGameState();
            if (!cat.name) cat.name = DEFAULT_CAT_NAME;
            applyOfflineDecay(); // 先应用离线衰减，确保猫咪状态是最新的

            updateCatImage(); // 根据已装备时装更新猫咪图片

            // UI Reset to "game in progress" state
            gameOverActionsDiv.style.display = 'none';
            feedBtn.disabled = false;
            playBtn.disabled = false;
            petBtn.disabled = false;
            cleanBtn.disabled = false;
            restBtn.disabled = false;
            changeNameBtn.disabled = false;
            shopBtn.disabled = false;
            gameBtn.disabled = false;
            backpackBtn.disabled = false; // 启用背包按钮

            updateCatStatsDisplay();
            updateClock();
            loadAndDisplayLastViewedTime(); // 仅在初始化时调用一次

            // 现在，根据猫咪的最终状态来决定是否进入游戏结束模式
            if (!cat.isAlive || cat.isRunAway) { // 如果猫咪已经死亡或离家出走
                displayMessage(`${cat.name} ${cat.isAlive ? '已经离家出走了' : '已经死亡了'}...`, 'game-over');
                endGame(); // 调用 endGame 来显示复活/重新领养按钮，并禁用操作按钮
                return; // 阻止游戏循环启动
            }

            // 确保只启动一次游戏循环
            if (!gameLoopInterval) {
                gameLoopInterval = setInterval(gameLoop, 1000);
            }

            // 首次进入游戏时，如果背包为空，自动添加一些测试道具
            if (cat.inventory.length === 0) {
                addItemToInventory('small_food_can', 3);
                addItemToInventory('big_food_can', 1);
                addItemToInventory('toy_mouse', 2);
                addItemToInventory('cat_shampoo', 1);
                addItemToInventory('energy_drink', 1);
                addItemToInventory('straw_hat', 1);
                addItemToInventory('glasses', 1);
                addItemToInventory('scarf', 1);
                // 新增的测试道具
                addItemToInventory('teasing_stick', 1);
                addItemToInventory('catnip', 1);
                addItemToInventory('electric_mouse', 1);
                addItemToInventory('maid_outfit', 1);
                addItemToInventory('butler_outfit', 1);
                addItemToInventory('jeans', 1);
                addItemToInventory('dress', 1);
                addItemToInventory('suit', 1);
                saveGameState(); // 保存添加道具后的状态
            }
        }

        // --- 页面事件 ---
        window.addEventListener('DOMContentLoaded', () => {
            // 绑定所有事件监听器，只在页面加载时执行一次
            feedBtn.addEventListener('click', feedCat);
            playBtn.addEventListener('click', playCat);
            petBtn.addEventListener('click', petCat);
            cleanBtn.addEventListener('click', cleanCat);
            restBtn.addEventListener('click', restCat);
            changeNameBtn.addEventListener('click', changeCatName);
            shopBtn.addEventListener('click', () => {
                window.location.href = 'shop.html'; // 跳转到商店页面
            });
            gameBtn.addEventListener('click', () => {
                window.location.href = 'game.html'; // 跳转到小游戏页面
            });
            backpackBtn.addEventListener('click', openBackpack); // 背包按钮事件
            
            // 重新领养和复活按钮的事件也在这里绑定
            reAdoptBtn.addEventListener('click', reAdoptCat);
            reviveBtn.addEventListener('click', reviveCat);

            // 背包模态框关闭事件
            closeBackpackModal.addEventListener('click', () => {
                backpackModal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === backpackModal) {
                    backpackModal.style.display = 'none';
                }
            });
            
            // 绑定完所有事件后，初始化游戏状态
            initializeGame();
        });

        window.addEventListener('beforeunload', () => {
            saveGameState();
            saveCurrentTimeAsLastViewed();
        });
    </script>
</body>
</html>
