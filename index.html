<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„äº‘å…»çŒ«</title>
    <style>
        /* å­—ä½“å®šä¹‰ */
        @font-face {
            font-family: 'Miaowu80';
            src: url('fonts/miaowu80.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* å¯çˆ±é£æ ¼çš„CSSæ ·å¼ */
        body {
            font-family: 'Miaowu80', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* ç»Ÿä¸€ä½¿ç”¨ Miaowu80 å­—ä½“ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* ç¡®ä¿è‡³å°‘å æ»¡è§†å£é«˜åº¦ */
            margin: 0;
            background-color: #fdf3f8; /* æŸ”å’Œçš„ç²‰è‰²èƒŒæ™¯ */
            background-image: url('https://www.transparenttextures.com/patterns/light-honeycomb.png'); /* å¯çˆ±çš„èƒŒæ™¯çº¹ç† */
            color: #555; /* æŸ”å’Œçš„æ–‡å­—é¢œè‰² */
            flex-direction: column;
            position: relative;
            padding: 10px; /* é»˜è®¤å†…è¾¹è· */
            box-sizing: border-box; /* ç›’æ¨¡å‹è°ƒæ•´ */
        }

        /* å®æ—¶æ—¶é’Ÿçš„æ ·å¼ */
        #realTimeClock {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 192, 203, 0.7); /* å¯çˆ±çš„ç²‰è‰²åŠé€æ˜èƒŒæ™¯ */
            color: #8a2be2; /* è“ç´«è‰²æ–‡å­— */
            padding: 8px 12px;
            border-radius: 15px; /* æ›´åœ†æ¶¦çš„è¾¹è§’ */
            font-size: 0.95em;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(255, 192, 203, 0.4); /* æŸ”å’Œçš„é˜´å½± */
        }

        /* æ–°å¢ï¼šå·¦ä¸Šè§’çŒ«çŒ«å¤´ Emoji */
        #catHeadEmoji {
            position: fixed;
            top: 15px;
            left: 15px;
            font-size: 2em; /* é€‚å½“å¤§å° */
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #catHeadEmoji:hover {
            transform: scale(1.1);
        }

        .container {
            background-color: #ffffff; /* ç™½è‰²å®¹å™¨èƒŒæ™¯ */
            border-radius: 25px; /* æ›´åœ†æ¶¦çš„è¾¹è§’ */
            box-shadow: 0 15px 30px rgba(255, 192, 203, 0.3); /* æŸ”å’Œçš„ç²‰è‰²é˜´å½± */
            padding: 20px; /* é»˜è®¤å†…è¾¹è· */
            text-align: center;
            max-width: 450px; /* ç¨å¾®å®½ä¸€ç‚¹ */
            width: 90%;
            margin-bottom: 0; /* å®¹å™¨åº•éƒ¨ä¸å†æœ‰å¤–è¾¹è·ï¼Œç”±flexå¸ƒå±€æ§åˆ¶ */
            border: 2px solid #ffe4e1; /* æµ…ç²‰è‰²è¾¹æ¡† */
            
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* å…è®¸containerå æ®bodyçš„å‰©ä½™ç©ºé—´ */
        }

        /* é¡¶éƒ¨å›ºå®šåŒºåŸŸ */
        .fixed-top-section {
            flex-shrink: 0; /* é˜»æ­¢æ­¤åŒºåŸŸç¼©å° */
            padding-bottom: 15px; /* é¡¶éƒ¨å›ºå®šåŒºåŸŸå’Œåº•éƒ¨æ»‘åŠ¨åŒºåŸŸä¹‹é—´çš„é—´è· */
        }

        h1 {
            color: #ff69b4; /* å¯çˆ±çš„çƒ­ç²‰è‰²æ ‡é¢˜ */
            margin-bottom: 20px;
            font-size: 2.5em; /* ç¨å¾®å¤§ä¸€ç‚¹ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* æ ‡é¢˜é˜´å½± */
        }

        /* çŒ«å’ªåå­—æ˜¾ç¤ºå’Œä¿®æ”¹åŒºåŸŸçš„å®¹å™¨ */
        .cat-name-area {
            margin-bottom: 20px;
        }

        /* çŒ«å’ªå›¾ç‰‡å®¹å™¨æ ·å¼ - å›ºå®šå¤§å° */
        #catImageContainer {
            position: relative; /* ç›¸å¯¹å®šä½ï¼Œç”¨äºå­å…ƒç´ çš„ç»å¯¹å®šä½ */
            width: 250px; /* å›ºå®šå®½åº¦ */
            height: 250px; /* å›ºå®šé«˜åº¦ */
            margin: 0 auto 25px; /* åº•éƒ¨å¤–è¾¹è· */
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border: 5px solid #ffe4e1;
            overflow: hidden; /* éšè—è¶…å‡ºå®¹å™¨çš„éƒ¨åˆ† */
            flex-shrink: 0; /* é˜»æ­¢æ­¤å…ƒç´ ç¼©å° */
        }

        #baseCatImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* ç¡®ä¿å›¾ç‰‡è¦†ç›–æ•´ä¸ªå®¹å™¨ */
            z-index: 1; /* åŸºç¡€çŒ«å’ªå›¾ç‰‡åœ¨åº•å±‚ */
        }

        .equipped-cosmetic {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* ç¡®ä¿æ—¶è£…å›¾ç‰‡å®Œæ•´æ˜¾ç¤ºï¼Œä¸è¢«è£å‰ª */
            z-index: 2; /* æ—¶è£…å›¾ç‰‡åœ¨çŒ«å’ªå›¾ç‰‡ä¹‹ä¸Š */
            pointer-events: none; /* ç¡®ä¿ç‚¹å‡»ç©¿é€åˆ°ä¸‹å±‚å…ƒç´  */
        }

        /* åº•éƒ¨å¯æ»‘åŠ¨åŒºåŸŸ */
        .scrollable-bottom-section {
            flex-grow: 1; /* å æ®æ‰€æœ‰å‰©ä½™å‚ç›´ç©ºé—´ */
            overflow-y: auto; /* å…è®¸æ­¤åŒºåŸŸå†…éƒ¨æ»‘åŠ¨ */
            -webkit-overflow-scrolling: touch; /* æ”¹å–„iOSä¸Šçš„æ»‘åŠ¨ä½“éªŒ */
            padding-top: 15px; /* é¡¶éƒ¨å›ºå®šåŒºåŸŸå’Œåº•éƒ¨æ»‘åŠ¨åŒºåŸŸä¹‹é—´çš„é—´è· */
            padding-bottom: 10px; /* åº•éƒ¨ç•™ä¸€äº›ç©ºé—´ */
            /* æ–°å¢ï¼šè‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #ffb6c1 #fdf3f8; /* Firefox thumb and track color */
        }

        /* Webkit æµè§ˆå™¨ï¼ˆChrome, Safari, Edge, Operaï¼‰çš„æ»šåŠ¨æ¡æ ·å¼ */
        .scrollable-bottom-section::-webkit-scrollbar {
            width: 8px; /* æ»šåŠ¨æ¡å®½åº¦ */
        }

        .scrollable-bottom-section::-webkit-scrollbar-track {
            background: #fdf3f8; /* æ»šåŠ¨æ¡è½¨é“èƒŒæ™¯è‰² */
            border-radius: 10px;
        }

        .scrollable-bottom-section::-webkit-scrollbar-thumb {
            background-color: #ffb6c1; /* æ»šåŠ¨æ¡æ»‘å—é¢œè‰² */
            border-radius: 10px;
            border: 2px solid #fdf3f8; /* æ»‘å—è¾¹æ¡†ï¼Œä¸è½¨é“èƒŒæ™¯è‰²ä¸€è‡´ */
        }

        .scrollable-bottom-section::-webkit-scrollbar-thumb:hover {
            background-color: #ff69b4; /* æ»‘å—æ‚¬åœé¢œè‰² */
        }


        .stats {
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.8; /* å¢åŠ è¡Œé«˜ */
        }

        .stats p {
            margin: 8px 0; /* å¢åŠ æ®µè½é—´è· */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px; /* å¢åŠ å†…è¾¹è· */
            background-color: #fff0f5; /* æŸ”å’Œçš„ç²‰è‰²èƒŒæ™¯ */
            border-radius: 12px; /* åœ†æ¶¦çš„è¾¹è§’ */
            border: 1px solid #ffebf0; /* æµ…ç²‰è‰²è¾¹æ¡† */
        }

        .stats p strong { color: #777; } /* ç¨æ·±çš„æ–‡å­—é¢œè‰² */

        /* æ•°å€¼è¿‡æ¸¡æ•ˆæœ */
        .stats p span {
            font-weight: bold;
            color: #8a2be2; /* è“ç´«è‰²æ•°å€¼ */
            transition: color 0.3s ease, font-size 0.3s ease;
        }

        /* ä¸Šæ¬¡æŸ¥çœ‹æ—¶é—´æ ·å¼ */
        #lastViewedTimeDisplay {
            font-size: 0.9em;
            color: #999;
            margin-top: 15px;
            background-color: transparent; /* è¦†ç›–çˆ¶çº§pçš„èƒŒæ™¯è‰² */
            justify-content: center; /* å±…ä¸­æ˜¾ç¤º */
            padding: 0; /* ç§»é™¤çˆ¶çº§pçš„å†…è¾¹è· */
            border: none; /* ç§»é™¤è¾¹æ¡† */
            flex-direction: column; /* è®©æ—¶é—´å’Œæ—¶é•¿å‚ç›´æ’åˆ— */
        }
        #lastViewedTimeDisplay span {
            font-weight: normal; /* æ¢å¤æ­£å¸¸å­—ä½“ç²—ç»† */
            color: #999; /* æ¢å¤æ­£å¸¸é¢œè‰² */
            margin-top: 5px;
        }


        .actions { display: flex; flex-wrap: wrap; justify-content: center; }

        .actions button {
            background-color: #87ceeb; /* å¯çˆ±çš„å¤©è“è‰²æŒ‰é’® */
            color: white;
            border: none;
            padding: 12px 20px; /* å¢åŠ å†…è¾¹è· */
            margin: 8px;
            border-radius: 15px; /* æ›´åœ†æ¶¦çš„æŒ‰é’®è¾¹è§’ */
            cursor: pointer;
            font-size: 1.05em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(135, 206, 235, 0.3); /* æŸ”å’Œçš„è“è‰²é˜´å½± */
        }

        .actions button:hover:not(:disabled) { background-color: #6a5acd; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(106, 90, 205, 0.4); } /* æ‚¬åœæ•ˆæœ */
        .actions button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 4px 10px rgba(106, 90, 205, 0.3); }
        .actions button:disabled { background-color: #cccccc; cursor: not-allowed; box-shadow: none; opacity: 0.7; }


        #message { margin-top: 20px; font-size: 1.1em; color: #ff69b4; min-height: 25px; font-weight: bold; } /* å¯çˆ±çš„ç²‰è‰²æ¶ˆæ¯ */
        .warning { color: #ff4500 !important; font-weight: bold; } /* æ©™çº¢è‰²è­¦å‘Š */
        .game-over-message { color: #dc143c; font-weight: bold; font-size: 1.3em; margin-top: 20px; } /* æ·±çº¢è‰²æ¸¸æˆç»“æŸæ¶ˆæ¯ */

        /* çŒ«å’ªåå­—ä¿®æ”¹æŒ‰é’® */
        #changeNameBtn {
            margin-left: 10px;
            padding: 5px 12px;
            border-radius: 10px;
            border: 1px solid #ffb6c1; /* æµ…ç²‰è‰²è¾¹æ¡† */
            background-color: #fff0f5; /* æŸ”å’Œçš„ç²‰è‰²èƒŒæ™¯ */
            color: #ff69b4; /* çƒ­ç²‰è‰²æ–‡å­— */
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(255, 182, 193, 0.2);
        }
        #changeNameBtn:hover {
            background-color: #ffe4e1;
            transform: translateY(-1px);
        }

        /* æ¸¸æˆç»“æŸæ“ä½œæŒ‰é’®å®¹å™¨ */
        #gameOverActions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px; /* æŒ‰é’®é—´è· */
            margin-top: 30px;
        }

        #gameOverActions button {
            padding: 15px 25px;
            font-size: 1.1em;
            border-radius: 20px; /* æ›´åœ†æ¶¦ */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        #reAdoptBtn {
            background-color: #98fb98; /* æµ…ç»¿è‰² */
            color: #333;
        }
        #reAdoptBtn:hover:not(:disabled) {
            background-color: #66cd66;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 205, 102, 0.4);
        }

        #reviveBtn {
            background-color: #ffd700; /* é‡‘è‰² */
            color: #333;
        }
        #reviveBtn:hover:not(:disabled) {
            background-color: #e6b800;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(230, 184, 0, 0.4);
        }
        #reviveBtn:disabled {
            background-color: #ccc;
            color: #666;
        }

        /* èƒŒåŒ…æ¨¡æ€æ¡† */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            backdrop-filter: blur(5px); /* Blur effect */
            -webkit-backdrop-filter: blur(5px); /* Safari compatibility */
            padding-top: 60px; /* é¡¶éƒ¨ç•™ç©º */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 15% from the top and centered */
            padding: 30px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 700px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 192, 203, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            text-align: left; /* Align content to left */
            max-height: 90vh; /* é™åˆ¶æ¨¡æ€æ¡†å†…å®¹çš„æœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* å…è®¸æ¨¡æ€æ¡†å†…å®¹è‡ªèº«æ»šåŠ¨ */
            /* æ–°å¢ï¼šè‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #ffb6c1 #fdf3f8; /* Firefox thumb and track color */
        }

        /* Webkit æµè§ˆå™¨ï¼ˆChrome, Safari, Edge, Operaï¼‰çš„æ¨¡æ€æ¡†æ»šåŠ¨æ¡æ ·å¼ */
        .modal-content::-webkit-scrollbar {
            width: 8px; /* æ»šåŠ¨æ¡å®½åº¦ */
        }

        .modal-content::-webkit-scrollbar-track {
            background: #fdf3f8; /* æ»šåŠ¨æ¡è½¨é“èƒŒæ™¯è‰² */
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background-color: #ffb6c1; /* æ»šåŠ¨æ¡æ»‘å—é¢œè‰² */
            border-radius: 10px;
            border: 2px solid #fdf3f8; /* æ»‘å—è¾¹æ¡†ï¼Œä¸è½¨é“èƒŒæ™¯è‰²ä¸€è‡´ */
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background-color: #ff69b4; /* æ»‘å—æ‚¬åœé¢œè‰² */
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            color: #ff69b4;
            margin-top: 0;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content h3 {
            color: #8a2be2;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff69b4;
            text-decoration: none;
            cursor: pointer;
        }

        .inventory-items-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); /* Responsive grid */
            gap: 20px;
            margin-top: 20px;
        }

        .inventory-item {
            background-color: #fff0f5;
            border: 1px solid #ffebf0;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(255, 192, 203, 0.2);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .inventory-item:hover {
            transform: translateY(-3px);
        }

        .inventory-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: #ffffff;
            padding: 5px;
            border: 1px solid #eee;
        }

        .inventory-item h4 {
            margin: 5px 0;
            color: #555;
            font-size: 1.1em;
        }

        /* èƒŒåŒ…é“å…·æè¿°æ ·å¼ */
        .item-description-wrapper {
            margin: 0 0 10px 0;
            color: #777;
            font-size: 0.85em;
            cursor: pointer; /* å¯ç‚¹å‡»å±•å¼€ */
            text-align: left;
            width: 100%;
            padding: 0 5px;
            box-sizing: border-box;
        }
        .item-description-wrapper .short-desc {
            font-style: italic;
            color: #999;
        }
        .item-description-wrapper .full-desc {
            display: none; /* é»˜è®¤éšè— */
            margin-top: 5px;
            font-style: normal;
            color: #555;
        }
        .item-description-wrapper.expanded .full-desc {
            display: block; /* å±•å¼€æ—¶æ˜¾ç¤º */
        }
        .item-description-wrapper.expanded .short-desc {
            display: none; /* å±•å¼€æ—¶éšè—çŸ­æè¿° */
        }
        .item-description-wrapper::after {
            content: ' (...ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)'; /* ä¿®æ”¹æç¤ºæ–‡æœ¬ */
            font-size: 0.75em;
            color: #aaa;
            margin-left: 5px;
            display: inline;
        }
        .item-description-wrapper.expanded::after {
            content: ' (ç‚¹å‡»æ”¶èµ·)';
        }


        .inventory-item p.item-quantity { /* æ•°é‡æ–‡æœ¬ */
            margin: 0 0 10px 0;
            color: #8a2be2;
            font-weight: bold;
        }

        .inventory-item button {
            background-color: #87ceeb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            width: 100%; /* Full width button */
            margin-top: 10px;
        }
        .inventory-item button:hover {
            background-color: #6a5acd;
        }
        .inventory-item button.equipped {
            background-color: #98fb98; /* Green for equipped */
            color: #333;
        }
        .inventory-item button.equipped:hover {
            background-color: #66cd66;
        }
        .inventory-item button.unequip {
            background-color: #ffb6c1; /* Pink for unequip */
        }
        .inventory-item button.unequip:hover {
            background-color: #ff69b4;
        }

        /* No items message */
        .no-items-message {
            text-align: center;
            color: #999;
            font-style: italic;
            margin-top: 20px;
            grid-column: 1 / -1; /* Span across all columns */
        }


        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            body {
                padding: 5px; /* å‡å°bodyå†…è¾¹è· */
            }
            #catHeadEmoji {
                font-size: 1.5em; /* ç¼©å°çŒ«çŒ«å¤´ */
                top: 8px;
                left: 8px;
            }
            #realTimeClock {
                padding: 5px 8px;
                font-size: 0.8em;
                top: 8px;
                right: 8px;
            }
            .container {
                padding: 10px; /* å‡å°å®¹å™¨å†…è¾¹è· */
                border-radius: 15px;
            }
            .fixed-top-section {
                padding-bottom: 10px; /* è°ƒæ•´é—´è· */
            }
            .scrollable-bottom-section {
                padding-top: 10px; /* è°ƒæ•´é—´è· */
                padding-bottom: 5px;
            }
            h1 {
                font-size: 1.8em; /* ç¼©å°æ ‡é¢˜ */
                margin-bottom: 10px; /* å‡å°æ ‡é¢˜åº•éƒ¨å¤–è¾¹è· */
            }
            .cat-name-area { /* çŒ«å’ªåå­—æ˜¾ç¤ºåŒºåŸŸ */
                margin-bottom: 10px !important; /* å‡å°åº•éƒ¨å¤–è¾¹è· */
            }
            #catNameDisplay, .cat-name-area span:first-child {
                font-size: 1.2em !important; /* è°ƒæ•´å­—ä½“å¤§å° */
            }
            #changeNameBtn {
                padding: 3px 8px;
                font-size: 0.75em;
                margin-left: 5px;
            }

            /* çŒ«å’ªå›¾ç‰‡å®¹å™¨åœ¨å°å±å¹•ä¸Šè¿›ä¸€æ­¥ç¼©å°å›ºå®šå¤§å° */
            #catImageContainer {
                width: 200px; 
                height: 200px; 
                margin-bottom: 10px; /* å‡å°å›¾ç‰‡å®¹å™¨åº•éƒ¨å¤–è¾¹è· */
            }
            .stats {
                margin-bottom: 10px; /* å‡å°ç»Ÿè®¡åŒºåŸŸåº•éƒ¨å¤–è¾¹è· */
            }
            .stats p {
                margin: 5px 0; /* å‡å°ç»Ÿè®¡é¡¹é—´è· */
                padding: 6px 8px; /* å‡å°ç»Ÿè®¡é¡¹å†…è¾¹è· */
                font-size: 0.9em; /* è°ƒæ•´ç»Ÿè®¡é¡¹å­—ä½“å¤§å° */
            }
            /* ç»Ÿä¸€æ‰€æœ‰ .actions æŒ‰é’®çš„æ ·å¼ */
            .actions button, #gameOverActions button {
                width: calc(50% - 10px); /* å°å±å¹•ä¸ŠæŒ‰é’®ä¸¤åˆ—æ˜¾ç¤ºï¼Œå‡å°é—´è· */
                font-size: 0.9em;
                padding: 8px 12px;
                margin: 4px; /* å‡å°æŒ‰é’®å¤–è¾¹è· */
            }
            #gameOverActions {
                gap: 8px;
                margin-top: 15px; /* å‡å°æ¸¸æˆç»“æŸæ“ä½œåŒºåŸŸé¡¶éƒ¨å¤–è¾¹è· */
            }
            #message {
                margin-top: 10px;
                font-size: 0.9em;
                min-height: 20px; /* å‡å°æœ€å°é«˜åº¦ */
            }
            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 15px;
            }
            .inventory-items-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }
            .inventory-item img {
                width: 45px;
                height: 45px;
            }
            .inventory-item h4 {
                font-size: 0.9em;
            }
            .item-description-wrapper {
                font-size: 0.75em;
            }
            .item-description-wrapper::after {
                font-size: 0.65em;
            }
            .inventory-item p.item-quantity {
                font-size: 0.75em;
            }
            .inventory-item button {
                padding: 5px 8px;
                font-size: 0.75em;
            }
        }

        /* é’ˆå¯¹éå¸¸çŸ­çš„å±å¹•ï¼ˆä¾‹å¦‚æ¨ªå±æ‰‹æœºæˆ–å°å¹³æ¿ï¼‰è¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (max-height: 650px) and (max-width: 900px) {
            body {
                padding: 3px; /* è¿›ä¸€æ­¥å‡å°bodyå†…è¾¹è· */
            }
            #catHeadEmoji {
                font-size: 1.2em; /* å†æ¬¡ç¼©å°çŒ«çŒ«å¤´ */
                top: 5px;
                left: 5px;
            }
            #realTimeClock {
                padding: 3px 6px;
                font-size: 0.7em;
                top: 5px;
                right: 5px;
            }
            .container {
                padding: 8px; /* è¿›ä¸€æ­¥å‡å°å®¹å™¨å†…è¾¹è· */
            }
            .fixed-top-section {
                padding-bottom: 8px;
            }
            .scrollable-bottom-section {
                padding-top: 8px;
                padding-bottom: 3px;
            }
            h1 {
                font-size: 1.6em;
                margin-bottom: 8px;
            }
            .cat-name-area { /* çŒ«å’ªåå­—æ˜¾ç¤ºåŒºåŸŸ */
                margin-bottom: 8px !important;
            }
            #catNameDisplay, .cat-name-area span:first-child {
                font-size: 1.1em !important;
            }
            #changeNameBtn {
                padding: 2px 6px;
                font-size: 0.7em;
                margin-left: 4px;
            }
            /* çŒ«å’ªå›¾ç‰‡å®¹å™¨åœ¨éå¸¸çŸ­çš„å±å¹•ä¸Šå†æ¬¡ç¼©å°å›ºå®šå¤§å° */
            #catImageContainer {
                width: 180px; 
                height: 180px; 
                margin-bottom: 8px;
            }
            .stats {
                margin-bottom: 8px;
            }
            .stats p {
                margin: 2px 0;
                padding: 5px 6px;
                font-size: 0.85em;
            }
            #lastViewedTimeDisplay {
                margin-top: 5px;
                font-size: 0.75em;
            }
            /* ç»Ÿä¸€æ‰€æœ‰ .actions æŒ‰é’®çš„æ ·å¼ */
            .actions button, #gameOverActions button {
                padding: 6px 10px;
                font-size: 0.8em;
                margin: 2px;
            }
            #gameOverActions {
                gap: 6px;
                margin-top: 10px;
            }
            #message {
                margin-top: 8px;
                font-size: 0.8em;
                min-height: 18px;
            }
            .modal {
                padding-top: 10px; /* å‡å°æ¨¡æ€æ¡†é¡¶éƒ¨å†…è¾¹è· */
            }
            .modal-content {
                margin: 0.5% auto; /* å‡å°æ¨¡æ€æ¡†é¡¶éƒ¨å¤–è¾¹è· */
                padding: 10px;
                max-height: 98vh; /* ç¡®ä¿æ¨¡æ€æ¡†å†…å®¹åœ¨çŸ­å±å¹•ä¸‹ä¹Ÿèƒ½é€‚åº” */
            }
            .modal-content h2 {
                font-size: 1.4em;
                margin-bottom: 8px;
            }
            .modal-content h3 {
                font-size: 1.1em;
                margin-top: 10px;
                margin-bottom: 6px;
            }
            .inventory-items-container {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 6px;
            }
            .inventory-item {
                padding: 8px;
            }
            .inventory-item img {
                width: 35px;
                height: 35px;
            }
            .inventory-item h4 {
                font-size: 0.8em;
            }
            .item-description-wrapper {
                font-size: 0.65em;
            }
            .item-description-wrapper::after {
                font-size: 0.55em;
            }
            .inventory-item p.item-quantity {
                font-size: 0.7em;
            }
            .inventory-item button {
                padding: 4px 6px;
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <!-- å®æ—¶æ—¶é’Ÿæ˜¾ç¤ºåŒºåŸŸ -->
    <div id="realTimeClock"></div>

    <!-- æ–°å¢ï¼šå·¦ä¸Šè§’çŒ«çŒ«å¤´ Emoji -->
    <div id="catHeadEmoji" title="ç‚¹å‡»ä¸Šä¼ çŒ«å’ªç…§ç‰‡">ğŸ˜º</div>
    <!-- æ–°å¢ï¼šéšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡† -->
    <input type="file" id="imageUpload" accept="image/*" style="display: none;">

    <div class="container">
        <!-- é¡¶éƒ¨å›ºå®šåŒºåŸŸ -->
        <div class="fixed-top-section">
            <h1 id="gameTitle">æˆ‘çš„äº‘å…»çŒ«</h1>
            <!-- çŒ«å’ªåå­—æ˜¾ç¤ºå’Œä¿®æ”¹åŒºåŸŸ -->
            <div class="cat-name-area">
                <span style="font-size: 1.5em; font-weight: bold; color: #6c757d;">åå­—: </span>
                <span id="catNameDisplay" style="font-size: 1.5em; font-weight: bold; color: #ff69b4;">çŒ«å’ª</span>
                <button id="changeNameBtn">ä¿®æ”¹åå­—</button>
            </div>

            <!-- çŒ«å’ªå›¾ç‰‡å®¹å™¨ï¼Œç”¨äºå åŠ æ—¶è£… -->
            <div id="catImageContainer">
                <!-- **é‡è¦ï¼šéƒ¨ç½²åˆ°å›½å†…å¹³å°æ—¶ï¼Œè¯·ç¡®ä¿å°†æ‰€æœ‰å›¾ç‰‡é“¾æ¥æ›¿æ¢ä¸ºæœ¬åœ°è·¯å¾„ï¼Œä¾‹å¦‚ 'images/catbenti.png'** -->
                <img id="baseCatImage" src="images/catbenti.png" alt="å¯çˆ±çš„çŒ«å’ª" />
                <!-- è£…å¤‡çš„æ—¶è£…å›¾ç‰‡å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
        </div>

        <!-- åº•éƒ¨å¯æ»‘åŠ¨åŒºåŸŸ -->
        <div class="scrollable-bottom-section">
            <div class="stats">
                <p><strong>é¥¥é¥¿åº¦:</strong> <span id="hunger">50</span></p>
                <p><strong>å¹¸ç¦åº¦:</strong> <span id="happiness">50</span></p>
                <p><strong>ç”Ÿå‘½å€¼:</strong> <span id="life">100</span></p>
                <p><strong>æ¸…æ´åº¦:</strong> <span id="cleanliness">100</span></p>
                <p><strong>ç²¾åŠ›:</strong> <span id="energy">100</span></p>
                <!-- æ–°å¢ï¼šé‡‘å¸æ˜¾ç¤ºåŒºåŸŸ -->
                <p><strong>é‡‘å¸:</strong> <span id="gold">0</span></p>
                <!-- /æ–°å¢ -->
                <p id="lastViewedTimeDisplay">
                    ä¸Šæ¬¡æŸ¥çœ‹: <span id="lastViewedExactTime">é¦–æ¬¡è®¿é—®</span><br>
                    <span id="timeSinceLastViewed"></span>
                </p>
            </div>

            <div class="actions">
                <button id="feedBtn">å–‚é£Ÿ</button>
                <button id="playBtn">ç©è€</button>
                <button id="petBtn">æŠšæ‘¸</button>
                <button id="cleanBtn">æ¸…æ´</button>
                <button id="restBtn">ä¼‘æ¯</button>
                <!-- æ–°å¢ï¼šå•†åº—ã€å°æ¸¸æˆå’ŒèƒŒåŒ…æŒ‰é’® -->
                <button id="shopBtn">å•†åº—</button>
                <button id="gameBtn">å°æ¸¸æˆ</button>
                <button id="backpackBtn">èƒŒåŒ…</button>
                <!-- /æ–°å¢ -->
            </div>

            <p id="message"></p>

            <!-- æ–°å¢ï¼šæ¸¸æˆç»“æŸåçš„æ“ä½œæŒ‰é’® -->
            <div id="gameOverActions" style="margin-top: 20px; display: none;">
                <button id="reAdoptBtn">é‡æ–°é¢†å…»</button>
                <button id="reviveBtn">å¤æ´» (100é‡‘å¸)</button>
            </div>
            <!-- /æ–°å¢ -->
        </div>
    </div>

    <!-- èƒŒåŒ…æ¨¡æ€æ¡† -->
    <div id="backpackModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeBackpackModal">&times;</span>
            <h2>æˆ‘çš„èƒŒåŒ…</h2>

            <h3>ç‰©å“ç±» (æ¶ˆè€—å“)</h3>
            <div id="consumableItemsContainer" class="inventory-items-container">
                <p class="no-items-message" id="noConsumablesMessage">èƒŒåŒ…é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å•†åº—é€›é€›å§ï¼</p>
            </div>

            <h3>æ—¶è£…ç±» (è£…æ‰®)</h3>
            <div id="cosmeticItemsContainer" class="inventory-items-container">
                <p class="no-items-message" id="noCosmeticsMessage">èƒŒåŒ…é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å•†åº—é€›é€›å§ï¼</p>
            </div>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½®å¸¸é‡ ---
        const GAME_STATE_KEY = 'catGameSaveState';
        const LAST_VIEWED_KEY = 'catGameLastViewed';
        const DEFAULT_CAT_NAME = 'çŒ«å’ª';
        // å¦‚æœä½ å¸Œæœ›çŒ«å’ªçš„åŸºç¡€å½¢è±¡æ˜¯â€œæ‹Ÿäººâ€çš„ï¼Œè¯·å°†æ­¤é“¾æ¥æ›¿æ¢ä¸ºä¸€å¼ é€æ˜èƒŒæ™¯çš„æ‹ŸäººçŒ«å’ªåŸºç¡€å›¾ç‰‡ã€‚
        // **é‡è¦ï¼šéƒ¨ç½²åˆ°å›½å†…å¹³å°æ—¶ï¼Œè¯·ç¡®ä¿å°†æ‰€æœ‰å›¾ç‰‡é“¾æ¥æ›¿æ¢ä¸ºæœ¬åœ°è·¯å¾„ï¼Œä¾‹å¦‚ 'images/catbenti.png'**
        const DEFAULT_CAT_IMAGE_SRC = 'images/catbenti.png'; // é»˜è®¤çŒ«å’ªå›¾ç‰‡
        const CUSTOM_CAT_IMAGE_KEY = 'customCatImage'; // ç”¨äºä¿å­˜è‡ªå®šä¹‰çŒ«å’ªå›¾ç‰‡ Base64 å­—ç¬¦ä¸²çš„ key

        // æ•°å€¼ä¸‹é™é¢‘ç‡ (ç§’ä¸ºå•ä½ï¼Œè¡¨ç¤ºæ¯å¤šå°‘ç§’ä¸‹é™1ç‚¹)
        const HUNGER_DECLINE_SECONDS_NORMAL = 60 * 60 * 2; // é¥¥é¥¿åº¦æ¯2å°æ—¶ä¸‹é™1ç‚¹
        const HAPPINESS_DECLINE_SECONDS_NORMAL = 60 * 60 * 4; // å¹¸ç¦åº¦æ¯4å°æ—¶ä¸‹é™1ç‚¹
        const LIFE_DECLINE_SECONDS_NORMAL = 60 * 60 * 6; // ç”Ÿå‘½å€¼æ¯6å°æ—¶ä¸‹é™1ç‚¹

        // ç‰¹å®šæ—¶é—´æ®µé¥¥é¥¿åº¦åŠ é€Ÿä¸‹é™å€æ•°
        const HUNGER_ACCELERATED_MULTIPLIER = 5; // åŠ é€Ÿ5å€
        const MORNING_START_HOUR = 7; const MORNING_END_HOUR = 9;
        const NOON_START_HOUR = 12; const NOON_END_HOUR = 14;
        const EVENING_START_HOUR = 18; const EVENING_END_HOUR = 20;

        const DAYS_UNTIL_DEATH_NO_FOOD = 3; // 3å¤©ä¸å–‚é£ŸçŒ«å’ªæ­»äº¡

        // æ–°å¢ï¼šæ¸…æ´ä¸ç²¾åŠ›
        const CLEANLINESS_DECLINE_SECONDS_NORMAL = 60 * 60 * 8; // æ¸…æ´åº¦æ¯8å°æ—¶ä¸‹é™1ç‚¹
        const ENERGY_DECLINE_SECONDS_NORMAL = 60 * 60 * 6; // ç²¾åŠ›æ¯6å°æ—¶ä¸‹é™1ç‚¹
        const ENERGY_RECOVER_SECONDS_IDLE = 60 * 60 * 3; // ç©ºé—²æ¯3å°æ—¶è‡ªåŠ¨+1ç²¾åŠ›

        const CLEANLINESS_LOW_THRESHOLD = 30; // æ¸…æ´ä½é˜ˆ
        const ENERGY_LOW_THRESHOLD = 20; // ç²¾åŠ›ä½é˜ˆ

        // --- Item Definitions (for shop and backpack) ---
        // è¯·å°† image é“¾æ¥æ›¿æ¢ä¸ºå®é™…çš„å›¾ç‰‡é“¾æ¥ï¼
        // å¯¹äºæ—¶è£…ç±» (cosmetic) ç‰©å“ï¼Œimage é“¾æ¥åº”ä¸º**é€æ˜èƒŒæ™¯**çš„**æ—¶è£…é…ä»¶å›¾ç‰‡**ï¼Œè€Œä¸æ˜¯å¸¦çŒ«å’ªçš„å®Œæ•´å›¾ç‰‡ã€‚
        // **é‡è¦ï¼šéƒ¨ç½²åˆ°å›½å†…å¹³å°æ—¶ï¼Œè¯·ç¡®ä¿å°†æ‰€æœ‰å›¾ç‰‡é“¾æ¥æ›¿æ¢ä¸ºæœ¬åœ°è·¯å¾„ï¼Œä¾‹å¦‚ 'images/small_food.png'**
        const ITEM_DEFINITIONS = {
            // Consumables (ç‰©å“ç±»)
            'small_food_can': {
                id: 'small_food_can',
                name: 'å°ç½å¤´',
                type: 'consumable',
                description: 'å¢åŠ å°‘é‡é¥¥é¥¿åº¦ã€‚',
                effect: { hunger: 20, happiness: 5 },
                price: 10,
                image: 'images/small_food.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'big_food_can': {
                id: 'big_food_can',
                name: 'å¤§ç½å¤´',
                type: 'consumable',
                description: 'å¤§å¹…å¢åŠ é¥¥é¥¿åº¦ã€‚',
                effect: { hunger: 50, happiness: 10, life: 5 },
                price: 30,
                image: 'images/big_food.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'toy_mouse': {
                id: 'toy_mouse',
                name: 'ç©å…·è€é¼ ',
                type: 'consumable',
                description: 'å¢åŠ å°‘é‡å¹¸ç¦åº¦ï¼Œæ¶ˆè€—å°‘é‡ç²¾åŠ›ã€‚',
                effect: { happiness: 30, energy: -10 },
                price: 15,
                image: 'images/toy_mouse.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'cat_shampoo': {
                id: 'cat_shampoo',
                name: 'çŒ«å’ªæ´—å‘æ°´',
                type: 'consumable',
                description: 'å¤§å¹…å¢åŠ æ¸…æ´åº¦ã€‚',
                effect: { cleanliness: 50, happiness: 5 },
                price: 20,
                image: 'images/cat_shampoo.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'energy_drink': {
                id: 'energy_drink',
                name: 'ç²¾åŠ›è¯æ°´',
                type: 'consumable',
                description: 'æ¢å¤å¤§é‡ç²¾åŠ›ã€‚',
                effect: { energy: 40, hunger: -5 }, // Minor hunger cost
                price: 25,
                image: 'images/energy_drink.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'life_potion': {
                id: 'life_potion',
                name: 'ç”Ÿå‘½è¯æ°´',
                type: 'consumable',
                description: 'æ¢å¤å°‘é‡ç”Ÿå‘½å€¼ã€‚',
                effect: { life: 30 },
                price: 40,
                image: 'images/life_potion.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'super_food': {
                id: 'super_food',
                name: 'è¶…çº§çŒ«ç²®',
                type: 'consumable',
                description: 'å…¨é¢æå‡çŒ«å’ªçŠ¶æ€ï¼',
                effect: { hunger: 40, happiness: 20, life: 10, cleanliness: 20, energy: 20 },
                price: 80,
                image: 'images/super_food.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'health_kit': {
                id: 'health_kit',
                name: 'æ€¥æ•‘åŒ…',
                type: 'consumable',
                description: 'å¿«é€Ÿæ¢å¤å¤§é‡ç”Ÿå‘½å€¼ã€‚',
                effect: { life: 50, happiness: 10 },
                price: 60,
                image: 'images/health_kit.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'happy_ball': {
                id: 'happy_ball',
                name: 'å¿«ä¹çƒ',
                type: 'consumable',
                description: 'è®©çŒ«å’ªç¬é—´å¼€å¿ƒèµ·æ¥ï¼',
                effect: { happiness: 50, energy: -15 },
                price: 35,
                image: 'images/happy_ball.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            // æ–°å¢çŒ«å’ªç©å…·
            'teasing_stick': {
                id: 'teasing_stick',
                name: 'é€—çŒ«æ£’',
                type: 'consumable',
                description: 'å’ŒçŒ«å’ªç©è€ï¼Œå¢åŠ å¹¸ç¦æ„Ÿï¼Œæ¶ˆè€—å°‘é‡ç²¾åŠ›ã€‚',
                effect: { happiness: 25, energy: -10 },
                price: 12,
                image: 'images/teasing_stick.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'catnip': {
                id: 'catnip',
                name: 'çŒ«è–„è·',
                type: 'consumable',
                description: 'è®©çŒ«å’ªå…´å¥‹ä¸å·²ï¼Œå¤§å¹…å¢åŠ å¹¸ç¦æ„Ÿï¼Œç•¥å¾®æ¶ˆè€—ç²¾åŠ›ã€‚',
                effect: { happiness: 40, energy: -15, life: 5 },
                price: 20,
                image: 'images/catnip.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },
            'electric_mouse': {
                id: 'electric_mouse',
                name: 'ç”µåŠ¨è€é¼ ',
                type: 'consumable',
                description: 'çŒ«å’ªæœ€çˆ±çš„è¿½é€æ¸¸æˆï¼Œå¢åŠ å¹¸ç¦æ„Ÿï¼Œæ¶ˆè€—ç²¾åŠ›ã€‚',
                effect: { happiness: 35, energy: -20 },
                price: 28,
                image: 'images/electric_mouse.png' // æ›¿æ¢ä¸ºå®é™…å›¾ç‰‡
            },

            // Cosmetics (æ—¶è£…ç±») - **è¯·ç¡®ä¿è¿™äº›å›¾ç‰‡æ˜¯é€æ˜èƒŒæ™¯çš„é…ä»¶å›¾ç‰‡ï¼**
            'straw_hat': {
                id: 'straw_hat',
                name: 'è‰å¸½',
                type: 'cosmetic',
                description: 'ç»™çŒ«å’ªæˆ´ä¸Šå¯çˆ±çš„è‰å¸½ã€‚',
                price: 50,
                image: 'images/straw_hat.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'glasses': {
                id: 'glasses',
                name: 'çœ¼é•œ',
                type: 'cosmetic',
                description: 'è®©çŒ«å’ªçœ‹èµ·æ¥æ›´èªæ˜ã€‚',
                price: 70,
                image: 'images/glasses.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'scarf': {
                id: 'scarf',
                name: 'å°å›´å·¾',
                type: 'cosmetic',
                description: 'ç»™çŒ«å’ªä¿æš–ã€‚',
                price: 60,
                image: 'images/scarf.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'crown': {
                id: 'crown',
                name: 'å°çš‡å† ',
                type: 'cosmetic',
                description: 'è®©çŒ«å’ªæˆä¸ºå°ç‹å­/å…¬ä¸»ã€‚',
                price: 120,
                image: 'images/crown.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'bow_tie': {
                id: 'bow_tie',
                name: 'è´è¶ç»“',
                type: 'cosmetic',
                description: 'ä¼˜é›…çš„çŒ«å’ªé…é¥°ã€‚',
                price: 40,
                image: 'images/bow_tie.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'cape': {
                id: 'cape',
                name: 'å°æŠ«é£',
                type: 'cosmetic',
                description: 'è®©çŒ«å’ªæ‹¥æœ‰è‹±é›„æ°”æ¦‚ã€‚',
                price: 100,
                image: 'images/cape.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'party_hat': {
                id: 'party_hat',
                name: 'æ´¾å¯¹å¸½',
                type: 'cosmetic',
                description: 'ä¸ºçŒ«å’ªçš„ç”Ÿæ—¥æ´¾å¯¹å‡†å¤‡ï¼',
                price: 80,
                image: 'images/party_hat.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            'flower_collar': {
                id: 'flower_collar',
                name: 'èŠ±æœµé¡¹åœˆ',
                type: 'cosmetic',
                description: 'è®©çŒ«å’ªæ›´å…·ç”°å›­é£æƒ…ã€‚',
                price: 55,
                image: 'images/flower_collar.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG
            },
            // æ–°å¢æ‹ŸäººçŒ«çŒ«æœè£…
            'maid_outfit': {
                id: 'maid_outfit',
                name: 'å¥³ä»†è£…',
                type: 'cosmetic',
                description: 'å¯çˆ±çš„å¥³ä»†è£…ï¼Œè®©çŒ«å’ªä¸ºä½ æœåŠ¡ï¼',
                price: 150,
                image: 'images/maid_outfit.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG (å¥³ä»†è£…é…ä»¶)
            },
            'butler_outfit': {
                id: 'butler_outfit',
                name: 'ç”·ä»†è£…',
                type: 'cosmetic',
                description: 'å¸…æ°”çš„ç”·ä»†è£…ï¼Œå°½æ˜¾ç»…å£«é£èŒƒã€‚',
                price: 150,
                image: 'images/butler_outfit.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG (ç”·ä»†è£…é…ä»¶)
            },
            'jeans': {
                id: 'jeans',
                name: 'ç‰›ä»”è£¤',
                type: 'cosmetic',
                description: 'æ—¶å°šç™¾æ­çš„ç‰›ä»”è£¤ï¼Œä¼‘é—²åˆå¸…æ°”ã€‚',
                price: 90,
                image: 'images/jeans.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG (ç‰›ä»”è£¤é…ä»¶)
            },
            'dress': {
                id: 'dress',
                name: 'å°ç¤¼è£™',
                type: 'cosmetic',
                description: 'ä¼˜é›…çš„å°ç¤¼è£™ï¼Œé€‚åˆå‚åŠ æ´¾å¯¹ã€‚',
                price: 130,
                image: 'images/dress.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG (å°ç¤¼è£™é…ä»¶)
            },
            'suit': {
                id: 'suit',
                name: 'å°è¥¿è£…',
                type: 'cosmetic',
                description: 'æ­£å¼çš„å°è¥¿è£…ï¼Œå‡ºå¸­é‡è¦åœºåˆã€‚',
                price: 140,
                image: 'images/suit.png' // æ›¿æ¢ä¸ºå®é™…é€æ˜PNG (å°è¥¿è£…é…ä»¶)
            }
        };

        // --- è¾…åŠ©å‡½æ•° ---
        function toDateSafe(v) {
            // æŠŠå¯èƒ½æ˜¯ Date / ISO å­—ç¬¦ä¸² / null è½¬ä¸ºæœ‰æ•ˆ Dateï¼ˆæ— æ•ˆè¿”å›å½“å‰æ—¶é—´ï¼‰
            if (v instanceof Date) return v;
            try {
                const d = new Date(v);
                if (isNaN(d.getTime())) return new Date();
                return d;
            } catch (e) {
                return new Date();
            }
        }

        // --- çŒ«å’ªçŠ¶æ€ (é»˜è®¤å€¼) ---
        let cat = {
            hunger: 50,
            happiness: 50,
            life: 100,
            isAlive: true,
            isRunAway: false,
            // è¿è¡Œæ—¶ä½¿ç”¨ Date å¯¹è±¡ï¼Œåºåˆ—åŒ–æ—¶ä¼šè½¬ä¸º ISO
            lastUpdateTime: new Date(),
            lastFedTime: new Date(),
            cleanliness: 100,
            energy: 100,
            name: DEFAULT_CAT_NAME,
            lastPlayedAt: null, // ç”¨äºç©ºé—²æ¢å¤åˆ¤å®š
            // æ–°å¢ï¼šé‡‘å¸å±æ€§
            gold: 0, // åˆå§‹é‡‘å¸æ•°é‡
            // æ–°å¢ï¼šè¿ç»­æ“ä½œè®¡æ•°å™¨ï¼Œç”¨äºæƒ©ç½šæœºåˆ¶
            consecutiveFullFeeds: 0, // é¥±è…¹çŠ¶æ€ä¸‹è¿ç»­å–‚é£Ÿæ¬¡æ•°
            consecutiveFullCleans: 0, // æ¸…æ´å€¼æ»¡çŠ¶æ€ä¸‹è¿ç»­æ¸…æ´æ¬¡æ•°
            consecutiveFullRests: 0,  // ç²¾åŠ›å€¼æ»¡çŠ¶æ€ä¸‹è¿ç»­ä¼‘æ¯æ¬¡æ•°
            consecutiveFullPlays: 0,  // å¹¸ç¦å€¼æ»¡çŠ¶æ€ä¸‹è¿ç»­ç©è€æ¬¡æ•°
            // æ–°å¢ï¼šèƒŒåŒ…å’Œå·²è£…å¤‡æ—¶è£…
            inventory: [], // Array of { id: 'item_id', quantity: N }
            equippedCosmeticId: null, // Stores the ID of the currently equipped cosmetic item
        };

        // --- è·å–DOMå…ƒç´  ---
        const hungerSpan = document.getElementById('hunger');
        const happinessSpan = document.getElementById('happiness');
        const lifeSpan = document.getElementById('life');
        const cleanlinessSpan = document.getElementById('cleanliness');
        const energySpan = document.getElementById('energy');
        const messageP = document.getElementById('message');
        const catNameDisplay = document.getElementById('catNameDisplay');
        const changeNameBtn = document.getElementById('changeNameBtn');
        const gameTitle = document.getElementById('gameTitle');
        const feedBtn = document.getElementById('feedBtn');
        const playBtn = document.getElementById('playBtn');
        const petBtn = document.getElementById('petBtn');
        const cleanBtn = document.getElementById('cleanBtn');
        const restBtn = document.getElementById('restBtn');
        const realTimeClockDiv = document.getElementById('realTimeClock');
        const lastViewedExactTimeSpan = document.getElementById('lastViewedExactTime');
        const timeSinceLastViewedSpan = document.getElementById('timeSinceLastViewed');
        // ä¿®æ”¹ï¼šè·å–çŒ«å’ªå›¾ç‰‡å®¹å™¨å’ŒåŸºç¡€å›¾ç‰‡å…ƒç´ 
        const catImageContainerElement = document.getElementById('catImageContainer');
        const baseCatImageElement = document.getElementById('baseCatImage');
        // æ–°å¢ï¼šè·å–é‡‘å¸æ˜¾ç¤ºå…ƒç´ å’Œå•†åº—/æ¸¸æˆ/èƒŒåŒ…æŒ‰é’®
        const goldSpan = document.getElementById('gold');
        const shopBtn = document.getElementById('shopBtn');
        const gameBtn = document.getElementById('gameBtn');
        const backpackBtn = document.getElementById('backpackBtn');
        // æ–°å¢ï¼šè·å–æ¸¸æˆç»“æŸæ“ä½œåŒºåŸŸå’ŒæŒ‰é’®
        const gameOverActionsDiv = document.getElementById('gameOverActions');
        const reAdoptBtn = document.getElementById('reAdoptBtn');
        const reviveBtn = document.getElementById('reviveBtn');
        // æ–°å¢ï¼šèƒŒåŒ…æ¨¡æ€æ¡†å…ƒç´ 
        const backpackModal = document.getElementById('backpackModal');
        const closeBackpackModal = document.getElementById('closeBackpackModal');
        const consumableItemsContainer = document.getElementById('consumableItemsContainer');
        const cosmeticItemsContainer = document.getElementById('cosmeticItemsContainer');
        const noConsumablesMessage = document.getElementById('noConsumablesMessage');
        const noCosmeticsMessage = document.getElementById('noCosmeticsMessage');
        // æ–°å¢ï¼šçŒ«çŒ«å¤´å’Œå›¾ç‰‡ä¸Šä¼ å…ƒç´ 
        const catHeadEmoji = document.getElementById('catHeadEmoji');
        const imageUpload = document.getElementById('imageUpload');


        // ç”¨äºç®¡ç†æ™®é€šæ¶ˆæ¯çš„ setTimeout ID
        let currentMessageTimeout = null;

        // --- æŒä¹…åŒ–å’ŒåŠ è½½æ¸¸æˆçŠ¶æ€ ---
        function saveGameState() {
            // ç¡®ä¿ä»¥ ISO å­—ç¬¦ä¸²ä¿å­˜æ—¶é—´å­—æ®µ
            const copy = {
                ...cat,
                lastUpdateTime: (cat.lastUpdateTime instanceof Date) ? cat.lastUpdateTime.toISOString() : new Date(cat.lastUpdateTime).toISOString(),
                lastFedTime: (cat.lastFedTime instanceof Date) ? cat.lastFedTime.toISOString() : new Date(cat.lastFedTime).toISOString(),
                lastPlayedAt: (cat.lastPlayedAt instanceof Date) ? cat.lastPlayedAt.toISOString() : cat.lastPlayedAt // It might be null or string already
            };
            localStorage.setItem(GAME_STATE_KEY, JSON.stringify(copy));
            // console.log('ä¿å­˜å­˜æ¡£', copy);
        }

        function loadGameState() {
            const saved = localStorage.getItem(GAME_STATE_KEY);
            if (!saved) {
                // é¦–æ¬¡è¿è¡Œï¼Œåˆå§‹åŒ–æ‰€æœ‰é»˜è®¤å€¼
                cat.lastUpdateTime = new Date();
                cat.lastFedTime = new Date();
                cat.name = DEFAULT_CAT_NAME;
                cat.gold = 0;
                cat.consecutiveFullFeeds = 0;
                cat.consecutiveFullCleans = 0;
                cat.consecutiveFullRests = 0;
                cat.consecutiveFullPlays = 0;
                cat.inventory = []; // åˆå§‹åŒ–èƒŒåŒ…
                cat.equippedCosmeticId = null; // åˆå§‹åŒ–å·²è£…å¤‡æ—¶è£…
                return;
            }

            try {
                const loaded = JSON.parse(saved);
                cat = { ...cat, ...loaded };
                // å°†æ—¶é—´å­—æ®µè½¬ä¸º Date å¯¹è±¡ï¼ˆå¥å£®è½¬æ¢ï¼‰
                cat.lastUpdateTime = toDateSafe(cat.lastUpdateTime);
                cat.lastFedTime = toDateSafe(cat.lastFedTime);
                if (cat.lastPlayedAt) cat.lastPlayedAt = toDateSafe(cat.lastPlayedAt); // Convert if exists

                if (!cat.name) cat.name = DEFAULT_CAT_NAME;
                if (typeof cat.gold === 'undefined') cat.gold = 0;
                if (typeof cat.consecutiveFullFeeds === 'undefined') cat.consecutiveFullFeeds = 0;
                if (typeof cat.consecutiveFullCleans === 'undefined') cat.consecutiveFullCleans = 0;
                if (typeof cat.consecutiveFullRests === 'undefined') cat.consecutiveFullRests = 0;
                if (typeof cat.consecutiveFullPlays === 'undefined') cat.consecutiveFullPlays = 0;
                // æ–°å¢ï¼šå¦‚æœæ—§å­˜æ¡£æ²¡æœ‰ inventory æˆ– equippedCosmeticId å±æ€§ï¼Œåˆ™åˆå§‹åŒ–
                if (typeof cat.inventory === 'undefined') cat.inventory = [];
                if (typeof cat.equippedCosmeticId === 'undefined') cat.equippedCosmeticId = null;

            } catch (e) {
                console.error('è¯»å–å­˜æ¡£å¤±è´¥ï¼Œåˆå§‹åŒ–æ–°æ¸¸æˆ', e);
                // è¯»å–å¤±è´¥æ—¶ï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€ä¸ºé»˜è®¤å€¼
                cat = {
                    hunger: 50, happiness: 50, life: 100, isAlive: true, isRunAway: false,
                    lastUpdateTime: new Date(), lastFedTime: new Date(),
                    cleanliness: 100, energy: 100, name: DEFAULT_CAT_NAME,
                    lastPlayedAt: null, gold: 0,
                    consecutiveFullFeeds: 0, consecutiveFullCleans: 0,
                    consecutiveFullRests: 0, consecutiveFullPlays: 0,
                    inventory: [],
                    equippedCosmeticId: null
                };
            }
        }

        // --- ç¦»çº¿çŠ¶æ€è¡°å‡è®¡ç®— ---
        function applyOfflineDecay() {
            const now = new Date();
            const lastUpdate = toDateSafe(cat.lastUpdateTime);
            const elapsedMs = now.getTime() - lastUpdate.getTime();
            const elapsedSec = Math.floor(elapsedMs / 1000);
            if (elapsedSec <= 0 || (!cat.isAlive && !cat.isRunAway)) return;

            // é¥¥é¥¿åº¦
            let hungerDecay = Math.floor(elapsedSec / HUNGER_DECLINE_SECONDS_NORMAL);
            // ç®€åŒ–æ—¶é—´æ®µåŠ é€Ÿçš„ç²—ç•¥ä¼°ç®—
            const hoursElapsed = elapsedMs / 3600000;
            const accelHoursWindow = (MORNING_END_HOUR - MORNING_START_HOUR) + (NOON_END_HOUR - NOON_START_HOUR) + (EVENING_END_HOUR - EVENING_START_HOUR);
            const acceleratedHours = Math.min(hoursElapsed, accelHoursWindow);
            hungerDecay += Math.floor((acceleratedHours * HUNGER_ACCELERATED_MULTIPLIER) / (HUNGER_DECLINE_SECONDS_NORMAL / 3600));
            cat.hunger = Math.max(0, cat.hunger - hungerDecay);

            // å¹¸ç¦åº¦ï¼ˆå—å¤šå› ç´ å½±å“ï¼‰
            let happinessFactors = 0;
            if (cat.hunger < 50) happinessFactors++;
            if (cat.life < 50) happinessFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) happinessFactors++;
            if (cat.energy < ENERGY_LOW_THRESHOLD) happinessFactors++;
            if (happinessFactors > 0) {
                const happinessDecay = Math.floor(elapsedSec / (HAPPINESS_DECLINE_SECONDS_NORMAL / (1 + happinessFactors * 0.5)));
                cat.happiness = Math.max(0, cat.happiness - happinessDecay);
            }

            // ç”Ÿå‘½å€¼ï¼ˆå—å¤šå› ç´ å½±å“ï¼‰
            let lifeFactors = 0;
            if (cat.hunger < 50) lifeFactors++;
            if (cat.happiness < 50) lifeFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) lifeFactors++;
            if (lifeFactors > 0) {
                const lifeDecay = Math.floor(elapsedSec / (LIFE_DECLINE_SECONDS_NORMAL / (1 + lifeFactors * 0.5)));
                cat.life = Math.max(0, cat.life - lifeDecay);
            }

            // æ¸…æ´ä¸ç²¾åŠ›
            const cleanlinessDecay = Math.floor(elapsedSec / CLEANLINESS_DECLINE_SECONDS_NORMAL);
            cat.cleanliness = Math.max(0, cat.cleanliness - cleanlinessDecay);
            const energyDecay = Math.floor(elapsedSec / ENERGY_DECLINE_SECONDS_NORMAL);
            cat.energy = Math.max(0, cat.energy - energyDecay);

            // ç©ºé—²ç²¾åŠ›æ¢å¤ï¼ˆç¦»çº¿ä¹Ÿç”Ÿæ•ˆï¼Œä¿å®ˆå¤„ç†ï¼‰
            const energyRecover = Math.floor(elapsedSec / ENERGY_RECOVER_SECONDS_IDLE);
            cat.energy = Math.min(100, cat.energy + energyRecover);

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            cat.lastUpdateTime = now;

            checkGameEndConditions(true);
            saveGameState();
        }

        // --- æ›´æ–°æ˜¾ç¤º ---
        function updateCatStatsDisplay() {
            catNameDisplay.textContent = cat.name;
            if (gameTitle) gameTitle.textContent = `æˆ‘çš„äº‘å…»${cat.name}`;

            hungerSpan.textContent = cat.hunger;
            happinessSpan.textContent = cat.happiness;
            lifeSpan.textContent = cat.life;
            cleanlinessSpan.textContent = cat.cleanliness;
            energySpan.textContent = cat.energy;
            // æ–°å¢ï¼šæ›´æ–°é‡‘å¸æ˜¾ç¤º
            goldSpan.textContent = cat.gold;

            const warnings = [];
            if (cat.hunger < 20) { hungerSpan.classList.add('warning'); warnings.push('çŒ«å’ªå¾ˆé¥¿äº†ï¼Œå¿«å–‚å®ƒï¼'); } else hungerSpan.classList.remove('warning');
            if (cat.happiness < 20) { happinessSpan.classList.add('warning'); warnings.push('çŒ«å’ªä¸å¼€å¿ƒäº†ï¼Œå¿«é™ªå®ƒç©ï¼'); } else happinessSpan.classList.remove('warning');
            if (cat.life < 30) { lifeSpan.classList.add('warning'); warnings.push('çŒ«å’ªç”Ÿå‘½å€¼å¾ˆä½ï¼Œéœ€è¦ä½ çš„å…³çˆ±ï¼'); } else lifeSpan.classList.remove('warning');
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) { cleanlinessSpan.classList.add('warning'); warnings.push('çŒ«å’ªæœ‰ç‚¹è„äº†ï¼Œå¿«ç»™å®ƒæ¸…æ´ï¼'); } else cleanlinessSpan.classList.remove('warning');
            if (cat.energy < ENERGY_LOW_THRESHOLD) { energySpan.classList.add('warning'); warnings.push('çŒ«å’ªç²¾åŠ›ä¸è¶³ï¼Œéœ€è¦ä¼‘æ¯ï¼'); } else energySpan.classList.remove('warning');

            if (warnings.length > 0) {
                displayMessage(warnings.join(' '), 'warning');
            } else if (messageP.classList.contains('warning') && currentMessageTimeout === null) {
                messageP.textContent = '';
                messageP.className = '';
            }
        }

        // --- æ¶ˆæ¯ ---
        function displayMessage(msg, type = 'info') {
            if (type === 'info' && currentMessageTimeout) {
                clearTimeout(currentMessageTimeout);
                currentMessageTimeout = null;
            }
            messageP.textContent = msg;
            messageP.className = '';
            if (type === 'warning') {
                messageP.classList.add('warning');
            } else if (type === 'game-over') {
                messageP.classList.add('game-over-message');
            } else {
                messageP.style.color = '#ff69b4'; // é»˜è®¤æ¶ˆæ¯é¢œè‰²
                currentMessageTimeout = setTimeout(() => {
                    if (messageP.textContent === msg && !messageP.classList.contains('warning') && !messageP.classList.contains('game-over-message')) {
                        messageP.textContent = '';
                        messageP.className = '';
                    }
                    currentMessageTimeout = null;
                }, 3000);
            }
        }

        // --- ç»“æŸæ¡ä»¶ ---
        function checkGameEndConditions(isOfflineCheck = false) {
            if (!cat.isAlive || cat.isRunAway) return;
            const now = new Date();

            if (cat.life <= 0) {
                cat.life = 0; cat.isAlive = false;
                displayMessage(`${cat.name} å› ç”Ÿå‘½å€¼è€—å°½è€Œæ­»äº¡äº†...`, 'game-over');
                endGame(); return;
            }

            const lastFed = toDateSafe(cat.lastFedTime);
            const daysSinceLastFed = (now.getTime() - lastFed.getTime()) / (1000 * 60 * 60 * 24);
            if (daysSinceLastFed >= DAYS_UNTIL_DEATH_NO_FOOD) {
                cat.isAlive = false;
                displayMessage(`ä½ å·²ç»${Math.floor(daysSinceLastFed)}å¤©æ²¡æœ‰å–‚é£Ÿ${cat.name}äº†ï¼Œå®ƒé¥¿æ­»äº†...`, 'game-over');
                endGame(); return;
            }

            if (cat.happiness <= 0) {
                cat.happiness = 0; cat.isRunAway = true;
                displayMessage(`${cat.name} å› ä¸å¼€å¿ƒè€Œç¦»å®¶å‡ºèµ°äº†...`, 'game-over');
                endGame(); return;
            }
        }

        function endGame() {
            feedBtn.disabled = true;
            playBtn.disabled = true;
            petBtn.disabled = true;
            cleanBtn.disabled = true;
            restBtn.disabled = true;
            changeNameBtn.disabled = true;
            shopBtn.disabled = true; // ç¦ç”¨å•†åº—æŒ‰é’®
            gameBtn.disabled = true; // ç¦ç”¨å°æ¸¸æˆæŒ‰é’®
            backpackBtn.disabled = true; // ç¦ç”¨èƒŒåŒ…æŒ‰é’®

            if (gameLoopInterval) { clearInterval(gameLoopInterval); gameLoopInterval = null; }
            updateCatStatsDisplay();
            if (!cat.isAlive) displayMessage(`${cat.name} å·²ç»æ­»äº¡äº†...`, 'game-over');
            else if (cat.isRunAway) displayMessage(`${cat.name} å·²ç»ç¦»å®¶å‡ºèµ°äº†...`, 'game-over');

            // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ“ä½œæŒ‰é’®
            gameOverActionsDiv.style.display = 'flex'; // æ˜¾ç¤ºæŒ‰é’®å®¹å™¨
            // å¦‚æœé‡‘å¸ä¸è¶³ï¼Œç¦ç”¨å¤æ´»æŒ‰é’®
            const REVIVE_COST = 100;
            if (cat.gold < REVIVE_COST) {
                reviveBtn.disabled = true;
                reviveBtn.textContent = `å¤æ´» (é‡‘å¸ä¸è¶³)`;
            } else {
                reviveBtn.disabled = false;
                reviveBtn.textContent = `å¤æ´» (${REVIVE_COST}é‡‘å¸)`;
            }
            saveGameState();
        }

        // æ–°å¢ï¼šé‡ç½®å…¶ä»–è¿ç»­æ“ä½œè®¡æ•°å™¨
        function resetConsecutiveCounters(currentAction) {
            // å¦‚æœå½“å‰åŠ¨ä½œä¸æ˜¯å–‚é£Ÿï¼Œåˆ™é‡ç½®å–‚é£Ÿè®¡æ•°å™¨
            if (currentAction !== 'feed') cat.consecutiveFullFeeds = 0;
            // å¦‚æœå½“å‰åŠ¨ä½œä¸æ˜¯æ¸…æ´ï¼Œåˆ™é‡ç½®æ¸…æ´è®¡æ•°å™¨
            if (currentAction !== 'clean') cat.consecutiveFullCleans = 0;
            // å¦‚æœå½“å‰åŠ¨ä½œä¸æ˜¯ä¼‘æ¯ï¼Œåˆ™é‡ç½®ä¼‘æ¯è®¡æ•°å™¨
            if (currentAction !== 'rest') cat.consecutiveFullRests = 0;
            // å¦‚æœå½“å‰åŠ¨ä½œä¸æ˜¯ç©è€ï¼Œåˆ™é‡ç½®ç©è€è®¡æ•°å™¨
            if (currentAction !== 'play') cat.consecutiveFullPlays = 0;
            // æ³¨æ„ï¼šæŠšæ‘¸å’Œæ”¹åç­‰åŠ¨ä½œä¹Ÿä¼šé‡ç½®æ‰€æœ‰è®¡æ•°å™¨ï¼Œå› ä¸ºå®ƒä»¬ä¸å±äºä¸Šè¿°å››ç§â€œè¿‡åº¦â€æ“ä½œ
        }

        // --- ç©å®¶åŠ¨ä½œ ---
        function feedCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('feed'); // é‡ç½®å…¶ä»–è®¡æ•°å™¨

            if (cat.hunger >= 100) {
                cat.consecutiveFullFeeds++; // é¥±è…¹çŠ¶æ€ä¸‹è¿ç»­å–‚é£Ÿæ¬¡æ•°å¢åŠ 
                if (cat.consecutiveFullFeeds >= 5) {
                    cat.isAlive = false;
                    cat.life = 0;
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} å·²ç»æ’‘æ­»äº†ï¼ä½ è¿ç»­å–‚é£Ÿäº†å®ƒ${cat.consecutiveFullFeeds}æ¬¡ï¼Œå®ƒæ— æ³•æ‰¿å—äº†...`, 'game-over');
                    endGame();
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} å·²ç»å¾ˆé¥±äº†ï¼Œä¸éœ€è¦å†å–‚äº†ï¼ä½ å·²ç»è¿ç»­å–‚é£Ÿäº†å®ƒ${cat.consecutiveFullFeeds}æ¬¡ã€‚`, 'warning');
                    saveGameState(); // å³ä½¿æ²¡æœ‰å®é™…å–‚é£Ÿï¼Œä¹Ÿä¿å­˜è®¡æ•°å™¨
                    return;
                }
            }

            // æ­£å¸¸å–‚é£Ÿé€»è¾‘
            cat.hunger = Math.min(100, cat.hunger + 30);
            cat.happiness = Math.min(100, cat.happiness + 10);
            cat.life = Math.min(100, cat.life + 5);
            cat.lastFedTime = new Date();
            cat.gold += 5; // æ¯æ¬¡å–‚é£Ÿè·å¾—5é‡‘å¸
            cat.consecutiveFullFeeds = 0; // æ­£å¸¸å–‚é£Ÿåé‡ç½®è®¡æ•°å™¨
            updateCatStatsDisplay();
            displayMessage(`ä½ å–‚äº†${cat.name}ï¼Œå®ƒçœ‹èµ·æ¥å¾ˆæ»¡è¶³ï¼è·å¾—äº†5é‡‘å¸ï¼`); // æ›´æ–°æ¶ˆæ¯
            saveGameState();
        }

        function playCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('play'); // é‡ç½®å…¶ä»–è®¡æ•°å™¨

            if (cat.happiness >= 100) {
                cat.consecutiveFullPlays++; // å¹¸ç¦å€¼æ»¡çŠ¶æ€ä¸‹è¿ç»­ç©è€æ¬¡æ•°å¢åŠ 
                if (cat.consecutiveFullPlays >= 10) {
                    cat.happiness = Math.max(0, cat.happiness - 20); // å¹¸ç¦å€¼å‡å°‘
                    cat.energy = Math.max(0, cat.energy - 30);     // ç²¾åŠ›å€¼å‡å°‘
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} ç©å¾—å¤ªç´¯äº†ï¼Œå®ƒæ„Ÿåˆ°åŒçƒ¦å’Œç–²æƒ«ï¼å¹¸ç¦å€¼å’Œç²¾åŠ›å€¼å¤§å¹…ä¸‹é™ï¼`, 'warning');
                    checkGameEndConditions(); // æ£€æŸ¥æ˜¯å¦å› æƒ©ç½šå¯¼è‡´æ¸¸æˆç»“æŸ
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} å·²ç»ç©å¾—å¾ˆå¼€å¿ƒäº†ï¼å†ç©ä¸‹å»å®ƒä¼šç´¯çš„ã€‚ä½ å·²ç»è¿ç»­ç©è€äº†${cat.consecutiveFullPlays}æ¬¡ã€‚`, 'warning');
                    saveGameState();
                    return;
                }
            }
            if (cat.energy <= 0) { displayMessage(`${cat.name} å¤ªç´¯äº†ï¼Œæ²¡æœ‰ç²¾åŠ›ç©è€ï¼`); saveGameState(); return; }

            // æ­£å¸¸ç©è€é€»è¾‘
            cat.happiness = Math.min(100, cat.happiness + 35);
            cat.hunger = Math.max(0, cat.hunger - 15);
            cat.life = Math.min(100, cat.life + 3);
            cat.energy = Math.max(0, cat.energy - 25);
            cat.lastPlayedAt = new Date().toISOString();
            cat.gold += 10; // æ¯æ¬¡ç©è€è·å¾—10é‡‘å¸
            cat.consecutiveFullPlays = 0; // æ­£å¸¸ç©è€åé‡ç½®è®¡æ•°å™¨
            updateCatStatsDisplay();
            displayMessage(`ä½ å’Œ${cat.name}ç©è€äº†ä¸€ä¼šå„¿ï¼Œå®ƒå¾ˆå¼€å¿ƒï¼è·å¾—äº†10é‡‘å¸ï¼`); // æ›´æ–°æ¶ˆæ¯
            saveGameState();
        }

        function petCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('pet'); // é‡ç½®æ‰€æœ‰è®¡æ•°å™¨

            if (cat.happiness >= 90) { displayMessage(`${cat.name} å·²ç»å¾ˆäº«å—äº†ï¼`); saveGameState(); return; }
            cat.happiness = Math.min(100, cat.happiness + 20);
            cat.gold += 3; // æ¯æ¬¡æŠšæ‘¸è·å¾—3é‡‘å¸
            updateCatStatsDisplay();
            displayMessage(`ä½ è½»è½»æŠšæ‘¸äº†${cat.name}ï¼Œå®ƒå‘å‡ºäº†å’•å™œå£°ã€‚è·å¾—äº†3é‡‘å¸ï¼`); // æ›´æ–°æ¶ˆæ¯
            saveGameState();
        }

        function cleanCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('clean'); // é‡ç½®å…¶ä»–è®¡æ•°å™¨

            if (cat.cleanliness >= 100) {
                cat.consecutiveFullCleans++; // æ¸…æ´å€¼æ»¡çŠ¶æ€ä¸‹è¿ç»­æ¸…æ´æ¬¡æ•°å¢åŠ 
                if (cat.consecutiveFullCleans >= 3) {
                    cat.life = Math.max(0, cat.life - 10);     // ç”Ÿå‘½å€¼å‡å°‘
                    cat.happiness = Math.max(0, cat.happiness - 5); // å¹¸ç¦å€¼å‡å°‘
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} æ„Ÿå†’äº†ï¼ä½ è¿ç»­æ¸…æ´äº†å®ƒ${cat.consecutiveFullCleans}æ¬¡ï¼Œå®ƒç€å‡‰äº†ï¼ç”Ÿå‘½å€¼å’Œå¹¸ç¦å€¼ä¸‹é™ï¼`, 'warning');
                    checkGameEndConditions(); // æ£€æŸ¥æ˜¯å¦å› æƒ©ç½šå¯¼è‡´æ¸¸æˆç»“æŸ
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} å·²ç»å¾ˆå¹²å‡€äº†ï¼Œä¸éœ€è¦æ¸…æ´ï¼ä½ å·²ç»è¿ç»­æ¸…æ´äº†å®ƒ${cat.consecutiveFullCleans}æ¬¡ã€‚`, 'warning');
                    saveGameState();
                    return;
                }
            }

            // æ­£å¸¸æ¸…æ´é€»è¾‘
            cat.cleanliness = Math.min(100, cat.cleanliness + 40);
            cat.happiness = Math.min(100, cat.happiness + 5);
            cat.gold += 8; // æ¯æ¬¡æ¸…æ´è·å¾—8é‡‘å¸
            cat.consecutiveFullCleans = 0; // æ­£å¸¸æ¸…æ´åé‡ç½®è®¡æ•°å™¨
            updateCatStatsDisplay();
            displayMessage(`ä½ ç»™${cat.name}æ¸…æ´äº†èº«ä½“ï¼Œå®ƒå˜å¾—æ›´å¹²å‡€äº†ï¼è·å¾—äº†8é‡‘å¸ï¼`); // æ›´æ–°æ¶ˆæ¯
            saveGameState();
        }

        // æ–°å¢ï¼šä¼‘æ¯ï¼ˆæ‰‹åŠ¨æ¢å¤ç²¾åŠ›ï¼‰
        function restCat() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('rest'); // é‡ç½®å…¶ä»–è®¡æ•°å™¨

            if (cat.energy >= 100) {
                cat.consecutiveFullRests++; // ç²¾åŠ›å€¼æ»¡çŠ¶æ€ä¸‹è¿ç»­ä¼‘æ¯æ¬¡æ•°å¢åŠ 
                if (cat.consecutiveFullRests >= 5) {
                    cat.life = Math.max(0, cat.life - 15);     // ç”Ÿå‘½å€¼å‡å°‘
                    cat.happiness = Math.max(0, cat.happiness - 10); // å¹¸ç¦å€¼å‡å°‘
                    updateCatStatsDisplay();
                    displayMessage(`${cat.name} ç¡å¾—å¤´æ™•çœ¼èŠ±ï¼ä½ è¿ç»­è®©å®ƒä¼‘æ¯äº†${cat.consecutiveFullRests}æ¬¡ï¼Œå®ƒæ„Ÿåˆ°ä¸é€‚ï¼ç”Ÿå‘½å€¼å’Œå¹¸ç¦å€¼ä¸‹é™ï¼`, 'warning');
                    checkGameEndConditions(); // æ£€æŸ¥æ˜¯å¦å› æƒ©ç½šå¯¼è‡´æ¸¸æˆç»“æŸ
                    saveGameState();
                    return;
                } else {
                    displayMessage(`${cat.name} ç²¾åŠ›å·²ç»æ»¡æ»¡çš„ï¼å†ä¼‘æ¯ä¸‹å»ä¼šå¤´æ™•çš„ã€‚ä½ å·²ç»è¿ç»­ä¼‘æ¯äº†${cat.consecutiveFullRests}æ¬¡ã€‚`, 'warning');
                    saveGameState();
                    return;
                }
            }

            // æ­£å¸¸ä¼‘æ¯é€»è¾‘
            cat.energy = Math.min(100, cat.energy + 30);
            // ä¼‘æ¯ç•¥å¾®é™ä½é¥¥é¥¿ï¼Œé¿å…æ— é™å †å 
            cat.hunger = Math.max(0, cat.hunger - 5);
            cat.happiness = Math.min(100, cat.happiness + 5);
            cat.gold += 5; // æ¯æ¬¡ä¼‘æ¯è·å¾—5é‡‘å¸
            cat.consecutiveFullRests = 0; // æ­£å¸¸ä¼‘æ¯åé‡ç½®è®¡æ•°å™¨
            updateCatStatsDisplay();
            displayMessage(`${cat.name} ä¼‘æ¯äº†ä¸€ä¼šå„¿ï¼Œç²¾ç¥å¥½å¤šäº†ï½è·å¾—äº†5é‡‘å¸ï¼`); // æ›´æ–°æ¶ˆæ¯
            saveGameState();
        }

        // æ–°å¢ï¼šé‡æ–°é¢†å…»çŒ«å’ª
        function reAdoptCat() {
            if (!confirm('ç¡®å®šè¦é‡æ–°é¢†å…»ä¸€åªæ–°çŒ«å’ªå—ï¼Ÿæ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬é‡‘å¸å’ŒèƒŒåŒ…ï¼‰éƒ½å°†æ¸…é›¶ï¼')) {
                return;
            }

            // é‡ç½®æ‰€æœ‰çŒ«å’ªçŠ¶æ€ä¸ºåˆå§‹å€¼
            cat = {
                hunger: 50,
                happiness: 50,
                life: 100,
                isAlive: true,
                isRunAway: false,
                lastUpdateTime: new Date(),
                lastFedTime: new Date(),
                cleanliness: 100,
                energy: 100,
                name: DEFAULT_CAT_NAME,
                gold: 0, // é‡‘å¸ä¹Ÿæ¸…é›¶
                consecutiveFullFeeds: 0,
                consecutiveFullCleans: 0,
                consecutiveFullRests: 0,
                consecutiveFullPlays: 0,
                inventory: [], // èƒŒåŒ…æ¸…ç©º
                equippedCosmeticId: null, // å·²è£…å¤‡æ—¶è£…æ¸…ç©º
            };

            localStorage.removeItem(GAME_STATE_KEY); // æ¸…é™¤æ—§å­˜æ¡£
            localStorage.removeItem(LAST_VIEWED_KEY); // æ¸…é™¤ä¸Šæ¬¡æŸ¥çœ‹æ—¶é—´
            localStorage.removeItem(CUSTOM_CAT_IMAGE_KEY); // æ¸…é™¤è‡ªå®šä¹‰çŒ«å’ªå›¾ç‰‡
            
            // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
            initializeGame();
            displayMessage(`ä½ é¢†å…»äº†ä¸€åªæ–°çš„${cat.name}ï¼`);
        }

        // æ–°å¢ï¼šå¤æ´»çŒ«å’ª
        function reviveCat() {
            const REVIVE_COST = 100;
            if (cat.gold < REVIVE_COST) {
                displayMessage(`é‡‘å¸ä¸è¶³ï¼Œæ— æ³•å¤æ´»${cat.name}ï¼éœ€è¦${REVIVE_COST}é‡‘å¸ã€‚`, 'warning');
                return;
            }
            if (!confirm(`ç¡®å®šè¦èŠ±è´¹${REVIVE_COST}é‡‘å¸å¤æ´»${cat.name}å—ï¼Ÿ`)) {
                return;
            }

            cat.gold -= REVIVE_COST; // æ‰£é™¤é‡‘å¸
            cat.life = 100;          // ç”Ÿå‘½å€¼åŠ æ»¡
            cat.isAlive = true;      // æ ‡è®°ä¸ºå­˜æ´»
            cat.isRunAway = false;   // æ ‡è®°ä¸ºæœªç¦»å®¶å‡ºèµ°
            cat.lastUpdateTime = new Date(); // æ›´æ–°æ—¶é—´ï¼Œé¿å…ç¦»çº¿è¡°å‡ç«‹å³ç”Ÿæ•ˆ
            cat.lastFedTime = new Date();    // é‡ç½®å–‚é£Ÿæ—¶é—´ï¼Œé¿å…ç«‹å³é¥¿æ­»

            // é‡ç½®è¿ç»­æ“ä½œè®¡æ•°å™¨ï¼Œé¿å…å¤æ´»åç«‹å³è§¦å‘æƒ©ç½š
            cat.consecutiveFullFeeds = 0;
            cat.consecutiveFullCleans = 0;
            cat.consecutiveFullRests = 0;
            cat.consecutiveFullPlays = 0;

            // é‡æ–°åˆå§‹åŒ–æ¸¸æˆï¼ˆä¼šé‡æ–°å¯ç”¨æŒ‰é’®ï¼Œéšè—æ¸¸æˆç»“æŸæ“ä½œï¼‰
            initializeGame();
            displayMessage(`ä½ èŠ±è´¹äº†${REVIVE_COST}é‡‘å¸å¤æ´»äº†${cat.name}ï¼å®ƒåˆæ´»è¹¦ä¹±è·³äº†ï¼`);
        }

        // --- è‡ªåŠ¨ä¸‹é™çŠ¶æ€ï¼ˆæ¨¡æ‹Ÿæ—¶é—´æµé€ï¼‰---
        let hungerDeclineTick = 0;
        let happinessDeclineTick = 0;
        let lifeDeclineTick = 0;
        let cleanlinessDeclineTick = 0;
        let energyDeclineTick = 0;
        let energyRecoverTick = 0;

        function autoDeclineStats() {
            if (!cat.isAlive || cat.isRunAway) return; // æ¸¸æˆç»“æŸåˆ™åœæ­¢ä¸‹é™
            const now = new Date();
            const currentHour = now.getHours();

            // é¥¥é¥¿åº¦ä¸‹é™
            hungerDeclineTick++;
            let hungerRate = HUNGER_DECLINE_SECONDS_NORMAL;
            if ((currentHour >= MORNING_START_HOUR && currentHour < MORNING_END_HOUR) ||
                (currentHour >= NOON_START_HOUR && currentHour < NOON_END_HOUR) ||
                (currentHour >= EVENING_START_HOUR && currentHour < EVENING_END_HOUR)) {
                hungerRate /= HUNGER_ACCELERATED_MULTIPLIER;
            }
            if (hungerDeclineTick >= hungerRate) { cat.hunger = Math.max(0, cat.hunger - 1); hungerDeclineTick = 0; }

            // æ¸…æ´åº¦ä¸‹é™
            cleanlinessDeclineTick++;
            if (cleanlinessDeclineTick >= CLEANLINESS_DECLINE_SECONDS_NORMAL) { cat.cleanliness = Math.max(0, cat.cleanliness - 1); cleanlinessDeclineTick = 0; }

            // ç²¾åŠ›ä¸‹é™ï¼ˆè¢«åŠ¨ï¼‰
            energyDeclineTick++;
            if (energyDeclineTick >= ENERGY_DECLINE_SECONDS_NORMAL) { cat.energy = Math.max(0, cat.energy - 1); energyDeclineTick = 0; }

            // ç©ºé—²è‡ªåŠ¨ç²¾åŠ›æ¢å¤ï¼ˆä¸åœ¨ç©è€çš„ç¬æ—¶ï¼Œä¸é¡¶æ ¼ï¼‰
            energyRecoverTick++;
            if (cat.energy < 100 && energyRecoverTick >= ENERGY_RECOVER_SECONDS_IDLE) {
                cat.energy = Math.min(100, cat.energy + 1);
                energyRecoverTick = 0;
            }

            // å¹¸ç¦åº¦ä¸‹é™ï¼ˆå—å¤šå› ç´ å½±å“ï¼‰
            let happinessFactors = 0;
            if (cat.hunger < 50) happinessFactors++;
            if (cat.life < 50) happinessFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) happinessFactors++;
            if (cat.energy < ENERGY_LOW_THRESHOLD) happinessFactors++;
            if (happinessFactors > 0) {
                happinessDeclineTick++;
                const happinessRate = HAPPINESS_DECLINE_SECONDS_NORMAL / (1 + happinessFactors * 0.5);
                if (happinessDeclineTick >= happinessRate) { cat.happiness = Math.max(0, cat.happiness - 1); happinessDeclineTick = 0; }
            } else {
                happinessDeclineTick = 0;
            }

            // ç”Ÿå‘½å€¼ä¸‹é™ï¼ˆå—å¤šå› ç´ å½±å“ï¼‰
            let lifeFactors = 0;
            if (cat.hunger < 50) lifeFactors++;
            if (cat.happiness < 50) lifeFactors++;
            if (cat.cleanliness < CLEANLINESS_LOW_THRESHOLD) lifeFactors++;
            if (lifeFactors > 0) {
                lifeDeclineTick++;
                const lifeRate = LIFE_DECLINE_SECONDS_NORMAL / (1 + lifeFactors * 0.5);
                if (lifeDeclineTick >= lifeRate) { cat.life = Math.max(0, cat.life - 1); lifeDeclineTick = 0; }
            } else {
                lifeDeclineTick = 0;
            }

            updateCatStatsDisplay();
            checkGameEndConditions();
        }

        // --- å®æ—¶æ—¶é’Ÿ ---
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            realTimeClockDiv.textContent = `${h}:${m}:${s}`;
        }

        // --- ä¸Šæ¬¡æŸ¥çœ‹æ—¶é—´ ---
        function saveCurrentTimeAsLastViewed() {
            const now = new Date();
            localStorage.setItem(LAST_VIEWED_KEY, now.toISOString());
        }

        function loadAndDisplayLastViewedTime() {
            const t = localStorage.getItem(LAST_VIEWED_KEY);
            if (t) {
                const d = new Date(t);
                lastViewedExactTimeSpan.textContent = d.toLocaleString();

                const now = new Date();
                const elapsedMs = now.getTime() - d.getTime();
                const elapsedSeconds = Math.floor(elapsedMs / 1000);

                let durationText = '';
                if (elapsedSeconds < 60) {
                    durationText = `${elapsedSeconds}ç§’å‰`;
                } else if (elapsedSeconds < 3600) {
                    const minutes = Math.floor(elapsedSeconds / 60);
                    durationText = `${minutes}åˆ†é’Ÿå‰`;
                } else if (elapsedSeconds < 86400) {
                    const hours = Math.floor(elapsedSeconds / 3600);
                    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
                    durationText = `${hours}å°æ—¶${minutes}åˆ†é’Ÿå‰`;
                } else {
                    const days = Math.floor(elapsedSeconds / 86400);
                    const hours = Math.floor((elapsedSeconds % 86400) / 3600);
                    durationText = `${days}å¤©${hours}å°æ—¶å‰`;
                }
                timeSinceLastViewedSpan.textContent = `(${durationText})`;
            } else {
                lastViewedExactTimeSpan.textContent = 'é¦–æ¬¡è®¿é—®';
                timeSinceLastViewedSpan.textContent = '';
            }
        }

        // --- ç»Ÿä¸€çš„æ¸¸æˆå¾ªç¯ ---
        let gameLoopInterval = null;
        function gameLoop() {
            autoDeclineStats();
            updateClock();
            // ç§»é™¤ loadAndDisplayLastViewedTime()ï¼Œä½¿å…¶åªåœ¨é¡µé¢åŠ è½½æ—¶è®¡ç®—ä¸€æ¬¡
            if (new Date().getSeconds() === 0) saveGameState(); // æ¯åˆ†é’Ÿä¿å­˜ä¸€æ¬¡
        }

        // --- ä¿®æ”¹åå­— ---
        function changeCatName() {
            if (!cat.isAlive || cat.isRunAway) return;
            resetConsecutiveCounters('changeName'); // é‡ç½®æ‰€æœ‰è®¡æ•°å™¨

            let newName = prompt(`è¯·è¾“å…¥${cat.name}çš„æ–°åå­— (å½“å‰åå­—: ${cat.name})ï¼š`);
            if (newName === null) return;
            newName = newName.trim();
            if (newName === '') { displayMessage('åå­—ä¸èƒ½ä¸ºç©ºï¼'); return; }
            if (newName.length > 10) { displayMessage('åå­—å¤ªé•¿äº†ï¼Œè¯·é™åˆ¶åœ¨10ä¸ªå­—ç¬¦ä»¥å†…ã€‚'); return; }
            cat.name = newName;
            updateCatStatsDisplay();
            displayMessage(`ä½ çš„çŒ«å’ªç°åœ¨å« ${cat.name} äº†ï¼`);
            saveGameState();
        }

        // --- èƒŒåŒ…åŠŸèƒ½ ---

        // æ›´æ–°çŒ«å’ªå›¾ç‰‡ï¼ˆæ ¹æ®æ˜¯å¦è£…å¤‡æ—¶è£…ï¼‰
        function updateCatImage() {
            // 1. å°è¯•åŠ è½½è‡ªå®šä¹‰å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å›¾ç‰‡
            const customImage = localStorage.getItem(CUSTOM_CAT_IMAGE_KEY);
            if (customImage) {
                baseCatImageElement.src = customImage;
            } else {
                baseCatImageElement.src = DEFAULT_CAT_IMAGE_SRC;
            }

            // 2. æ¸…é™¤æ‰€æœ‰æ—§çš„æ—¶è£…å›¾ç‰‡
            // éå† catImageContainerElement çš„æ‰€æœ‰å­å…ƒç´ ï¼Œç§»é™¤é™¤äº† baseCatImageElement ä¹‹å¤–çš„
            Array.from(catImageContainerElement.children).forEach(child => {
                if (child !== baseCatImageElement) {
                    catImageContainerElement.removeChild(child);
                }
            });

            // 3. å¦‚æœæœ‰è£…å¤‡çš„æ—¶è£…ï¼Œåˆ™æ·»åŠ æ–°çš„æ—¶è£…å›¾ç‰‡
            if (cat.equippedCosmeticId && ITEM_DEFINITIONS[cat.equippedCosmeticId]) {
                const cosmeticDef = ITEM_DEFINITIONS[cat.equippedCosmeticId];
                const cosmeticImage = document.createElement('img');
                cosmeticImage.src = cosmeticDef.image;
                cosmeticImage.alt = cosmeticDef.name;
                cosmeticImage.className = 'equipped-cosmetic'; // åº”ç”¨æ—¶è£…æ ·å¼
                catImageContainerElement.appendChild(cosmeticImage);
            }
        }

        // æ·»åŠ ç‰©å“åˆ°èƒŒåŒ… (ä¾›å•†åº—æˆ–æµ‹è¯•ä½¿ç”¨)
        function addItemToInventory(itemId, quantity = 1) {
            const itemDef = ITEM_DEFINITIONS[itemId];
            if (!itemDef) {
                console.warn(`Item ID ${itemId} not found in ITEM_DEFINITIONS.`);
                return;
            }

            const existingItemIndex = cat.inventory.findIndex(item => item.id === itemId);

            if (itemDef.type === 'consumable') {
                if (existingItemIndex !== -1) {
                    cat.inventory[existingItemIndex].quantity += quantity;
                } else {
                    cat.inventory.push({ id: itemId, quantity: quantity });
                }
            } else if (itemDef.type === 'cosmetic') {
                // æ—¶è£…ç‰©å“æ˜¯å”¯ä¸€çš„ï¼ŒèƒŒåŒ…ä¸­ä¸å åŠ æ•°é‡
                if (existingItemIndex === -1) {
                    cat.inventory.push({ id: itemId, quantity: 1 }); // æ•°é‡ä¸º1è¡¨ç¤ºæ‹¥æœ‰
                } else {
                    displayMessage(`${itemDef.name} å·²ç»æ‹¥æœ‰äº†ï¼`, 'warning');
                    return;
                }
            }
            displayMessage(`è·å¾—äº† ${itemDef.name} x${quantity}ï¼`);
            saveGameState();
        }

        // åˆ‡æ¢é“å…·æè¿°çš„å±•å¼€/æŠ˜å çŠ¶æ€
        function toggleDescription(event) {
            const wrapper = event.currentTarget;
            wrapper.classList.toggle('expanded');
        }

        // æ‰“å¼€èƒŒåŒ…æ¨¡æ€æ¡†
        function openBackpack() {
            if (!cat.isAlive || cat.isRunAway) return;

            consumableItemsContainer.innerHTML = '';
            cosmeticItemsContainer.innerHTML = '';

            let hasConsumables = false;
            let hasCosmetics = false;

            cat.inventory.forEach(item => {
                const itemDef = ITEM_DEFINITIONS[item.id];
                if (!itemDef) return; // è·³è¿‡æœªçŸ¥ç‰©å“

                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';

                const itemImage = document.createElement('img');
                itemImage.src = itemDef.image || 'https://i.imgur.com/placeholder.png'; // ç‰©å“å›¾ç‰‡ï¼Œæ²¡æœ‰åˆ™ç”¨å ä½å›¾
                itemImage.alt = itemDef.name;
                itemDiv.appendChild(itemImage);

                const itemName = document.createElement('h4');
                itemName.textContent = itemDef.name;
                itemDiv.appendChild(itemName);

                // æ–°å¢ï¼šå¯æŠ˜å çš„æè¿°
                const itemDescWrapper = document.createElement('div');
                itemDescWrapper.className = 'item-description-wrapper';
                itemDescWrapper.addEventListener('click', toggleDescription);

                const shortDesc = document.createElement('span');
                shortDesc.className = 'short-desc';
                // ä¿®æ”¹ï¼šåªæ˜¾ç¤ºå‰ä¸‰ä¸ªå­—
                shortDesc.textContent = itemDef.description.substring(0, 3) + (itemDef.description.length > 3 ? '' : ''); 
                itemDescWrapper.appendChild(shortDesc);

                const fullDesc = document.createElement('span');
                fullDesc.className = 'full-desc';
                fullDesc.textContent = itemDef.description;
                itemDescWrapper.appendChild(fullDesc);
                
                itemDiv.appendChild(itemDescWrapper);


                if (itemDef.type === 'consumable') {
                    hasConsumables = true;
                    const itemQuantity = document.createElement('p');
                    itemQuantity.className = 'item-quantity'; // æ·»åŠ ç±»å
                    itemQuantity.textContent = `æ•°é‡: ${item.quantity}`;
                    itemDiv.appendChild(itemQuantity);

                    const useButton = document.createElement('button');
                    useButton.textContent = 'ä½¿ç”¨';
                    useButton.onclick = () => useItem(item.id);
                    itemDiv.appendChild(useButton);
                    consumableItemsContainer.appendChild(itemDiv);
                } else if (itemDef.type === 'cosmetic') {
                    hasCosmetics = true;
                    const equipButton = document.createElement('button');
                    const isEquipped = (cat.equippedCosmeticId === item.id);
                    equipButton.textContent = isEquipped ? 'å¸ä¸‹' : 'è£…å¤‡';
                    equipButton.className = isEquipped ? 'unequip' : ''; // æ·»åŠ æ ·å¼ç±»
                    if (isEquipped) equipButton.classList.add('equipped'); // æ·»åŠ å·²è£…å¤‡æ ·å¼
                    equipButton.onclick = () => toggleEquipItem(item.id);
                    itemDiv.appendChild(equipButton);
                    cosmeticItemsContainer.appendChild(itemDiv);
                }
            });

            noConsumablesMessage.style.display = hasConsumables ? 'none' : 'block';
            noCosmeticsMessage.style.display = hasCosmetics ? 'none' : 'block';

            backpackModal.style.display = 'block';
        }

        // ä½¿ç”¨ç‰©å“ç±»é“å…·
        function useItem(itemId) {
            const itemIndex = cat.inventory.findIndex(item => item.id === itemId);
            if (itemIndex === -1) {
                displayMessage('ç‰©å“ä¸å­˜åœ¨ï¼', 'warning');
                return;
            }

            const item = cat.inventory[itemIndex];
            const itemDef = ITEM_DEFINITIONS[item.id];

            if (itemDef.type !== 'consumable') {
                displayMessage('è¿™ä¸æ˜¯ä¸€ä¸ªå¯æ¶ˆè€—ç‰©å“ï¼', 'warning');
                return;
            }

            // åº”ç”¨æ•ˆæœ
            if (itemDef.effect) {
                if (typeof itemDef.effect.hunger !== 'undefined') cat.hunger = Math.min(100, Math.max(0, cat.hunger + itemDef.effect.hunger));
                if (typeof itemDef.effect.happiness !== 'undefined') cat.happiness = Math.min(100, Math.max(0, cat.happiness + itemDef.effect.happiness));
                if (typeof itemDef.effect.life !== 'undefined') cat.life = Math.min(100, Math.max(0, cat.life + itemDef.effect.life));
                if (typeof itemDef.effect.cleanliness !== 'undefined') cat.cleanliness = Math.min(100, Math.max(0, cat.cleanliness + itemDef.effect.cleanliness));
                if (typeof itemDef.effect.energy !== 'undefined') cat.energy = Math.min(100, Math.max(0, cat.energy + itemDef.effect.energy));
            }

            item.quantity--;
            if (item.quantity <= 0) {
                cat.inventory.splice(itemIndex, 1); // æ•°é‡ä¸º0æ—¶ç§»é™¤ç‰©å“
            }

            updateCatStatsDisplay();
            displayMessage(`ä½¿ç”¨äº† ${itemDef.name}ï¼`);
            saveGameState();
            openBackpack(); // é‡æ–°æ¸²æŸ“èƒŒåŒ…ä»¥æ˜¾ç¤ºæ›´æ–°åçš„æ•°é‡/ç§»é™¤çš„ç‰©å“
        }

        // è£…å¤‡/å¸ä¸‹æ—¶è£…ç±»é“å…·
        function toggleEquipItem(itemId) {
            const itemDef = ITEM_DEFINITIONS[itemId];
            if (!itemDef || itemDef.type !== 'cosmetic') {
                displayMessage('è¿™ä¸æ˜¯ä¸€ä¸ªæ—¶è£…ç‰©å“ï¼', 'warning');
                return;
            }

            if (cat.equippedCosmeticId === itemId) {
                // å¸ä¸‹
                cat.equippedCosmeticId = null;
                displayMessage(`å¸ä¸‹äº† ${itemDef.name}ã€‚`);
            } else {
                // è£…å¤‡
                cat.equippedCosmeticId = itemId;
                displayMessage(`è£…å¤‡äº† ${itemDef.name}ï¼`);
            }

            updateCatImage(); // æ›´æ–°çŒ«å’ªå›¾ç‰‡
            saveGameState();
            openBackpack(); // é‡æ–°æ¸²æŸ“èƒŒåŒ…ä»¥æ˜¾ç¤ºæ›´æ–°åçš„è£…å¤‡çŠ¶æ€
        }

        // --- åˆå§‹åŒ– ---
        function initializeGame() {
            loadGameState();
            if (!cat.name) cat.name = DEFAULT_CAT_NAME;
            applyOfflineDecay(); // å…ˆåº”ç”¨ç¦»çº¿è¡°å‡ï¼Œç¡®ä¿çŒ«å’ªçŠ¶æ€æ˜¯æœ€æ–°çš„

            updateCatImage(); // æ ¹æ®å·²è£…å¤‡æ—¶è£…å’Œè‡ªå®šä¹‰å›¾ç‰‡æ›´æ–°çŒ«å’ªå›¾ç‰‡

            // UI Reset to "game in progress" state
            gameOverActionsDiv.style.display = 'none';
            feedBtn.disabled = false;
            playBtn.disabled = false;
            petBtn.disabled = false;
            cleanBtn.disabled = false;
            restBtn.disabled = false;
            changeNameBtn.disabled = false;
            shopBtn.disabled = false;
            gameBtn.disabled = false;
            backpackBtn.disabled = false; // å¯ç”¨èƒŒåŒ…æŒ‰é’®

            updateCatStatsDisplay();
            updateClock();
            loadAndDisplayLastViewedTime(); // ä»…åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡

            // ç°åœ¨ï¼Œæ ¹æ®çŒ«å’ªçš„æœ€ç»ˆçŠ¶æ€æ¥å†³å®šæ˜¯å¦è¿›å…¥æ¸¸æˆç»“æŸæ¨¡å¼
            if (!cat.isAlive || cat.isRunAway) { // å¦‚æœçŒ«å’ªå·²ç»æ­»äº¡æˆ–ç¦»å®¶å‡ºèµ°
                displayMessage(`${cat.name} ${cat.isAlive ? 'å·²ç»ç¦»å®¶å‡ºèµ°äº†' : 'å·²ç»æ­»äº¡äº†'}...`, 'game-over');
                endGame(); // è°ƒç”¨ endGame æ¥æ˜¾ç¤ºå¤æ´»/é‡æ–°é¢†å…»æŒ‰é’®ï¼Œå¹¶ç¦ç”¨æ“ä½œæŒ‰é’®
                return; // é˜»æ­¢æ¸¸æˆå¾ªç¯å¯åŠ¨
            }

            // ç¡®ä¿åªå¯åŠ¨ä¸€æ¬¡æ¸¸æˆå¾ªç¯
            if (!gameLoopInterval) {
                gameLoopInterval = setInterval(gameLoop, 1000);
            }

            // é¦–æ¬¡è¿›å…¥æ¸¸æˆæ—¶ï¼Œå¦‚æœèƒŒåŒ…ä¸ºç©ºï¼Œè‡ªåŠ¨æ·»åŠ ä¸€äº›æµ‹è¯•é“å…·
            if (cat.inventory.length === 0) {
                addItemToInventory('small_food_can', 3);
                addItemToInventory('big_food_can', 1);
                addItemToInventory('toy_mouse', 2);
                addItemToInventory('cat_shampoo', 1);
                addItemToInventory('energy_drink', 1);
                addItemToInventory('straw_hat', 1);
                addItemToInventory('glasses', 1);
                addItemToInventory('scarf', 1);
                // æ–°å¢çš„æµ‹è¯•é“å…·
                addItemToInventory('teasing_stick', 1);
                addItemToInventory('catnip', 1);
                addItemToInventory('electric_mouse', 1);
                addItemToInventory('maid_outfit', 1);
                addItemToInventory('butler_outfit', 1);
                addItemToInventory('jeans', 1);
                addItemToInventory('dress', 1);
                addItemToInventory('suit', 1);
                saveGameState(); // ä¿å­˜æ·»åŠ é“å…·åçš„çŠ¶æ€
            }
        }

        // --- é¡µé¢äº‹ä»¶ ---
        window.addEventListener('DOMContentLoaded', () => {
            // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œåªåœ¨é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
            feedBtn.addEventListener('click', feedCat);
            playBtn.addEventListener('click', playCat);
            petBtn.addEventListener('click', petCat);
            cleanBtn.addEventListener('click', cleanCat);
            restBtn.addEventListener('click', restCat);
            changeNameBtn.addEventListener('click', changeCatName);
            shopBtn.addEventListener('click', () => {
                window.location.href = 'shop.html'; // è·³è½¬åˆ°å•†åº—é¡µé¢
            });
            gameBtn.addEventListener('click', () => {
                window.location.href = 'game.html'; // è·³è½¬åˆ°å°æ¸¸æˆé¡µé¢
            });
            backpackBtn.addEventListener('click', openBackpack); // èƒŒåŒ…æŒ‰é’®äº‹ä»¶
            
            // é‡æ–°é¢†å…»å’Œå¤æ´»æŒ‰é’®çš„äº‹ä»¶ä¹Ÿåœ¨è¿™é‡Œç»‘å®š
            reAdoptBtn.addEventListener('click', reAdoptCat);
            reviveBtn.addEventListener('click', reviveCat);

            // èƒŒåŒ…æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
            closeBackpackModal.addEventListener('click', () => {
                backpackModal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === backpackModal) {
                    backpackModal.style.display = 'none';
                }
            });

            // çŒ«çŒ«å¤´ç‚¹å‡»äº‹ä»¶ï¼šè§¦å‘æ–‡ä»¶ä¸Šä¼ 
            catHeadEmoji.addEventListener('click', () => {
                imageUpload.click();
            });

            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ï¼šè¯»å–æ–‡ä»¶å¹¶æ›´æ–°çŒ«å’ªå›¾ç‰‡
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Image = e.target.result;
                        baseCatImageElement.src = base64Image;
                        localStorage.setItem(CUSTOM_CAT_IMAGE_KEY, base64Image); // ä¿å­˜ä¸º Base64 å­—ç¬¦ä¸²
                        displayMessage('çŒ«å’ªç…§ç‰‡å·²æ›´æ–°ï¼(å·²ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢åä¾ç„¶æœ‰æ•ˆ)');
                    };
                    reader.readAsDataURL(file); // è¯»å–æ–‡ä»¶ä¸º Base64 å­—ç¬¦ä¸²
                } else {
                    displayMessage('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼', 'warning');
                }
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥å†æ¬¡ä¸Šä¼ ç›¸åŒæ–‡ä»¶
                event.target.value = ''; 
            });
            
            // ç»‘å®šå®Œæ‰€æœ‰äº‹ä»¶åï¼Œåˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
            initializeGame();
        });

        window.addEventListener('beforeunload', () => {
            saveGameState();
            saveCurrentTimeAsLastViewed();
        });
    </script>
</body>
</html>
