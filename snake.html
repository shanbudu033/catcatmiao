<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ªåƒè›‡å°æ¸¸æˆ</title>
    <style>
        /* ç»§æ‰¿ä¸»é¡µé¢çš„å¯çˆ±é£æ ¼ */
        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fdf3f8; /* æŸ”å’Œçš„ç²‰è‰²èƒŒæ™¯ */
            background-image: url('https://www.transparenttextures.com/patterns/light-honeycomb.png');
            color: #555;
            padding: 20px;
            box-sizing: border-box;
            position: relative; /* ç”¨äºå®šä½å¸®åŠ©æŒ‰é’® */
        }
        h1 {
            color: #ff69b4; /* å¯çˆ±çš„çƒ­ç²‰è‰²æ ‡é¢˜ */
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* è¿”å›æ¸¸æˆä¸­å¿ƒæŒ‰é’®çš„æ ·å¼ */
        .back-button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #98fb98; /* æµ…ç»¿è‰²æŒ‰é’® */
            color: #333;
            border: none;
            border-radius: 15px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(152, 251, 152, 0.3);
            margin-top: 30px; /* ä¸æ¸¸æˆåŒºåŸŸä¿æŒè·ç¦» */
        }
        .back-button:hover {
            background-color: #66cd66;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 205, 102, 0.4);
        }
        .back-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(102, 90, 205, 0.3);
        }

        /* è´ªåƒè›‡æ¸¸æˆå®¹å™¨æ ·å¼ */
        #snake-container {
            background-color: #ffffff;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(255, 192, 203, 0.3);
            padding: 30px;
            text-align: center;
            max-width: 500px; /* é€‚åº”æ¸¸æˆæ¿å¤§å° */
            width: 90%;
            margin-bottom: 20px;
            border: 2px solid #ffe4e1;
            position: relative; /* ç”¨äºå®šä½å¸®åŠ©æŒ‰é’® */
        }

        /* æ¸¸æˆåˆ†æ•°æ˜¾ç¤º */
        #score-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff69b4; /* å¯çˆ±çš„ç²‰è‰² */
            margin-bottom: 15px;
            background-color: #fff0f5;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid #ffebf0;
        }

        /* æ¸¸æˆæ¿ç½‘æ ¼æ ·å¼ */
        #game-board {
            display: grid;
            /* grid-template-columns å’Œ grid-template-rows ä¼šç”± JavaScript è®¾ç½® */
            border: 2px solid #ccc;
            margin: 20px auto;
            background-color: #e0ffff; /* æµ…è“è‰²æ¿å­ */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); /* å†…éƒ¨é˜´å½± */
            border-radius: 5px;
        }

        /* ç½‘æ ¼å•å…ƒæ ¼åŸºç¡€æ ·å¼ */
        .grid-cell {
            width: 20px; /* å›ºå®šå•å…ƒæ ¼å¤§å° */
            height: 20px;
            background-color: #e0ffff; /* é»˜è®¤æ¿å­é¢œè‰² */
        }

        /* è›‡èº«ä½“æ ·å¼ */
        .snake-body {
            background-color: #8bc34a; /* ç»¿è‰²è›‡èº« */
            border-radius: 3px; /* ç•¥å¸¦åœ†è§’ */
        }
        /* è›‡å¤´æ ·å¼ */
        .snake-head {
            background-color: #4caf50; /* æ·±ç»¿è‰²è›‡å¤´ */
            border-radius: 50%; /* åœ†å½¢è›‡å¤´ */
        }

        /* é£Ÿç‰©æ ·å¼ */
        .food {
            background-color: #ff5722; /* æ©™è‰²é£Ÿç‰© */
            border-radius: 50%; /* åœ†å½¢é£Ÿç‰© */
        }

        /* æ¸¸æˆæ¶ˆæ¯æ ·å¼ */
        #game-message {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
            color: #ff69b4;
            min-height: 1.5em; /* ç¡®ä¿æ¶ˆæ¯åŒºåŸŸé«˜åº¦ç¨³å®š */
        }
        .message-lose { color: #ff0000; } /* å¤±è´¥æ¶ˆæ¯çº¢è‰² */

        /* å¼€å§‹/é‡æ–°å¼€å§‹æŒ‰é’®æ ·å¼ */
        #start-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #87ceeb; /* å¤©è“è‰² */
            color: white;
            border: none;
            border-radius: 15px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(135, 206, 235, 0.3);
        }
        #start-button:hover {
            background-color: #6a5acd;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 90, 205, 0.4);
        }
        #start-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(106, 90, 205, 0.3);
        }

        /* å¸®åŠ©æŒ‰é’®æ ·å¼ (ä¸æ‰«é›·é¡µé¢ç›¸åŒ) */
        #helpButton {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffebcd; /* æä»è‰² */
            color: #d2691e; /* å·§å…‹åŠ›è‰² */
            border: 2px solid #deb887; /* æ²™æ£•è‰² */
            font-size: 1.8em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s, transform 0.2s;
            z-index: 10; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
        }
        #helpButton:hover {
            background-color: #ffe4b5;
            transform: scale(1.05);
        }

        /* å¸®åŠ©å¡ç‰‡ï¼ˆæ¨¡æ€æ¡†ï¼‰æ ·å¼ (ä¸æ‰«é›·é¡µé¢ç›¸åŒ) */
        #helpModal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            z-index: 100; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            backdrop-filter: blur(5px); /* æ¨¡ç³ŠèƒŒæ™¯ */
            -webkit-backdrop-filter: blur(5px); /* Safari å…¼å®¹ */
            padding-top: 60px;
        }

        .help-modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* å±…ä¸­æ˜¾ç¤º */
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 192, 203, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out; /* å¼¹å‡ºåŠ¨ç”» */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-modal-content h2 {
            color: #ff69b4;
            margin-top: 0;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .help-modal-content p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: left;
        }

        .help-modal-content ul {
            text-align: left;
            margin-bottom: 20px;
            padding-left: 25px;
        }
        .help-modal-content ul li {
            margin-bottom: 8px;
            font-size: 1.05em;
            color: #666;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff69b4;
            text-decoration: none;
            cursor: pointer;
        }

        /* è™šæ‹Ÿæ–¹å‘é”®å®¹å™¨ */
        #controls {
            display: grid;
            grid-template-columns: repeat(3, 60px); /* 3åˆ—ï¼Œæ¯åˆ—60px */
            grid-template-rows: repeat(3, 60px); /* 3è¡Œï¼Œæ¯è¡Œ60px */
            gap: 5px;
            margin-top: 20px;
            width: 185px; /* 3*60 + 2*5 */
            height: 185px;
            justify-content: center;
            align-items: center;
            /* é»˜è®¤éšè—ï¼Œåªåœ¨å°å±å¹•æ˜¾ç¤º */
            display: none;
        }

        .control-button {
            width: 60px;
            height: 60px;
            background-color: #ffb6c1; /* æµ…ç²‰è‰² */
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(255, 182, 193, 0.4);
            transition: background-color 0.2s, transform 0.1s;
            user-select: none; /* é˜²æ­¢æ–‡æœ¬è¢«é€‰ä¸­ */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }
        .control-button:hover {
            background-color: #ff69b4;
            transform: translateY(-2px);
        }
        .control-button:active {
            background-color: #e05090;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(255, 182, 193, 0.4);
        }

        /* è™šæ‹Ÿæ–¹å‘é”®å¸ƒå±€ */
        #up-button { grid-column: 2; grid-row: 1; }
        #left-button { grid-column: 1; grid-row: 2; }
        #right-button { grid-column: 3; grid-row: 2; }
        #down-button { grid-column: 2; grid-row: 3; }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            #snake-container {
                padding: 20px;
                width: 95%; /* é€‚åº”æ›´å°çš„å±å¹• */
            }
            #game-board {
                /* åœ¨å°å±å¹•ä¸Šï¼Œæ¸¸æˆæ¿å¯èƒ½éœ€è¦ç¼©å° */
                /* å‡è®¾ CELL_SIZE ä»ç„¶æ˜¯ 20pxï¼Œé‚£ä¹ˆ BOARD_SIZE * CELL_SIZE = 400px */
                /* å¦‚æœå±å¹•å®½åº¦å°äº 400pxï¼Œæ¸¸æˆæ¿ä¼šæº¢å‡º */
                /* æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® max-width å’Œ height: auto æ¥è®©å®ƒè‡ªé€‚åº” */
                max-width: 100%; /* é™åˆ¶æœ€å¤§å®½åº¦ä¸ºå®¹å™¨çš„100% */
                height: auto; /* é«˜åº¦è‡ªé€‚åº” */
                /* æˆ–è€…ï¼Œå¦‚æœå¸Œæœ›å•å…ƒæ ¼ä¹Ÿç¼©å°ï¼Œéœ€è¦JSåŠ¨æ€è°ƒæ•´CELL_SIZE */
                /* è¿™é‡Œæˆ‘ä»¬å…ˆä¿æŒCELL_SIZEä¸å˜ï¼Œè®©å®¹å™¨è‡ªé€‚åº” */
            }
            /* åœ¨å°å±å¹•ä¸Šæ˜¾ç¤ºè™šæ‹Ÿæ–¹å‘é”® */
            #controls {
                display: grid;
            }
        }
    </style>
</head>
<body>
    <h1>è´ªåƒè›‡å°æ¸¸æˆ</h1>
    <div id="snake-container">
        <!-- å¸®åŠ©æŒ‰é’® -->
        <button id="helpButton">?</button>

        <div id="score-display">åˆ†æ•°: 0</div>
        <div id="game-board"></div>
        <p id="game-message"></p>
        <button id="start-button">å¼€å§‹æ¸¸æˆ</button>

        <!-- è™šæ‹Ÿæ–¹å‘é”® -->
        <div id="controls">
            <button id="up-button" class="control-button">â†‘</button>
            <button id="left-button" class="control-button">â†</button>
            <button id="right-button" class="control-button">â†’</button>
            <button id="down-button" class="control-button">â†“</button>
        </div>
    </div>
    <button onclick="window.location.href='game.html'" class="back-button">è¿”å›æ¸¸æˆä¸­å¿ƒ</button>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div id="helpModal" class="modal">
        <div class="help-modal-content">
            <span class="close-button">&times;</span>
            <h2>è´ªåƒè›‡ç©æ³•è¯´æ˜</h2>
            <p>æ§åˆ¶ä½ çš„å°è›‡åœ¨æ–¹æ ¼ä¸­ç§»åŠ¨ï¼Œåƒæ‰é£Ÿç‰©ï¼Œè®©èº«ä½“å˜é•¿ï¼</p>
            <ul>
                <li><strong>æ§åˆ¶æ–¹å‘ï¼š</strong> ä½¿ç”¨é”®ç›˜çš„ <strong>æ–¹å‘é”® (â†‘ â†“ â† â†’)</strong> æˆ–å±å¹•ä¸‹æ–¹çš„ <strong>è™šæ‹Ÿæ–¹å‘é”®</strong> æ¥æ§åˆ¶è›‡çš„ç§»åŠ¨æ–¹å‘ã€‚</li>
                <li><strong>åƒé£Ÿç‰©ï¼š</strong> å½“è›‡å¤´ç¢°åˆ°é£Ÿç‰© ğŸ æ—¶ï¼Œè›‡ä¼šå˜é•¿ï¼Œä½ çš„åˆ†æ•°ä¼šå¢åŠ ã€‚</li>
                <li><strong>é¿å…ç¢°æ’ï¼š</strong>
                    <ul>
                        <li>ä¸è¦æ’åˆ°æ¸¸æˆæ¿çš„è¾¹ç¼˜ã€‚</li>
                        <li>ä¸è¦æ’åˆ°è‡ªå·±çš„èº«ä½“ã€‚</li>
                    </ul>
                </li>
                <li><strong>æ¸¸æˆç»“æŸï¼š</strong> æ’åˆ°è¾¹ç¼˜æˆ–è‡ªå·±çš„èº«ä½“æ—¶ï¼Œæ¸¸æˆç»“æŸã€‚</li>
                <li><strong>ç›®æ ‡ï¼šï¼š</strong> å°½å¯èƒ½åƒæ‰æ›´å¤šé£Ÿç‰©ï¼Œè·å¾—æ›´é«˜çš„åˆ†æ•°ï¼</li>
            </ul>
            <p>ç¥ä½ å¥½è¿ï¼Œè®©ä½ çš„è›‡å˜å¾—åˆé•¿åˆå£®ï¼</p>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½® ---
        const BOARD_SIZE = 20; // 20x20 çš„æ¸¸æˆæ¿
        const CELL_SIZE = 20; // æ¯ä¸ªå•å…ƒæ ¼çš„åƒç´ å¤§å°
        const INITIAL_SNAKE_LENGTH = 3; // åˆå§‹è›‡çš„é•¿åº¦
        const GAME_SPEED = 150; // æ¸¸æˆæ›´æ–°é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼Œå€¼è¶Šå°è¶Šå¿«ï¼‰
        const GOLD_PER_GAME = 15; // æ¯æ¬¡æ¸¸æˆç»“æŸå¥–åŠ±çš„é‡‘å¸æ•°é‡

        // --- DOM å…ƒç´  ---
        const gameBoard = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score-display');
        const gameMessage = document.getElementById('game-message');
        const startButton = document.getElementById('start-button');
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeButton = document.querySelector('.close-button');

        // è™šæ‹Ÿæ–¹å‘é”®
        const upButton = document.getElementById('up-button');
        const downButton = document.getElementById('down-button');
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');


        // --- æ¸¸æˆçŠ¶æ€å˜é‡ ---
        let snake = []; // å­˜å‚¨è›‡çš„æ¯ä¸ªèº«ä½“èŠ‚æ®µçš„åæ ‡
        let food = {}; // é£Ÿç‰©çš„åæ ‡
        let direction = { x: 1, y: 0 }; // è›‡çš„å½“å‰ç§»åŠ¨æ–¹å‘ (åˆå§‹å‘å³)
        let score = 0; // å½“å‰åˆ†æ•°
        let gameInterval; // æ¸¸æˆå¾ªç¯çš„è®¡æ—¶å™¨
        let isGameOver = false; // æ¸¸æˆæ˜¯å¦ç»“æŸ
        let gameStarted = false; // æ¸¸æˆæ˜¯å¦å·²å¼€å§‹ï¼ˆç”¨äºæ§åˆ¶å¼€å§‹æŒ‰é’®å’Œæ–¹å‘è¾“å…¥ï¼‰
        let changingDirection = false; // é˜²æ­¢åœ¨åŒä¸€å¸§å†…å¤šæ¬¡æ”¹å˜æ–¹å‘

        // --- åˆå§‹åŒ–æ¸¸æˆæ¿çš„ CSS Grid å¸ƒå±€ ---
        gameBoard.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, ${CELL_SIZE}px)`;
        gameBoard.style.gridTemplateRows = `repeat(${BOARD_SIZE}, ${CELL_SIZE}px)`;
        gameBoard.style.width = `${BOARD_SIZE * CELL_SIZE}px`;
        gameBoard.style.height = `${BOARD_SIZE * CELL_SIZE}px`;

        // --- æ¸¸æˆåˆå§‹åŒ– ---
        function initGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            snake = [];
            food = {};
            direction = { x: 1, y: 0 }; // åˆå§‹å‘å³ç§»åŠ¨
            score = 0;
            isGameOver = false;
            gameStarted = false;
            changingDirection = false; // é‡ç½®æ–¹å‘æ”¹å˜æ ‡å¿—
            gameMessage.textContent = '';
            gameMessage.className = '';
            scoreDisplay.textContent = 'åˆ†æ•°: 0';
            startButton.textContent = 'å¼€å§‹æ¸¸æˆ';
            startButton.disabled = false; // å¯ç”¨å¼€å§‹æŒ‰é’®

            clearInterval(gameInterval); // æ¸…é™¤ä»»ä½•ç°æœ‰çš„æ¸¸æˆå¾ªç¯

            // åˆ›å»ºåˆå§‹è›‡çš„ä½ç½®
            // ç¡®ä¿è›‡å¤´å’Œèº«ä½“ä¸ä¼šç«‹å³é‡å 
            for (let i = 0; i < INITIAL_SNAKE_LENGTH; i++) {
                // åˆå§‹è›‡å‘å³ï¼Œæ‰€ä»¥èº«ä½“èŠ‚æ®µåœ¨è›‡å¤´å·¦è¾¹
                snake.push({ x: Math.floor(BOARD_SIZE / 2) - i, y: Math.floor(BOARD_SIZE / 2) });
            }

            generateFood(); // ç”Ÿæˆç¬¬ä¸€ä¸ªé£Ÿç‰©
            drawGame(); // ç»˜åˆ¶åˆå§‹æ¸¸æˆæ¿
        }

        // --- ç»˜åˆ¶æ¸¸æˆå…ƒç´  ---
        function drawGame() {
            gameBoard.innerHTML = ''; // æ¸…ç©ºæ¸¸æˆæ¿

            // ç»˜åˆ¶è›‡
            snake.forEach((segment, index) => {
                const snakeElement = document.createElement('div');
                snakeElement.style.gridColumnStart = segment.x + 1; // CSS Grid æ˜¯ä» 1 å¼€å§‹è®¡æ•°
                snakeElement.style.gridRowStart = segment.y + 1;
                snakeElement.classList.add('grid-cell', 'snake-body');
                if (index === 0) { // è›‡å¤´
                    snakeElement.classList.add('snake-head');
                }
                gameBoard.appendChild(snakeElement);
            });

            // ç»˜åˆ¶é£Ÿç‰©
            const foodElement = document.createElement('div');
            foodElement.style.gridColumnStart = food.x + 1;
            foodElement.style.gridRowStart = food.y + 1;
            foodElement.classList.add('grid-cell', 'food');
            gameBoard.appendChild(foodElement);
        }

        // --- ç”Ÿæˆé£Ÿç‰© ---
        function generateFood() {
            let newFoodX, newFoodY;
            let collisionWithSnake;

            do {
                newFoodX = Math.floor(Math.random() * BOARD_SIZE);
                newFoodY = Math.floor(Math.random() * BOARD_SIZE);
                // ç¡®ä¿é£Ÿç‰©ä¸ä¼šç”Ÿæˆåœ¨è›‡çš„èº«ä½“ä¸Š
                collisionWithSnake = snake.some(segment => segment.x === newFoodX && segment.y === newFoodY);
            } while (collisionWithSnake);

            food = { x: newFoodX, y: newFoodY };
        }

        // --- æ›´æ–°æ¸¸æˆçŠ¶æ€ (æ¯å¸§è°ƒç”¨) ---
        function updateGame() {
            if (isGameOver) return;

            changingDirection = false; // å…è®¸åœ¨ä¸‹ä¸€å¸§æ”¹å˜æ–¹å‘

            // è®¡ç®—æ–°çš„è›‡å¤´ä½ç½®
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // æ£€æŸ¥ç¢°æ’ (å¢™å£æˆ–è‡ªèº«)
            if (
                head.x < 0 || head.x >= BOARD_SIZE || // æ’å¢™ (å·¦å³)
                head.y < 0 || head.y >= BOARD_SIZE || // æ’å¢™ (ä¸Šä¸‹)
                checkSelfCollision(head) // æ’åˆ°è‡ªå·±
            ) {
                gameOver();
                return;
            }

            snake.unshift(head); // å°†æ–°è›‡å¤´æ·»åŠ åˆ°è›‡çš„æ•°ç»„å‰é¢

            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreDisplay.textContent = `åˆ†æ•°: ${score}`;
                generateFood(); // é‡æ–°ç”Ÿæˆé£Ÿç‰©
            } else {
                snake.pop(); // å¦‚æœæ²¡åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤è›‡å°¾ï¼Œä¿æŒé•¿åº¦ä¸å˜
            }

            drawGame(); // é‡æ–°ç»˜åˆ¶æ¸¸æˆ
        }

        // --- æ£€æŸ¥è›‡å¤´æ˜¯å¦æ’åˆ°è‡ªå·±çš„èº«ä½“ ---
        function checkSelfCollision(head) {
            // ä»è›‡çš„ç¬¬äºŒä¸ªèŠ‚æ®µå¼€å§‹æ£€æŸ¥ï¼Œå› ä¸ºè›‡å¤´ä¸å¯èƒ½ç«‹å³æ’åˆ°è‡ªå·±
            // ä¿®å¤ï¼šå½“è›‡çš„é•¿åº¦å°äºç­‰äºåˆå§‹é•¿åº¦æ—¶ï¼Œä¸æ£€æŸ¥ç¢°æ’ï¼Œé¿å…åˆšå¼€å§‹å°±ç»“æŸ
            if (snake.length <= INITIAL_SNAKE_LENGTH && gameStarted) {
                return false;
            }
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    return true;
                }
            }
            return false;
        }

        // --- æ¸¸æˆç»“æŸå¤„ç† ---
        function gameOver() {
            isGameOver = true;
            clearInterval(gameInterval); // åœæ­¢æ¸¸æˆå¾ªç¯
            gameMessage.textContent = `æ¸¸æˆç»“æŸï¼ä½ çš„åˆ†æ•°æ˜¯ ${score}ã€‚è·å¾—äº† ${GOLD_PER_GAME} é‡‘å¸ï¼`;
            gameMessage.classList.add('message-lose');
            startButton.textContent = 'é‡æ–°å¼€å§‹';
            startButton.disabled = false; // å¯ç”¨é‡æ–°å¼€å§‹æŒ‰é’®
            addGoldToMainGame(GOLD_PER_GAME); // å¥–åŠ±é‡‘å¸
        }

        // --- å¼€å§‹æ¸¸æˆ ---
        function startGame() {
            if (gameStarted) return; // é˜²æ­¢é‡å¤å¼€å§‹
            gameStarted = true;
            isGameOver = false;
            startButton.disabled = true; // æ¸¸æˆè¿›è¡Œæ—¶ç¦ç”¨å¼€å§‹æŒ‰é’®
            gameMessage.textContent = '';
            gameInterval = setInterval(updateGame, GAME_SPEED); // å¯åŠ¨æ¸¸æˆå¾ªç¯
        }

        // --- å¤„ç†é”®ç›˜è¾“å…¥æ”¹å˜æ–¹å‘ ---
        function changeDirection(event) {
            // é˜»æ­¢é¡µé¢æ»šåŠ¨
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                event.preventDefault();
            }

            if (isGameOver || !gameStarted || changingDirection) return; // æ¸¸æˆç»“æŸã€æœªå¼€å§‹æˆ–æ­£åœ¨æ”¹å˜æ–¹å‘æ—¶ä¸å“åº”è¾“å…¥

            const keyPressed = event.key;
            const currentDirection = direction;

            let newDirection = { ...currentDirection }; // å¤åˆ¶å½“å‰æ–¹å‘

            // é˜²æ­¢ç«‹å³åå‘ç§»åŠ¨ (ä¾‹å¦‚ï¼Œå‘å³æ—¶ä¸èƒ½ç«‹å³å‘å·¦)
            if (keyPressed === 'ArrowUp' && currentDirection.y !== 1) {
                newDirection = { x: 0, y: -1 };
            } else if (keyPressed === 'ArrowDown' && currentDirection.y !== -1) {
                newDirection = { x: 0, y: 1 };
            } else if (keyPressed === 'ArrowLeft' && currentDirection.x !== 1) {
                newDirection = { x: -1, y: 0 };
            } else if (keyPressed === 'ArrowRight' && currentDirection.x !== -1) {
                newDirection = { x: 1, y: 0 };
            }

            // åªæœ‰å½“æ–¹å‘ç¡®å®æ”¹å˜æ—¶æ‰æ›´æ–°
            if (newDirection.x !== currentDirection.x || newDirection.y !== currentDirection.y) {
                direction = newDirection;
                changingDirection = true; // è®¾ç½®æ ‡å¿—ï¼Œé˜²æ­¢åœ¨åŒä¸€å¸§å†…å†æ¬¡æ”¹å˜æ–¹å‘
            }
        }

        // --- å¤„ç†è™šæ‹Ÿæ–¹å‘é”®ç‚¹å‡» ---
        function handleVirtualDirection(newDirX, newDirY) {
            if (isGameOver || !gameStarted || changingDirection) return;

            const currentDirection = direction;
            let newDirection = { x: newDirX, y: newDirY };

            // é˜²æ­¢ç«‹å³åå‘ç§»åŠ¨
            if (newDirection.x === -currentDirection.x && newDirection.y === -currentDirection.y) {
                return; // å°è¯•åå‘ç§»åŠ¨ï¼Œå¿½ç•¥
            }

            // åªæœ‰å½“æ–¹å‘ç¡®å®æ”¹å˜æ—¶æ‰æ›´æ–°
            if (newDirection.x !== currentDirection.x || newDirection.y !== currentDirection.y) {
                direction = newDirection;
                changingDirection = true; // è®¾ç½®æ ‡å¿—ï¼Œé˜²æ­¢åœ¨åŒä¸€å¸§å†…å†æ¬¡æ”¹å˜æ–¹å‘
            }
        }


        // --- ä¸ä¸»æ¸¸æˆäº¤äº’ï¼šå¢åŠ é‡‘å¸ (ä¸æ‰«é›·é¡µé¢ç›¸åŒ) ---
        function addGoldToMainGame(amount) {
            const savedState = localStorage.getItem('catGameSaveState');
            if (savedState) {
                try {
                    let cat = JSON.parse(savedState);
                    if (typeof cat.gold === 'undefined') {
                        cat.gold = 0; // å¦‚æœæ²¡æœ‰ gold å±æ€§ï¼Œåˆå§‹åŒ–ä¸º 0
                    }
                    cat.gold += amount;
                    localStorage.setItem('catGameSaveState', JSON.stringify(cat));
                    console.log(`æˆåŠŸä¸ºä¸»æ¸¸æˆå¢åŠ äº† ${amount} é‡‘å¸ã€‚å½“å‰é‡‘å¸: ${cat.gold}`);
                } catch (e) {
                    console.error('è§£æä¸»æ¸¸æˆå­˜æ¡£å¤±è´¥ï¼Œæ— æ³•å¢åŠ é‡‘å¸:', e);
                }
            } else {
                console.warn('æœªæ‰¾åˆ°ä¸»æ¸¸æˆå­˜æ¡£ï¼Œæ— æ³•å¢åŠ é‡‘å¸ã€‚');
            }
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        startButton.addEventListener('click', () => {
            if (isGameOver || !gameStarted) { // å¦‚æœæ¸¸æˆç»“æŸæˆ–æœªå¼€å§‹ï¼Œåˆ™é‡æ–°åˆå§‹åŒ–å¹¶å¼€å§‹
                initGame();
                startGame();
            }
        });
        document.addEventListener('keydown', changeDirection); // ç›‘å¬é”®ç›˜æ–¹å‘é”®

        // è™šæ‹Ÿæ–¹å‘é”®äº‹ä»¶ç›‘å¬
        upButton.addEventListener('click', () => handleVirtualDirection(0, -1));
        downButton.addEventListener('click', () => handleVirtualDirection(0, 1));
        leftButton.addEventListener('click', () => handleVirtualDirection(-1, 0));
        rightButton.addEventListener('click', () => handleVirtualDirection(1, 0));


        // å¸®åŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        helpButton.addEventListener('click', () => {
            helpModal.style.display = 'block';
        });

        // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        closeButton.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // --- é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¸¸æˆ ---
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
