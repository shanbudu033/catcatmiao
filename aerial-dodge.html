<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>空中闪避小游戏</title>
    <style>
        /* 继承主页面的可爱风格 */
        body {
            font-family: 'Comic Sans MS', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fdf3f8; /* 柔和的粉色背景 */
            background-image: url('https://www.transparenttextures.com/patterns/light-honeycomb.png');
            color: #555;
            padding: 20px;
            box-sizing: border-box;
            position: relative; /* 用于定位帮助按钮 */
        }
        h1 {
            color: #ff69b4; /* 可爱的热粉色标题 */
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* 返回游戏中心按钮的样式 */
        .back-button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #98fb98; /* 浅绿色按钮 */
            color: #333;
            border: none;
            border-radius: 15px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(152, 251, 152, 0.3);
            margin-top: 30px; /* 与游戏区域保持距离 */
        }
        .back-button:hover {
            background-color: #66cd66;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 205, 102, 0.4);
        }
        .back-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(102, 90, 205, 0.3);
        }

        /* 游戏容器样式 */
        #game-container {
            background-color: #ffffff;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(255, 192, 203, 0.3);
            padding: 30px;
            text-align: center;
            max-width: 500px; /* 适应游戏板大小 */
            width: 90%;
            margin-bottom: 20px;
            border: 2px solid #ffe4e1;
            position: relative; /* 用于定位帮助按钮 */
        }

        /* 游戏信息显示 */
        #game-info {
            display: flex;
            justify-content: space-between;
            font-size: 1.5em;
            font-weight: bold;
            color: #ff69b4; /* 可爱的粉色 */
            margin-bottom: 15px;
            background-color: #fff0f5;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid #ffebf0;
        }
        #game-info span {
            flex: 1;
            text-align: center;
        }
        #game-info span:first-child { text-align: left; }
        #game-info span:last-child { text-align: right; }


        /* Canvas 样式 */
        #gameCanvas {
            background-color: #87ceeb; /* 天蓝色背景 */
            border: 2px solid #ccc;
            margin: 20px auto;
            display: block; /* 移除 canvas 默认的 inline 间距 */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); /* 内部阴影 */
            border-radius: 5px;
            max-width: 100%; /* 确保在小屏幕上不会溢出 */
            height: auto; /* 高度自适应 */
        }

        /* 游戏消息样式 */
        #game-message {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
            color: #ff69b4;
            min-height: 1.5em; /* 确保消息区域高度稳定 */
        }
        .message-win { color: #008000; } /* 胜利消息绿色 */
        .message-lose { color: #ff0000; } /* 失败消息红色 */

        /* 开始/重新开始按钮样式 */
        #startButton {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #87ceeb; /* 天蓝色 */
            color: white;
            border: none;
            border-radius: 15px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 15px rgba(135, 206, 235, 0.3);
        }
        #startButton:hover {
            background-color: #6a5acd;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 90, 205, 0.4);
        }
        #startButton:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(106, 90, 205, 0.3);
        }

        /* 帮助按钮样式 (与扫雷页面相同) */
        #helpButton {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffebcd; /* 杏仁色 */
            color: #d2691e; /* 巧克力色 */
            border: 2px solid #deb887; /* 沙棕色 */
            font-size: 1.8em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s, transform 0.2s;
            z-index: 10; /* 确保在其他元素之上 */
        }
        #helpButton:hover {
            background-color: #ffe4b5;
            transform: scale(1.05);
        }

        /* 帮助卡片（模态框）样式 (与扫雷页面相同) */
        #helpModal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 100; /* 确保在最上层 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* 半透明黑色背景 */
            backdrop-filter: blur(5px); /* 模糊背景 */
            -webkit-backdrop-filter: blur(5px); /* Safari 兼容 */
            padding-top: 60px;
        }

        .help-modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 居中显示 */
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255, 192, 203, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out; /* 弹出动画 */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-modal-content h2 {
            color: #ff69b4;
            margin-top: 0;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .help-modal-content p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: left;
        }

        .help-modal-content ul {
            text-align: left;
            margin-bottom: 20px;
            padding-left: 25px;
        }
        .help-modal-content ul li {
            margin-bottom: 8px;
            font-size: 1.05em;
            color: #666;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff69b4;
            text-decoration: none;
            cursor: pointer;
        }

        /* 虚拟方向键容器 (针对左右移动) */
        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            /* 默认隐藏，只在小屏幕显示 */
            display: none;
        }

        .control-button {
            width: 80px;
            height: 80px;
            background-color: #ffb6c1; /* 浅粉色 */
            color: white;
            border: none;
            border-radius: 50%; /* 圆形按钮 */
            font-size: 2.5em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(255, 182, 193, 0.4);
            transition: background-color 0.2s, transform 0.1s;
            user-select: none; /* 防止文本被选中 */
            -webkit-tap-highlight-color: transparent; /* 移除移动端点击高亮 */
        }
        .control-button:hover {
            background-color: #ff69b4;
            transform: translateY(-2px);
        }
        .control-button:active {
            background-color: #e05090;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(255, 182, 193, 0.4);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            #game-container {
                padding: 20px;
                width: 95%; /* 适应更小的屏幕 */
            }
            /* 在小屏幕上显示虚拟方向键 */
            #controls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <h1>空中闪避小游戏</h1>
    <div id="game-container">
        <!-- 帮助按钮 -->
        <button id="helpButton">?</button>

        <div id="game-info">
            <span id="score-display">存活时间: 0s</span>
            <span id="lives-display">生命: 3</span>
        </div>
        <canvas id="gameCanvas" width="400" height="500"></canvas>
        <p id="game-message"></p>
        <button id="startButton">开始游戏</button>

        <!-- 虚拟方向键 -->
        <div id="controls">
            <button id="left-button" class="control-button">←</button>
            <button id="right-button" class="control-button">→</button>
        </div>
    </div>
    <button onclick="window.location.href='game.html'" class="back-button">返回游戏中心</button>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="modal">
        <div class="help-modal-content">
            <span class="close-button">&times;</span>
            <h2>空中闪避玩法说明</h2>
            <p>控制你的小飞机左右移动，躲避从天而降的炮弹，尽可能长时间地存活下来！</p>
            <ul>
                <li><strong>目标：</strong> 存活 <strong>30 秒</strong> 即可获胜并获得金币奖励！</li>
                <li><strong>控制你的飞机：</strong>
                    <ul>
                        <li><strong>桌面端：</strong> 使用键盘的 <strong>← (左)</strong> 和 <strong>→ (右)</strong> 方向键，或者 <strong>A (左)</strong> 和 <strong>D (右)</strong> 键来移动你的飞机。</li>
                        <li><strong>手机端：：</strong> 使用屏幕下方的 <strong>← (左)</strong> 和 <strong>→ (右)</strong> 虚拟按钮来移动你的飞机。</li>
                    </ul>
                </li>
                <li><strong>躲避炮弹：：</strong> 炮弹会从屏幕上方随机落下，碰到飞机将失去一条生命。</li>
                <li><strong>生命值：：</strong> 你有 <strong>3 条生命</strong>。失去所有生命则游戏结束。</li>
                <li><strong>难度递增：：</strong> 随着存活时间的增加，炮弹会下落得更快，出现得更频繁，甚至会同时出现更多炮弹，挑战你的反应极限！</li>
            </ul>
            <p>祝你好运，成为闪避大师！</p>
        </div>
    </div>

    <script>
        // --- 游戏配置 ---
        const CANVAS_WIDTH = 400;
        const CANVAS_HEIGHT = 500;
        const PLAYER_WIDTH = 40; // 飞机碰撞箱宽度
        const PLAYER_HEIGHT = 40; // 飞机碰撞箱高度
        const PLAYER_SPEED = 5;
        const INITIAL_LIVES = 3;
        const BULLET_SIZE = 20; // 炮弹大小，稍微大一点更容易看到和碰撞
        const WIN_TIME_SECONDS = 30; // 存活达到此时间视为胜利
        const GOLD_REWARD = 40; // 获胜奖励金币数量
        const GAME_FPS = 60; // 游戏帧率

        // 难度设置 (timeThreshold 是游戏进行到多少秒时切换到此难度)
        const DIFFICULTY_SETTINGS = [
            {
                level: 0,
                timeThreshold: 0, // 游戏开始时
                bulletSpeed: 2, // 炮弹初始下落速度
                bulletSpawnInterval: 1200, // 炮弹生成间隔 (ms)
                maxSimultaneousBullets: 1 // 最多同时生成炮弹数量
            },
            {
                level: 1,
                timeThreshold: 10, // 游戏进行10秒后
                bulletSpeed: 3,
                bulletSpawnInterval: 800,
                maxSimultaneousBullets: 2
            },
            {
                level: 2,
                timeThreshold: 20, // 游戏进行20秒后
                bulletSpeed: 4,
                bulletSpawnInterval: 600,
                maxSimultaneousBullets: 3
            },
            {
                level: 3,
                timeThreshold: 30, // 游戏进行30秒后 (如果能活到这里，难度会更高)
                bulletSpeed: 5,
                bulletSpawnInterval: 400,
                maxSimultaneousBullets: 4
            }
            // 可以根据需要添加更多难度级别
        ];

        // --- DOM 元素 ---
        const gameCanvas = document.getElementById('gameCanvas');
        const ctx = gameCanvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const livesDisplay = document.getElementById('lives-display');
        const gameMessage = document.getElementById('game-message');
        const startButton = document.getElementById('startButton');
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeButton = document.querySelector('.close-button');

        // 虚拟方向键
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');

        // --- 游戏状态变量 ---
        let player = {};
        let bullets = [];
        let lives = INITIAL_LIVES;
        let score = 0; // 存活时间 (秒)
        let gameInterval; // 主游戏循环
        let bulletSpawnIntervalId; // 炮弹生成循环
        let isGameOver = false;
        let gameStarted = false; // 标记游戏是否正在进行
        let rightPressed = false;
        let leftPressed = false;
        let gameStartTime = 0; // 游戏开始时间戳
        let currentDifficulty = DIFFICULTY_SETTINGS[0]; // 当前难度级别

        // --- 游戏初始化 (重置所有状态，但不启动游戏) ---
        function initGame() {
            lives = INITIAL_LIVES;
            score = 0;
            isGameOver = false;
            // gameStarted 不在这里设置，由 startGame 负责
            bullets = [];
            gameStartTime = 0;
            currentDifficulty = DIFFICULTY_SETTINGS[0];

            gameMessage.textContent = '';
            gameMessage.className = '';
            scoreDisplay.textContent = `存活时间: ${score}s`;
            livesDisplay.textContent = `生命: ${lives}`;
            startButton.textContent = '开始游戏';
            startButton.disabled = false;

            clearInterval(gameInterval);
            clearInterval(bulletSpawnIntervalId);

            // 初始化玩家飞机位置
            player = {
                x: (CANVAS_WIDTH - PLAYER_WIDTH) / 2,
                y: CANVAS_HEIGHT - PLAYER_HEIGHT - 20, // 底部留一点空间
                width: PLAYER_WIDTH,
                height: PLAYER_HEIGHT
            };

            // 重置控制状态
            rightPressed = false;
            leftPressed = false;

            draw(); // 绘制初始游戏板
        }

        // --- 绘制游戏元素 ---
        function draw() {
            // 清空画布
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            drawPlayer(); // 绘制飞机
            drawBullets(); // 绘制炮弹
        }

        // 绘制飞机 (使用 emoji)
        function drawPlayer() {
            ctx.font = '30px Arial'; // 调整字体大小以适应飞机碰撞箱
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('✈️', player.x + player.width / 2, player.y + player.height / 2);

            // // 调试用：绘制飞机碰撞箱
            // ctx.strokeStyle = 'red';
            // ctx.strokeRect(player.x, player.y, player.width, player.height);
        }

        // 绘制炮弹
        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.size / 2, 0, Math.PI * 2);
                ctx.fillStyle = '#ff0000'; // 红色炮弹
                ctx.fill();
                ctx.closePath();

                // // 调试用：绘制炮弹碰撞箱
                // ctx.strokeStyle = 'green';
                // ctx.strokeRect(bullet.x - bullet.size / 2, bullet.y - bullet.size / 2, bullet.size, bullet.size);
            });
        }

        // --- 碰撞检测 (AABB) ---
        function checkCollision(obj1, obj2) {
            // obj1 和 obj2 都应该是 {x, y, width, height} 格式的矩形
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }

        // --- 更新游戏状态 (每帧调用) ---
        function update() {
            if (isGameOver || !gameStarted) return; // 确保游戏正在进行才更新

            const currentTime = Date.now();
            const elapsedTimeSeconds = Math.floor((currentTime - gameStartTime) / 1000);

            // 更新分数
            score = elapsedTimeSeconds;
            scoreDisplay.textContent = `存活时间: ${score}s`;

            // 更新难度级别
            let newDifficulty = currentDifficulty;
            for (let i = DIFFICULTY_SETTINGS.length - 1; i >= 0; i--) {
                if (elapsedTimeSeconds >= DIFFICULTY_SETTINGS[i].timeThreshold) {
                    newDifficulty = DIFFICULTY_SETTINGS[i];
                    break;
                }
            }
            if (newDifficulty !== currentDifficulty) {
                currentDifficulty = newDifficulty;
                // console.log(`Difficulty changed to level ${currentDifficulty.level} at ${elapsedTimeSeconds}s`); // 调试用
                // 重新设置炮弹生成间隔，确保难度变化立即生效
                clearInterval(bulletSpawnIntervalId);
                bulletSpawnIntervalId = setInterval(spawnBullet, currentDifficulty.bulletSpawnInterval);
            }


            // 移动飞机
            if (rightPressed && player.x < CANVAS_WIDTH - player.width) {
                player.x += PLAYER_SPEED;
            } else if (leftPressed && player.x > 0) {
                player.x -= PLAYER_SPEED;
            }

            // 移动炮弹并检测碰撞
            for (let i = bullets.length - 1; i >= 0; i--) {
                let bullet = bullets[i];
                bullet.y += currentDifficulty.bulletSpeed; // 使用当前难度下的炮弹速度

                // 炮弹与飞机碰撞
                // 注意：bullet.x, bullet.y 是圆心，需要转换为矩形左上角坐标进行 AABB 碰撞检测
                const bulletRect = {
                    x: bullet.x - bullet.size / 2,
                    y: bullet.y - bullet.size / 2,
                    width: bullet.size,
                    height: bullet.size
                };

                if (checkCollision(player, bulletRect)) {
                    lives--;
                    livesDisplay.textContent = `生命: ${lives}`;
                    bullets.splice(i, 1); // 移除碰撞的炮弹
                    if (lives <= 0) { // 生命值可能为负，所以用 <= 0
                        gameOver(false); // 失去所有生命，游戏失败
                    }
                }

                // 炮弹超出屏幕底部
                if (bullet.y - bullet.size / 2 > CANVAS_HEIGHT) {
                    bullets.splice(i, 1); // 移除超出屏幕的炮弹
                }
            }

            // 检查是否胜利
            if (score >= WIN_TIME_SECONDS && !isGameOver) {
                gameOver(true);
            }

            draw(); // 重新绘制游戏
        }

        // --- 生成炮弹 ---
        function spawnBullet() {
            if (isGameOver || !gameStarted) return; // 确保游戏正在进行才生成炮弹

            // 根据当前难度生成多个炮弹
            for (let i = 0; i < currentDifficulty.maxSimultaneousBullets; i++) {
                // 确保炮弹不会生成在飞机正上方，给玩家一点反应时间
                let bulletX;
                // 定义一个飞机上方的“安全区”，炮弹不应直接生成在此区域
                // 这里的安全区是基于飞机当前位置的，稍微扩大一点
                const safeZoneLeft = player.x - BULLET_SIZE * 1.5;
                const safeZoneRight = player.x + player.width + BULLET_SIZE * 1.5;

                let attempts = 0;
                do {
                    bulletX = Math.random() * (CANVAS_WIDTH - BULLET_SIZE) + BULLET_SIZE / 2;
                    attempts++;
                    if (attempts > 50) { // 尝试50次，如果还找不到安全位置就随便生成，防止死循环
                        break;
                    }
                } while (bulletX > safeZoneLeft && bulletX < safeZoneRight);


                bullets.push({
                    x: bulletX,
                    y: -BULLET_SIZE / 2, // 从屏幕上方外一点开始
                    size: BULLET_SIZE
                });
            }
        }

        // --- 游戏结束处理 ---
        function gameOver(isPlayerWin) {
            isGameOver = true;
            gameStarted = false; // 游戏结束，将 gameStarted 设为 false
            clearInterval(gameInterval); // 停止主游戏循环
            clearInterval(bulletSpawnIntervalId); // 停止炮弹生成循环

            // 重置控制状态，防止飞机在游戏结束后继续移动
            rightPressed = false;
            leftPressed = false;

            if (isPlayerWin) {
                gameMessage.textContent = `恭喜你，存活了 ${score} 秒，你赢了！获得了 ${GOLD_REWARD} 金币！`;
                gameMessage.classList.add('message-win');
                addGoldToMainGame(GOLD_REWARD); // 奖励金币
            } else {
                gameMessage.textContent = `很遗憾，你被击中了！存活了 ${score} 秒。`;
                gameMessage.classList.add('message-lose');
            }
            startButton.textContent = '重新开始';
            startButton.disabled = false; // 启用重新开始按钮
        }

        // --- 开始游戏 ---
        function startGame() {
            if (gameStarted) return; // 如果游戏已经在进行，则不重复开始

            // 1. 重置所有游戏状态到初始值
            initGame();

            // 2. 真正启动游戏
            gameStarted = true; // 标记游戏正在进行
            isGameOver = false; // 确保游戏不是结束状态
            startButton.disabled = true; // 游戏进行时禁用开始按钮
            startButton.textContent = '游戏中...'; // 按钮文本提示
            gameMessage.textContent = ''; // 清空消息

            gameStartTime = Date.now(); // 记录游戏开始时间

            // 启动主游戏循环
            gameInterval = setInterval(update, 1000 / GAME_FPS);

            // 启动炮弹生成循环 (使用初始难度设置)
            bulletSpawnIntervalId = setInterval(spawnBullet, currentDifficulty.bulletSpawnInterval);
        }

        // --- 处理键盘输入 ---
        function handleKeyDown(event) {
            // 阻止页面滚动
            if (['ArrowLeft', 'ArrowRight', 'a', 'd'].includes(event.key.toLowerCase())) {
                event.preventDefault();
            }

            if (isGameOver || !gameStarted) return; // 只有游戏进行中才响应控制

            if (event.key === 'ArrowRight' || event.key.toLowerCase() === 'd') {
                rightPressed = true;
            } else if (event.key === 'ArrowLeft' || event.key.toLowerCase() === 'a') {
                leftPressed = true;
            }
        }

        function handleKeyUp(event) {
            if (isGameOver || !gameStarted) return; // 只有游戏进行中才响应控制

            if (event.key === 'ArrowRight' || event.key.toLowerCase() === 'd') {
                rightPressed = false;
            } else if (event.key === 'ArrowLeft' || event.key.toLowerCase() === 'a') {
                leftPressed = false;
            }
        }

        // --- 处理虚拟方向键点击 ---
        function handleVirtualButtonPress(direction) {
            if (isGameOver || !gameStarted) return; // 只有游戏进行中才响应控制

            if (direction === 'left') {
                leftPressed = true;
                rightPressed = false; // 确保只有一个方向被激活
            } else if (direction === 'right') {
                rightPressed = true;
                leftPressed = false; // 确保只有一个方向被激活
            }
        }

        function handleVirtualButtonRelease() {
            leftPressed = false;
            rightPressed = false;
        }

        // --- 与主游戏交互：增加金币 (与扫雷页面相同) ---
        function addGoldToMainGame(amount) {
            const savedState = localStorage.getItem('catGameSaveState');
            if (savedState) {
                try {
                    let cat = JSON.parse(savedState);
                    if (typeof cat.gold === 'undefined') {
                        cat.gold = 0; // 如果没有 gold 属性，初始化为 0
                    }
                    cat.gold += amount;
                    localStorage.setItem('catGameSaveState', JSON.stringify(cat));
                    console.log(`成功为主游戏增加了 ${amount} 金币。当前金币: ${cat.gold}`);
                } catch (e) {
                    console.error('解析主游戏存档失败，无法增加金币:', e);
                }
            } else {
                console.warn('未找到主游戏存档，无法增加金币。');
            }
        }

        // --- 事件监听器 ---
        startButton.addEventListener('click', () => {
            // 无论当前是“开始游戏”还是“重新开始”，都调用 startGame
            // startGame 内部会处理重置和启动逻辑
            startGame();
        });
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);

        // 虚拟方向键事件监听 (使用 touchstart/touchend 和 mousedown/mouseup)
        leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleVirtualButtonPress('left'); }, { passive: false });
        leftButton.addEventListener('touchend', handleVirtualButtonRelease);
        leftButton.addEventListener('mousedown', () => handleVirtualButtonPress('left'));
        leftButton.addEventListener('mouseup', handleVirtualButtonRelease);
        leftButton.addEventListener('mouseleave', handleVirtualButtonRelease); // 鼠标移出按钮也停止

        rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleVirtualButtonPress('right'); }, { passive: false });
        rightButton.addEventListener('touchend', handleVirtualButtonRelease);
        rightButton.addEventListener('mousedown', () => handleVirtualButtonPress('right'));
        rightButton.addEventListener('mouseup', handleVirtualButtonRelease);
        rightButton.addEventListener('mouseleave', handleVirtualButtonRelease); // 鼠标移出按钮也停止


        // 帮助按钮点击事件
        helpButton.addEventListener('click', () => {
            helpModal.style.display = 'block';
        });

        // 关闭按钮点击事件
        closeButton.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });

        // 点击模态框外部关闭
        window.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });

        // --- 页面加载时初始化游戏 ---
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
